<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¿ íŒ¡ ê´‘ê³  ë¶„ì„ê¸° | í‚¤ì›Œë“œ ROAS ë¶„ì„ ë° ì œì™¸ í‚¤ì›Œë“œ ì¶”ì²œ - ë§ˆì¼€íŒ…ê´‘ì¥</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="ì¿ íŒ¡ê´‘ê³ ë¶„ì„,ì¿ íŒ¡ê´‘ê³ ,ì¿ íŒ¡í‚¤ì›Œë“œ,ROASë¶„ì„,ì¿ íŒ¡ì œì™¸í‚¤ì›Œë“œ,ì¿ íŒ¡ë§¤ì¶œìµœì í™”ê´‘ê³ ,ì¿ íŒ¡ê´‘ê³ ì„¤ì •,ì¿ íŒ¡ë§ˆì¼€íŒ…">
    <meta name="keywords" content="ì¿ íŒ¡ê´‘ê³ ,ì¿ íŒ¡í‚¤ì›Œë“œ,ì¿ íŒ¡ROAS,ì œì™¸í‚¤ì›Œë“œ,ì¿ íŒ¡ì…€ëŸ¬,ê´‘ê³ ë¶„ì„,ë¡œì¼“ê·¸ë¡œìŠ¤,ì¿ íŒ¡ìœ™ê´‘ê³ ,ì¿ íŒ¡ë§ˆì¼€íŒ…">
    <meta name="author" content="ë§ˆì¼€íŒ…ê´‘ì¥">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://dashboard.mbizsquare.com/ad-dashboard/coupang">

    <!-- Site Verification -->
    <meta name="naver-site-verification" content="cc6eb66db82f1cef83861f978e49ca76d7a72caa">
    <meta name="google-site-verification" content="i3kI5uL7O6tmcojS0WVBql-E5TUPPR1TkZt8Lwe5zyw">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="ì¿ íŒ¡ ê´‘ê³  ë¶„ì„ê¸° | í‚¤ì›Œë“œ ROAS ë¶„ì„ ë° ì œì™¸ í‚¤ì›Œë“œ ì¶”ì²œ">
    <meta property="og:description" content="ì¿ íŒ¡ ê´‘ê³  í‚¤ì›Œë“œ ROAS ë¶„ì„. ì œì™¸í‚¤ì›Œë“œ ìë™ì¶”ì²œìœ¼ë¡œ ê´‘ê³ ë¹„ ì ˆê°.">
    <meta property="og:url" content="https://dashboard.mbizsquare.com/ad-dashboard/coupang">
    <meta property="og:site_name" content="ë§ˆì¼€íŒ…ê´‘ì¥">
    <meta property="og:locale" content="ko_KR">
    <meta property="og:image" content="https://dashboard.mbizsquare.com/static/img/og-image.svg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ì¿ íŒ¡ ê´‘ê³  ë¶„ì„ê¸° | í‚¤ì›Œë“œ ROAS ë¶„ì„ ë° ì œì™¸ í‚¤ì›Œë“œ ì¶”ì²œ">
    <meta name="twitter:description" content="ì¿ íŒ¡ ê´‘ê³  í‚¤ì›Œë“œ ROAS ë¶„ì„. ì œì™¸í‚¤ì›Œë“œ ìë™ì¶”ì²œìœ¼ë¡œ ê´‘ê³ ë¹„ ì ˆê°.">
    <meta name="twitter:image" content="https://dashboard.mbizsquare.com/static/img/og-image.svg">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "ì¿ íŒ¡ ê´‘ê³  ë¶„ì„ê¸°",
        "url": "https://dashboard.mbizsquare.com/ad-dashboard/coupang",
        "description": "ì¿ íŒ¡ ê´‘ê³  í‚¤ì›Œë“œ ROAS ë¶„ì„. ì œì™¸í‚¤ì›Œë“œ ìë™ì¶”ì²œìœ¼ë¡œ ê´‘ê³ ë¹„ ì ˆê°.",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Web",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "KRW"
        }
    }
    </script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg">
    <link rel="apple-touch-icon" href="/static/img/favicon.svg">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

    <!-- XLSX for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Header CSS -->
    <link rel="stylesheet" href="/static/css/header.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/ad-banner.css">

    <style>
        /* ========================================
           Looker Studio Style - Professional Design
           ======================================== */

        :root {
            /* Looker Studio Color Palette */
            --primary-blue: #1a73e8;
            --primary-blue-dark: #1557b0;
            --secondary-blue: #4285f4;
            --accent-green: #0f9d58;
            --accent-orange: #f9ab00;
            --accent-red: #ea4335;
            --coupang-red: #e43e2b;
            --coupang-red-dark: #c42d1f;

            /* Neutral Colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-hover: #f1f3f4;
            --border-color: #dadce0;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --text-tertiary: #80868b;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            --shadow-md: 0 1px 3px 0 rgba(60,64,67,.3), 0 4px 8px 3px rgba(60,64,67,.15);
            --shadow-lg: 0 2px 6px 2px rgba(60,64,67,.3), 0 8px 16px 4px rgba(60,64,67,.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
        }

        /* ========================================
           Layout
           ======================================== */

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content - sidebar.cssì—ì„œ ê¸°ë³¸ ì •ì˜ë¨ */
        /* ì¶”ê°€ ìŠ¤íƒ€ì¼ë§Œ ì •ì˜ */

        /* Page Header */
        .page-header {
            background: white;
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1a73e8;
            margin-bottom: 6px;
        }

        .page-header-left p {
            color: #5f6368;
            font-size: 14px;
        }

        .page-header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .header-link {
            padding: 10px 20px;
            background: #f1f3f4;
            color: #5f6368;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .header-link:hover {
            background: #1a73e8;
            color: white;
        }

        /* Top Navigation */
        .top-navigation {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .top-nav-logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .top-nav-tabs {
            display: flex;
            gap: 4px;
        }

        .nav-tab {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: #fce8e6;
            color: var(--coupang-red);
        }

        /* Top Bar */
        .top-bar {
            background: var(--bg-secondary);
            padding: 16px 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .page-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--coupang-red);
            color: white;
        }

        .btn-primary:hover {
            background: var(--coupang-red-dark);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            padding: 20px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Filter Section */
        .filter-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-input {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            width: 100px;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .summary-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .summary-card.highlight-green {
            border-left-color: var(--accent-green);
        }

        .summary-card.highlight-blue {
            border-left-color: var(--primary-blue);
        }

        .summary-card.highlight-red {
            border-left-color: var(--coupang-red);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .summary-unit {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg-hover);
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        tr:hover {
            background: var(--bg-hover);
        }

        /* í‚¤ì›Œë“œ ì»¬ëŸ¼ ê³ ì • ë„ˆë¹„ */
        .keyword-cell {
            width: 405px;
            max-width: 405px;
            min-width: 270px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
        }

        .keyword-cell:hover {
            background-color: #f0f7ff;
        }

        /* í…Œì´ë¸” ê³ ì • ë ˆì´ì•„ì›ƒ */
        #keywordTable,
        #recommendationTable {
            table-layout: auto;
        }

        /* ROAS Highlighting */
        .roas-excellent {
            background: #e8f5e9 !important;
            color: #2e7d32;
            font-weight: 600;
        }

        .roas-good {
            background: #fff9e6 !important;
            color: #f57f17;
        }

        .roas-poor {
            background: #fee !important;
            color: #c62828;
            font-weight: 600;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--coupang-red);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* ========================================
           Enhanced Loading Overlay
           ======================================== */

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .spinner-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-blue);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .spinner-ring {
            border: 4px solid transparent;
            border-top: 4px solid var(--secondary-blue);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .loading-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue));
            width: 0%;
            transition: width 0.3s ease;
            background-size: 200% 100%;
            animation: progress-shimmer 1.5s infinite;
        }

        @keyframes progress-shimmer {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }

        .loading-step {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        /* Table Controls */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            width: 300px;
        }

        /* Recommendation Section */
        .priority-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .priority-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .priority-tab:hover {
            color: var(--primary);
            background: var(--bg-hover);
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .priority-critical {
            background: #fee;
            color: #c00;
            font-weight: 700;
        }

        .priority-high {
            background: #fff3e0;
            color: #e65100;
        }

        .priority-medium {
            background: #ffeaa7;
            color: #d63031;
        }

        .priority-low {
            background: #dfe6e9;
            color: #636e72;
        }

        .priority-none {
            background: #f5f5f5;
            color: #999;
        }

        .text-danger {
            color: #ea4335;
            font-weight: 600;
        }

        .rec-checkbox {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        /* Tablet Responsive (1024px ì´í•˜) */
        @media (max-width: 1024px) {
            /* sidebar, main-contentëŠ” sidebar.cssì—ì„œ ê´€ë¦¬ */

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Mobile Responsive (768px ì´í•˜) */
        @media (max-width: 768px) {
            /* sidebar, main-contentëŠ” sidebar.cssì—ì„œ ê´€ë¦¬ */

            /* ìˆ˜í‰ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
            body {
                overflow-x: hidden;
            }

            .main-content {
                overflow-x: hidden;
            }

            /* Page Header ì„¸ë¡œ ë°°ì¹˜ */
            .page-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 16px;
                padding: 16px !important;
            }

            .page-header-left h1 {
                font-size: 18px !important;
            }

            .page-header-left p {
                font-size: 12px;
            }

            .page-header-right {
                width: 100%;
            }

            .page-header-right .btn {
                width: 100%;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            /* Filter Section ì„¸ë¡œ ë°°ì¹˜ */
            .filter-section {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                padding: 12px !important;
            }

            .filter-group {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 8px !important;
                width: 100%;
            }

            .filter-group .btn {
                width: 100%;
                margin-left: 0 !important;
            }

            .filter-input {
                width: 100% !important;
            }

            .search-box {
                width: 100% !important;
            }

            /* í…Œì´ë¸” ê°€ë¡œ ìŠ¤í¬ë¡¤ - wrapper ì‚¬ìš© */
            .card:has(table) {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* í‚¤ì›Œë“œ í…Œì´ë¸” ìµœì†Œ ë„ˆë¹„ */
            #keywordTable {
                min-width: 800px;
                font-size: 12px;
            }

            #keywordTable th,
            #keywordTable td {
                padding: 8px 6px;
            }

            /* í‚¤ì›Œë“œ ì…€ ê³ ì • ë„ˆë¹„ í•´ì œ */
            .keyword-cell {
                width: auto !important;
                max-width: 120px !important;
                min-width: unset !important;
                font-size: 11px !important;
            }

            /* Summary ì¹´ë“œ 2ì—´ ë°°ì¹˜ */
            .summary-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            .summary-card {
                padding: 12px !important;
            }

            .summary-value {
                font-size: 20px !important;
            }

            .summary-label {
                font-size: 11px !important;
            }

            /* ë²„íŠ¼ ê·¸ë£¹ ì„¸ë¡œ ë°°ì¹˜ */
            .button-group,
            div[style*="display: flex"][style*="gap"] {
                flex-wrap: wrap;
            }

            /* ëª¨ë“  ë²„íŠ¼ í¬ê¸° ì¡°ì • */
            .btn {
                padding: 10px 16px !important;
                font-size: 13px !important;
            }

            /* í…Œì´ë¸” ì»¨íŠ¸ë¡¤ (ê²€ìƒ‰, ìš”ì•½) ì„¸ë¡œ ë°°ì¹˜ */
            .table-controls {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 10px !important;
            }

            /* Section í—¤ë” ì„¸ë¡œ ë°°ì¹˜ */
            .section-header,
            .card-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
            }

            .card-header > div {
                width: 100%;
            }

            .card-header .btn {
                width: 100%;
                justify-content: center;
            }

            /* Priority Tab ê°€ë¡œ ìŠ¤í¬ë¡¤ */
            div[style*="border-bottom: 2px solid"] {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap !important;
                padding-bottom: 8px;
            }

            .priority-tab {
                white-space: nowrap;
                flex-shrink: 0;
                font-size: 11px !important;
                padding: 8px 10px !important;
            }

            /* ì¶”ì²œ í…Œì´ë¸” wrapper */
            .table-wrapper {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
            }

            #recommendationTable {
                min-width: 1200px;
                font-size: 11px;
            }

            #recommendationTable th,
            #recommendationTable td {
                padding: 6px 4px;
                white-space: nowrap;
            }

            /* ì¶”ì²œ ì„¹ì…˜ í—¤ë” */
            #recommendationSection .section-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
            }

            #recommendationSection .section-header > div[style*="display: flex"] {
                flex-direction: column !important;
                width: 100% !important;
                gap: 8px !important;
            }

            #recommendationSection .section-header .btn {
                width: 100% !important;
            }

            /* ì°¨íŠ¸ ë†’ì´ ì¡°ì • */
            .chart-container {
                height: 280px !important;
            }
        }

        /* ë§¤ìš° ì‘ì€ í™”ë©´ (480px ì´í•˜) */
        @media (max-width: 480px) {
            /* top-header paddingì€ header.cssì—ì„œ ê´€ë¦¬ - ì—¬ê¸°ì„œ ë®ì–´ì“°ì§€ ì•ŠìŒ */

            .header-left h1,
            .header-left .logo-text {
                font-size: 14px;
            }

            .card {
                padding: 12px;
            }

            .page-header h1 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" id="mobileToggle" aria-label="ë©”ë‰´ ì—´ê¸°">â˜°</button>

    <!-- Top Header -->
    <header class="top-header">
        <div class="header-left">
            <h1 class="logo-text"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:20px;height:20px;vertical-align:middle;margin-right:6px;filter:brightness(0) invert(1);">ë§ˆì¼€íŒ…ê´‘ì¥ ê´‘ê³ ë¶„ì„</h1>
            <span class="logo-subtitle">ì¿ íŒ¡ê´‘ê³ ë¶„ì„</span>
        </div>
        <div class="header-right">
            <a href="http://pf.kakao.com/_QIxlTK" target="_blank" class="header-btn"><img src="/static/img/icons/guide.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> <span class="btn-text">ì œíœ´ë¬¸ì˜</span></a>
            <a href="https://mbizsquare.com" target="_blank" class="header-btn"><img src="/static/img/icons/dashboard.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> <span class="btn-text">ë°”ë¡œê°€ê¸°</span></a>
            <div class="user-info">
                <span class="user-nickname"><img src="/static/img/icons/calculator.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> {{ g.user.userNicknm }}</span>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>ë©”ë‰´</h2>
        </div>
        <nav class="sidebar-menu">
            <a href="/" class="menu-item">
                <span class="icon"><img src="/static/img/icons/dashboard.svg" alt=""></span>
                <span class="label">ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a href="/guide" class="menu-item">
                <span class="icon"><img src="/static/img/icons/guide.svg" alt=""></span>
                <span class="label">ì´ìš©ì•ˆë‚´</span>
            </a>
            <a href="/ad-dashboard" class="menu-item">
                <span class="icon"><img src="/static/img/icons/chart.svg" alt=""></span>
                <span class="label">ê´‘ê³ ë¶„ì„</span>
            </a>
            <a href="/ad-dashboard/coupang" class="menu-item active">
                <span class="icon"><img src="/static/img/icons/cart.svg" alt=""></span>
                <span class="label">ì¿ íŒ¡ê´‘ê³ ë¶„ì„</span>
            </a>
            <a href="/ad-dashboard/profit-simulator" class="menu-item">
                <span class="icon"><img src="/static/img/icons/calculator.svg" alt=""></span>
                <span class="label">ë§ˆì§„ê³„ì‚°ê¸°</span>
            </a>
            <a href="/ad-dashboard/ad-efficiency" class="menu-item">
                <span class="icon"><img src="/static/img/icons/target.svg" alt=""></span>
                <span class="label">ì†ìµë¶„ê¸° ROAS</span>
            </a>
            <a href="/ad-dashboard/keyword-combiner" class="menu-item">
                <span class="icon"><img src="/static/img/icons/combine.svg" alt=""></span>
                <span class="label">í‚¤ì›Œë“œ ì¡°í•©ê¸°</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-left">
                <h1><img src="/static/img/icons/cart.svg" alt="" style="width:28px;height:28px;vertical-align:middle;margin-right:8px;"> ì¿ íŒ¡ ê´‘ê³  ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
                <p>í‚¤ì›Œë“œë³„ ì„±ê³¼ ë¶„ì„ ë° ROAS ìµœì í™”</p>
            </div>
            <div class="page-header-right">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; background: #1a73e8; color: white; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                    <img src="/static/img/icons/upload.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);">
                    <span>ì¿ íŒ¡ ê´‘ê³  íŒŒì¼ ì—…ë¡œë“œ</span>
                </button>
            </div>
        </div>

        <!-- Hidden File Input -->
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">

        <!-- ê·¸ë¦¬ë“œ ë°°ë„ˆ 2x4 (200x60 x 8ê°œ) -->
        <div id="coupangGridBanners"></div>

        <!-- Filter Section -->
            <div class="filter-section">
                <div class="filter-group">
                    <span class="filter-label"><img src="/static/img/icons/search.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> ROAS í•„í„°:</span>
                    <input type="number" id="roasThreshold" class="filter-input" placeholder="ì˜ˆ: 50" value="">
                    <span class="filter-label">% ì´í•˜</span>
                    <button class="btn btn-secondary" onclick="filterByROAS()">
                        ì ìš©
                    </button>
                    <button class="btn btn-secondary" onclick="resetFilter()">
                        ì´ˆê¸°í™”
                    </button>
                    <button class="btn btn-primary" onclick="getRecommendations()" style="margin-left: 16px;">
                        <img src="/static/img/icons/target.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> ì œì™¸ í‚¤ì›Œë“œ ì¶”ì²œë°›ê¸°
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="padding: 8px 16px;">
                        <img src="/static/img/icons/trash.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid" id="summaryGrid">
                <div class="summary-card highlight-red">
                    <div class="summary-label">ì´ ê´‘ê³ ë¹„</div>
                    <div class="summary-value" id="summarySpend">-</div>
                    <div class="summary-unit">ì›</div>
                </div>
                <div class="summary-card highlight-green">
                    <div class="summary-label">ì´ ë§¤ì¶œì•¡</div>
                    <div class="summary-value" id="summaryRevenue">-</div>
                    <div class="summary-unit">ì›</div>
                </div>
                <div class="summary-card highlight-blue">
                    <div class="summary-label">í‰ê·  ROAS</div>
                    <div class="summary-value" id="summaryROAS">-</div>
                    <div class="summary-unit">%</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ì´ í´ë¦­ìˆ˜</div>
                    <div class="summary-value" id="summaryClicks">-</div>
                    <div class="summary-unit">íšŒ</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">í‰ê·  í´ë¦­ë¥ </div>
                    <div class="summary-value" id="summaryCTR">-</div>
                    <div class="summary-unit">%</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> ROAS TOP 10</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="roasBarChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><img src="/static/img/icons/money.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> ê´‘ê³ ë¹„ vs ë§¤ì¶œì•¡ ë¶„í¬</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="scatterChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ìƒˆë¡œìš´ ì°¨íŠ¸: ë§¤ì¶œì•¡ TOP 10, ê´‘ê³ ë¹„ë‚­ë¹„ TOP 10 -->
            <div class="charts-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><img src="/static/img/icons/money.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> ë§¤ì¶œì•¡ TOP 10 í‚¤ì›Œë“œ</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueTopChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><img src="/static/img/icons/warning.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> ê´‘ê³ ë¹„ë‚­ë¹„ TOP 10 í‚¤ì›Œë“œ</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="wasteTopChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Keyword Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><img src="/static/img/icons/search.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> í‚¤ì›Œë“œ ìƒì„¸ ë¶„ì„</div>
                    <div>
                        <button class="btn btn-secondary" onclick="downloadExcel()">
                            <img src="/static/img/icons/download.svg" alt="" style="width:16px;height:16px;vertical-align:middle;">
                            <span>Excel ë‹¤ìš´ë¡œë“œ</span>
                        </button>
                    </div>
                </div>

                <div class="table-controls">
                    <input
                        type="text"
                        id="searchKeyword"
                        class="search-box"
                        placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰..."
                        onkeyup="searchKeywords()"
                    >
                    <div id="tableSummary" style="font-size: 13px; color: var(--text-secondary);">
                        ì „ì²´ 0ê°œ í‚¤ì›Œë“œ
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table id="keywordTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">í‚¤ì›Œë“œ â†•</th>
                                <th onclick="sortTable(1)">ë…¸ì¶œ ì§€ë©´ â†•</th>
                                <th onclick="sortTable(2)">ë…¸ì¶œìˆ˜ â†•</th>
                                <th onclick="sortTable(3)">í´ë¦­ìˆ˜ â†•</th>
                                <th onclick="sortTable(4)">ê´‘ê³ ë¹„ â†•</th>
                                <th onclick="sortTable(5)">CTR â†•</th>
                                <th onclick="sortTable(6)">ì£¼ë¬¸ìˆ˜ â†•</th>
                                <th onclick="sortTable(7)">íŒë§¤ìˆ˜ëŸ‰ â†•</th>
                                <th onclick="sortTable(8)">ë§¤ì¶œì•¡ â†•</th>
                                <th onclick="sortTable(9)">CPC â†•</th>
                                <th onclick="sortTable(10)">ROAS â†•</th>
                            </tr>
                        </thead>
                        <tbody id="keywordTableBody">
                            <tr>
                                <td colspan="11" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                                    ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Keyword Exclusion Recommendations Section -->
            <div class="section" id="recommendationSection" style="display: none;">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin-bottom: 0;"><img src="/static/img/icons/target.svg" alt="" style="width:20px;height:20px;vertical-align:middle;"> í‚¤ì›Œë“œ ì œì™¸ ì¶”ì²œ</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="exportRecommendations()">
                            <img src="/static/img/icons/download.svg" alt="" style="width:16px;height:16px;vertical-align:middle;">
                            <span>ì¶”ì²œ ëª©ë¡ ë‹¤ìš´ë¡œë“œ</span>
                        </button>
                        <button class="btn btn-danger" onclick="applyExclusions()">
                            <img src="/static/img/icons/trash.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);">
                            <span>ì„ íƒ í‚¤ì›Œë“œ ì œì™¸</span>
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-grid" style="margin-bottom: 24px;">
                    <div class="summary-card highlight-red">
                        <div class="summary-label">ë‚­ë¹„ ê´‘ê³ ë¹„</div>
                        <div class="summary-value" id="recWaste">-</div>
                        <div class="summary-unit">ì›</div>
                    </div>
                    <div class="summary-card highlight-orange">
                        <div class="summary-label">ì œì™¸ ì¶”ì²œ í‚¤ì›Œë“œ</div>
                        <div class="summary-value" id="recCount">-</div>
                        <div class="summary-unit">ê°œ</div>
                    </div>
                    <div class="summary-card highlight-green">
                        <div class="summary-label">ì ˆê° ê°€ëŠ¥ ë¹„ìœ¨</div>
                        <div class="summary-value" id="recSavings">-</div>
                        <div class="summary-unit">%</div>
                    </div>
                </div>

                <!-- Priority Tabs -->
                <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                    <button class="priority-tab active" onclick="filterRecommendations('all')" data-priority="all">
                        ì „ì²´ (<span id="allCount">0</span>)
                    </button>
                    <button class="priority-tab" onclick="filterRecommendations('critical')" data-priority="critical">
                        ğŸ”´ ì¦‰ì‹œì œì™¸ (<span id="criticalCount">0</span>)
                    </button>
                    <button class="priority-tab" onclick="filterRecommendations('high')" data-priority="high">
                        ğŸŸ  ì¡°ì†íˆì œì™¸ (<span id="highCount">0</span>)
                    </button>
                    <button class="priority-tab" onclick="filterRecommendations('medium')" data-priority="medium">
                        ğŸŸ¡ ê²€í† í•„ìš” (<span id="mediumCount">0</span>)
                    </button>
                    <button class="priority-tab" onclick="filterRecommendations('low')" data-priority="low">
                        ğŸŸ¢ ëª¨ë‹ˆí„°ë§ (<span id="lowCount">0</span>)
                    </button>
                </div>

                <!-- Recommendations Table -->
                <div class="table-wrapper">
                    <table id="recommendationTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAllRec" onchange="toggleSelectAll()">
                                </th>
                                <th onclick="sortRecommendations('score')" style="cursor: pointer;">
                                    ì ìˆ˜ <span id="sortScore">â†“</span>
                                </th>
                                <th onclick="sortRecommendations('priority')" style="cursor: pointer;">
                                    ìš°ì„ ìˆœìœ„ <span id="sortPriority">â†•</span>
                                </th>
                                <th onclick="sortRecommendations('keyword')" style="cursor: pointer;">
                                    í‚¤ì›Œë“œ <span id="sortKeyword">â†•</span>
                                </th>
                                <th>ì œì™¸ ì‚¬ìœ </th>
                                <th onclick="sortRecommendations('spend')" style="cursor: pointer;">
                                    ê´‘ê³ ë¹„ <span id="sortSpend">â†•</span>
                                </th>
                                <th onclick="sortRecommendations('revenue')" style="cursor: pointer;">
                                    ë§¤ì¶œ <span id="sortRevenue">â†•</span>
                                </th>
                                <th onclick="sortRecommendations('roas')" style="cursor: pointer;">
                                    ROAS <span id="sortRoas">â†•</span>
                                </th>
                                <th onclick="sortRecommendations('waste')" style="cursor: pointer;">
                                    ë‚­ë¹„ë¹„ìš© <span id="sortWaste">â†•</span>
                                </th>
                                <th onclick="sortRecommendations('waste_rate')" style="cursor: pointer;">
                                    ë‚­ë¹„ìœ¨ <span id="sortWaste_rate">â†•</span>
                                </th>
                                <th onclick="sortRecommendations('opportunity_loss')" style="cursor: pointer;">
                                    ê¸°íšŒë¹„ìš© <span id="sortOpportunity_loss">â†•</span>
                                </th>
                                <th onclick="sortRecommendations('clicks')" style="cursor: pointer;">
                                    í´ë¦­ìˆ˜ <span id="sortClicks">â†•</span>
                                </th>
                                <th onclick="sortRecommendations('ctr')" style="cursor: pointer;">
                                    CTR <span id="sortCtr">â†•</span>
                                </th>
                                <th onclick="sortRecommendations('cpc')" style="cursor: pointer;">
                                    CPC <span id="sortCpc">â†•</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="recommendationTableBody">
                            <tr>
                                <td colspan="14" style="text-align: center; padding: 40px;">
                                    ì¶”ì²œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        <!-- Loading Overlay (Enhanced) -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="loading-content">
                <div class="spinner-wrapper">
                    <div class="spinner"></div>
                    <div class="spinner-ring"></div>
                </div>
                <h3 id="loadingTitle" class="loading-title">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</h3>
                <p id="loadingMessage" class="loading-message">íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <p id="loadingStep" class="loading-step">1/3 ë‹¨ê³„ ì§„í–‰ ì¤‘</p>
            </div>
        </div>

        <!-- Footer -->
        <footer style="background: #f8f9fa; border-top: 1px solid #e0e0e0; padding: 12px 20px; margin-top: 40px; font-size: 11px; color: #888; text-align: center; line-height: 1.6;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <p style="margin: 0 0 4px 0;"><span style="font-weight: 600; color: #555;">ì—ì´ì¹˜ì½”</span> ã…£ ëŒ€í‘œ: ì •ë™í™˜ ã…£ ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 280-26-00396 ã…£ í†µì‹ íŒë§¤ì—…: 2023-ê²½ê¸°í•˜ë‚¨-0304</p>
                <p style="margin: 0 0 4px 0;">ê²½ê¸°ë„ í•˜ë‚¨ì‹œ ì¡°ì •ëŒ€ë¡œ 45, F318 ã…£ ëŒ€í‘œë²ˆí˜¸: 1566-3046 ã…£ E-mail: jdhwan227@naver.com</p>
                <p style="margin: 0; color: #aaa;">Â© 2025 ì—ì´ì¹˜ì½”. All rights reserved.</p>
            </div>
        </footer>
    </main>

    <script>
        /* ========================================
           Global Variables
           ======================================== */

        const COUPANG_STORAGE_KEY = 'coupang_ad_data';
        const COUPANG_DATA_VERSION = '2.0';  // ë°ì´í„° êµ¬ì¡° ë²„ì „ (ì§‘ê³„ ë°ì´í„° í•„ìˆ˜)
        let globalData = [];
        let filteredData = [];
        let currentSortColumn = 9; // Default sort by ROAS
        let currentSortOrder = 'desc';

        /* ========================================
           Loading State Manager
           ======================================== */

        const LoadingState = {
            show(title, message, step = null) {
                const overlay = document.getElementById('loadingOverlay');
                const titleEl = document.getElementById('loadingTitle');
                const messageEl = document.getElementById('loadingMessage');
                const stepEl = document.getElementById('loadingStep');
                const progressBar = document.getElementById('progressBar');

                overlay.classList.remove('hidden');
                titleEl.textContent = title;
                messageEl.textContent = message;

                if (step) {
                    stepEl.textContent = step;
                    stepEl.style.display = 'block';
                } else {
                    stepEl.style.display = 'none';
                }

                // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                progressBar.style.width = '0%';
                setTimeout(() => progressBar.style.width = '30%', 100);
            },

            update(message, progress) {
                const messageEl = document.getElementById('loadingMessage');
                const progressBar = document.getElementById('progressBar');

                messageEl.textContent = message;
                progressBar.style.width = `${progress}%`;
            },

            hide() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('hidden');
            }
        };

        /* ========================================
           Page Initialization
           ======================================== */

        document.addEventListener('DOMContentLoaded', function() {
            // Load saved data
            loadCoupangData();

            // Setup file input
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        });

        /* ========================================
           File Upload
           ======================================== */

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            console.log('=== íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘ ===');
            console.log('íŒŒì¼ëª…:', file.name);
            console.log('íŒŒì¼ í¬ê¸°:', file.size);

            // Show loading with step 1
            LoadingState.show('íŒŒì¼ ì—…ë¡œë“œ ì¤‘', 'íŒŒì¼ì„ ê²€ì¦í•˜ê³  ìˆìŠµë‹ˆë‹¤...', '1/4 ë‹¨ê³„');

            const formData = new FormData();
            formData.append('file', file);

            try {
                console.log('Fetch ìš”ì²­ ì‹œì‘...');

                // Step 2: ì„œë²„ ì—…ë¡œë“œ
                LoadingState.update('ì„œë²„ì— ì—…ë¡œë“œ ì¤‘...', 25);

                const response = await fetch('/api/ad-analysis/upload-coupang', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });

                console.log('ì‘ë‹µ ë°›ìŒ:', response.status, response.statusText);
                console.log('ì‘ë‹µ í—¤ë”:', [...response.headers.entries()]);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);

                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('JSONì´ ì•„ë‹Œ ì‘ë‹µ:', text.substring(0, 200));
                    throw new Error('ì„œë²„ ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
                }

                // Step 3: ë°ì´í„° ì²˜ë¦¬
                LoadingState.update('ë°ì´í„° ì²˜ë¦¬ ì¤‘...', 50);

                const result = await response.json();
                console.log('íŒŒì‹± ì„±ê³µ:', result);

                if (result.success) {
                    // Save data
                    globalData = result.data;
                    filteredData = [...globalData];
                    saveCoupangData(globalData);

                    console.log('ë°ì´í„° ì €ì¥ ì™„ë£Œ:', globalData.length, 'ê°œ');

                    // Step 4: ì°¨íŠ¸ ë Œë”ë§
                    LoadingState.update('ì°¨íŠ¸ ìƒì„± ì¤‘...', 75);

                    // Display results
                    displaySummary(result.summary);
                    displayKeywordTable(filteredData);

                    // ì™„ë£Œ
                    LoadingState.update('ì™„ë£Œ!', 100);

                    // ì§§ì€ ì§€ì—° í›„ ì°¨íŠ¸ í‘œì‹œ ë° ë¡œë”© ìˆ¨ê¹€
                    setTimeout(() => {
                        displayCharts(filteredData);
                        LoadingState.hide();

                        // ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±
                        let message = `âœ… ì—…ë¡œë“œ ì™„ë£Œ!\n\n`;
                        message += `ì´ ${globalData.length}ê°œ í‚¤ì›Œë“œ ë¶„ì„ ì™„ë£Œ (${result.data_type} ë°ì´í„°)\n\n`;
                        message += `ì´ê´‘ê³ ë¹„: ${result.summary['ì´ê´‘ê³ ë¹„'].toLocaleString()}ì›\n`;
                        message += `ì´ë§¤ì¶œì•¡: ${result.summary['ì´ë§¤ì¶œì•¡'].toLocaleString()}ì›\n`;
                        message += `í‰ê·  ROAS: ${result.summary['í‰ê· ROAS']}%`;

                        // ê²½ê³  ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì¶”ê°€
                        if (result.warning) {
                            message += `\n\n${result.warning}`;
                        }

                        alert(message);
                    }, 500);
                } else {
                    alert(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨\n\n${result.error}`);
                }
            } catch (error) {
                console.error('=== ì—…ë¡œë“œ ì˜¤ë¥˜ ìƒì„¸ ===');
                console.error('ì˜¤ë¥˜ íƒ€ì…:', error.name);
                console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
                console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);

                alert(`âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${error.message}\n\n ìƒë‹¨ì˜ ì œíœ´ë¬¸ì˜ë¥¼ í†µí•´ ë¬¸ì˜í•´ì£¼ì„¸ìš”`);
            } finally {
                LoadingState.hide();
                e.target.value = ''; // Reset file input
            }
        }

        /* ========================================
           Data Storage
           ======================================== */

        function saveCoupangData(data) {
            const storageData = {
                version: COUPANG_DATA_VERSION,
                timestamp: Date.now(),
                data: data
            };
            localStorage.setItem(COUPANG_STORAGE_KEY, JSON.stringify(storageData));
            console.log('[Storage] Saved data with version:', COUPANG_DATA_VERSION);
        }

        function loadCoupangData() {
            const stored = localStorage.getItem(COUPANG_STORAGE_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);

                    // ë²„ì „ ì²´í¬
                    if (!parsed.version || parsed.version !== COUPANG_DATA_VERSION) {
                        console.warn('[Storage] Version mismatch or old format. Clearing cache.');
                        console.warn('[Storage] Stored version:', parsed.version, 'Current version:', COUPANG_DATA_VERSION);
                        localStorage.removeItem(COUPANG_STORAGE_KEY);
                        globalData = [];
                        filteredData = [];
                        return;
                    }

                    // ìœ íš¨í•œ ë°ì´í„° ë¡œë“œ
                    globalData = parsed.data || [];
                    filteredData = [...globalData];

                    // Recalculate summary
                    const summary = calculateSummary(globalData);
                    displaySummary(summary);
                    displayKeywordTable(filteredData);
                    displayCharts(filteredData);

                    console.log('[Storage] Loaded data with version:', parsed.version);
                } catch (error) {
                    console.error('[Storage] Failed to parse stored data:', error);
                    localStorage.removeItem(COUPANG_STORAGE_KEY);
                    globalData = [];
                    filteredData = [];
                }
            }
        }

        function calculateSummary(data) {
            if (!data || data.length === 0) {
                return {
                    ì´ê´‘ê³ ë¹„: 0,
                    ì´ë§¤ì¶œì•¡: 0,
                    í‰ê· ROAS: 0,
                    ì´í´ë¦­ìˆ˜: 0,
                    í‰ê· CTR: 0
                };
            }

            const totalSpend = data.reduce((sum, row) => sum + (parseFloat(row.ê´‘ê³ ë¹„) || 0), 0);
            const totalRevenue = data.reduce((sum, row) => sum + (parseFloat(row['ì´ ì „í™˜ë§¤ì¶œì•¡']) || 0), 0);
            const totalClicks = data.reduce((sum, row) => sum + (parseInt(row.í´ë¦­ìˆ˜) || 0), 0);
            const totalImpressions = data.reduce((sum, row) => sum + (parseInt(row.ë…¸ì¶œìˆ˜) || 0), 0);

            // ROAS = (ì´ë§¤ì¶œì•¡ / ì´ê´‘ê³ ë¹„) * 100 (ì •í™•í•œ ê³„ì‚°)
            const avgROAS = totalSpend > 0 ? (totalRevenue / totalSpend) * 100 : 0;
            // CTR = (ì´í´ë¦­ìˆ˜ / ì´ë…¸ì¶œìˆ˜) * 100 (ì •í™•í•œ ê³„ì‚°)
            const avgCTR = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;

            return {
                ì´ê´‘ê³ ë¹„: Math.round(totalSpend),
                ì´ë§¤ì¶œì•¡: Math.round(totalRevenue),
                í‰ê· ROAS: avgROAS.toFixed(2),
                ì´í´ë¦­ìˆ˜: totalClicks,
                í‰ê· CTR: avgCTR.toFixed(2)
            };
        }

        /* ========================================
           Display Functions
           ======================================== */

        function displaySummary(summary) {
            document.getElementById('summarySpend').textContent = formatNumber(summary.ì´ê´‘ê³ ë¹„);
            document.getElementById('summaryRevenue').textContent = formatNumber(summary.ì´ë§¤ì¶œì•¡);
            document.getElementById('summaryROAS').textContent = summary.í‰ê· ROAS;
            document.getElementById('summaryClicks').textContent = formatNumber(summary.ì´í´ë¦­ìˆ˜);
            document.getElementById('summaryCTR').textContent = summary.í‰ê· CTR;
        }

        function displayKeywordTable(data) {
            const tbody = document.getElementById('keywordTableBody');

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                            ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                        </td>
                    </tr>
                `;
                document.getElementById('tableSummary').textContent = 'ì „ì²´ 0ê°œ í‚¤ì›Œë“œ';
                return;
            }

            // Sort data
            const sorted = [...data].sort((a, b) => {
                const colName = getColumnName(currentSortColumn);
                const aVal = a[colName] || 0;
                const bVal = b[colName] || 0;

                if (currentSortOrder === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            tbody.innerHTML = sorted.map(row => {
                const roas = row.ROAS || 0;
                let roasClass = '';
                if (roas >= 150) roasClass = 'roas-excellent';
                else if (roas >= 50) roasClass = 'roas-good';
                else roasClass = 'roas-poor';

                // ë…¸ì¶œ ì§€ë©´ ë°°ì§€ ìƒ‰ìƒ
                const adArea = row['ê´‘ê³  ë…¸ì¶œ ì§€ë©´'] || 'ê²€ìƒ‰ ì˜ì—­';
                let areaBadge = '';
                if (adArea === 'ê²€ìƒ‰ ì˜ì—­') {
                    areaBadge = '<span style="background:#e3f2fd;color:#1976d2;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">ê²€ìƒ‰</span>';
                } else if (adArea === 'ë¹„ê²€ìƒ‰ì˜ì—­ (í†µí•©)' || adArea.includes('ë¹„ê²€ìƒ‰')) {
                    areaBadge = '<span style="background:#fff3e0;color:#e65100;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">ë¹„ê²€ìƒ‰ (í†µí•©)</span>';
                } else if (adArea === 'ë¦¬íƒ€ê²ŸíŒ… (í†µí•©)' || adArea.includes('ë¦¬íƒ€ê²ŸíŒ…')) {
                    areaBadge = '<span style="background:#f3e5f5;color:#7b1fa2;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">ë¦¬íƒ€ê²ŸíŒ… (í†µí•©)</span>';
                } else {
                    areaBadge = `<span style="background:#f5f5f5;color:#666;padding:2px 8px;border-radius:4px;font-size:11px;">${adArea}</span>`;
                }

                return `
                    <tr>
                        <td class="keyword-cell" title="${row.í‚¤ì›Œë“œ || '-'}">${row.í‚¤ì›Œë“œ || '-'}</td>
                        <td>${areaBadge}</td>
                        <td>${formatNumber(row.ë…¸ì¶œìˆ˜)}</td>
                        <td>${formatNumber(row.í´ë¦­ìˆ˜)}</td>
                        <td>${formatNumber(row.ê´‘ê³ ë¹„)}</td>
                        <td>${(row.í´ë¦­ë¥  || 0).toFixed(2)}%</td>
                        <td>${formatNumber(row['ì´ ì£¼ë¬¸ìˆ˜'])}</td>
                        <td>${formatNumber(row['ì´ íŒë§¤ìˆ˜ëŸ‰'])}</td>
                        <td>${formatNumber(row['ì´ ì „í™˜ë§¤ì¶œì•¡'])}</td>
                        <td>${formatNumber(row.CPC)}</td>
                        <td class="${roasClass}">${roas.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('tableSummary').textContent = `ì „ì²´ ${data.length}ê°œ í‚¤ì›Œë“œ`;
        }

        function displayCharts(data) {
            if (!data || data.length === 0) return;

            // Sort by ROAS (ë†’ì€ ìˆœ)
            const sortedByROAS = [...data].sort((a, b) => {
                const roasA = parseFloat(a.ROAS) || 0;
                const roasB = parseFloat(b.ROAS) || 0;
                return roasB - roasA;
            });

            // Get top 10 only
            const chartData = sortedByROAS.slice(0, 10);

            // ROAS Bar Chart
            displayROASBarChart(chartData);

            // Scatter Chart
            displayScatterChart(data);

            // Revenue Top 10 Chart
            displayRevenueTopChart(data);

            // Waste Top 10 Chart
            displayWasteTopChart(data);
        }

        function displayROASBarChart(data) {
            const ctx = document.getElementById('roasBarChart').getContext('2d');

            // Destroy existing chart
            if (window.roasChart && typeof window.roasChart.destroy === 'function') {
                window.roasChart.destroy();
            }

            // í‚¤ì›Œë“œ ë ˆì´ë¸” ì •ë¦¬ (ìµœëŒ€ 30ì)
            const labels = data.map(d => {
                let keyword = d.í‚¤ì›Œë“œ || '-';
                // ë¬¸ìì—´ë¡œ ë³€í™˜
                keyword = String(keyword);
                // 30ì ë„˜ìœ¼ë©´ ìë¥´ê³  ... ì¶”ê°€
                if (keyword.length > 30) {
                    keyword = keyword.substring(0, 30) + '...';
                }
                return keyword;
            });

            window.roasChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ROAS (%)',
                        data: data.map(d => parseFloat(d.ROAS) || 0),
                        backgroundColor: data.map(d => {
                            const roas = parseFloat(d.ROAS) || 0;
                            if (roas >= 150) return 'rgba(15, 157, 88, 0.7)';
                            if (roas >= 50) return 'rgba(245, 171, 0, 0.7)';
                            return 'rgba(234, 67, 53, 0.7)';
                        }),
                        borderColor: data.map(d => {
                            const roas = parseFloat(d.ROAS) || 0;
                            if (roas >= 150) return 'rgba(15, 157, 88, 1)';
                            if (roas >= 50) return 'rgba(245, 171, 0, 1)';
                            return 'rgba(234, 67, 53, 1)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ROAS TOP 10',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `ROAS: ${context.parsed.x.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ROAS (%)'
                            }
                        }
                    }
                }
            });
        }

        function displayScatterChart(data) {
            console.log('[Scatter Chart] Data length:', data.length);

            const ctx = document.getElementById('scatterChart');
            if (!ctx) {
                console.error('[Scatter Chart] Canvas element not found');
                return;
            }

            const context = ctx.getContext('2d');

            // Destroy existing chart
            if (window.scatterChart && typeof window.scatterChart.destroy === 'function') {
                window.scatterChart.destroy();
            }

            // Filter data with spend or revenue > 0
            const points = data
                .filter(d => (d.ê´‘ê³ ë¹„ || 0) > 0 || (d['ì´ ì „í™˜ë§¤ì¶œì•¡'] || 0) > 0)
                .map(d => ({
                    x: d.ê´‘ê³ ë¹„ || 0,
                    y: d['ì´ ì „í™˜ë§¤ì¶œì•¡'] || 0,
                    keyword: d.í‚¤ì›Œë“œ || '-'
                }));

            console.log('[Scatter Chart] Filtered points:', points.length);

            if (points.length === 0) {
                ctx.parentElement.innerHTML = '<p style="text-align:center; padding:60px; color:#999; font-size:14px;">ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ë§¤ì¶œì´ ë°œìƒí•œ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            window.scatterChart = new Chart(context, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'í‚¤ì›Œë“œ',
                        data: points,
                        backgroundColor: 'rgba(26, 115, 232, 0.6)',
                        borderColor: 'rgba(26, 115, 232, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBorderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ê´‘ê³ ë¹„ vs ë§¤ì¶œì•¡ ë¶„í¬',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `í‚¤ì›Œë“œ: ${point.keyword}`,
                                        `ê´‘ê³ ë¹„: ${formatNumber(point.x)}ì›`,
                                        `ë§¤ì¶œ: ${formatNumber(point.y)}ì›`,
                                        `ROAS: ${point.x > 0 ? ((point.y / point.x) * 100).toFixed(1) : 0}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'ê´‘ê³ ë¹„ (ì›)',
                                font: { size: 12, weight: 'bold' }
                            },
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ë§¤ì¶œì•¡ (ì›)',
                                font: { size: 12, weight: 'bold' }
                            },
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });

            console.log('[Scatter Chart] Created successfully');
        }

        // ë§¤ì¶œì•¡ TOP 10 ì°¨íŠ¸
        function displayRevenueTopChart(data) {
            if (!data || data.length === 0) {
                console.log('[Revenue Top Chart] No data');
                return;
            }

            // ë§¤ì¶œì•¡ ê¸°ì¤€ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
            const sorted = [...data].sort((a, b) => {
                const revA = parseFloat(a['ì´ ì „í™˜ë§¤ì¶œì•¡']) || 0;
                const revB = parseFloat(b['ì´ ì „í™˜ë§¤ì¶œì•¡']) || 0;
                return revB - revA;
            });

            const top10 = sorted.slice(0, 10);

            // í‚¤ì›Œë“œëª… (ìµœëŒ€ 30ì)
            const labels = top10.map(d => {
                let keyword = String(d.í‚¤ì›Œë“œ || '-');
                if (keyword.length > 30) {
                    keyword = keyword.substring(0, 30) + '...';
                }
                return keyword;
            });

            // ë§¤ì¶œì•¡ ë°ì´í„°
            const revenues = top10.map(d => parseFloat(d['ì´ ì „í™˜ë§¤ì¶œì•¡']) || 0);

            // ì°¨íŠ¸ ìƒì„±
            const ctx = document.getElementById('revenueTopChart').getContext('2d');

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (window.revenueChart && typeof window.revenueChart.destroy === 'function') {
                window.revenueChart.destroy();
            }

            window.revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë§¤ì¶œì•¡ (ì›)',
                        data: revenues,
                        backgroundColor: 'rgba(46, 204, 113, 0.8)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'ë§¤ì¶œì•¡ TOP 10',
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'ë§¤ì¶œì•¡: ' + formatNumber(context.parsed.x) + 'ì›';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value) + 'ì›';
                                }
                            }
                        }
                    }
                }
            });

            console.log('[Revenue Top Chart] Created successfully');
        }

        // ê´‘ê³ ë¹„ë‚­ë¹„ TOP 10 ì°¨íŠ¸
        function displayWasteTopChart(data) {
            if (!data || data.length === 0) {
                console.log('[Waste Top Chart] No data');
                return;
            }

            // ë‚­ë¹„ë¹„ìš© ê³„ì‚° (ê´‘ê³ ë¹„ - ë§¤ì¶œì•¡)
            const withWaste = data.map(row => {
                const spend = parseFloat(row.ê´‘ê³ ë¹„) || 0;
                const revenue = parseFloat(row['ì´ ì „í™˜ë§¤ì¶œì•¡']) || 0;
                const waste = spend - revenue;

                return {
                    keyword: row.í‚¤ì›Œë“œ,
                    waste: waste,
                    spend: spend,
                    revenue: revenue
                };
            }).filter(row => row.waste > 0); // ì†ì‹¤ë§Œ í‘œì‹œ (waste > 0)

            // ë‚­ë¹„ë¹„ìš© ê¸°ì¤€ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
            const sorted = withWaste.sort((a, b) => b.waste - a.waste);
            const top10 = sorted.slice(0, 10);

            if (top10.length === 0) {
                console.log('[Waste Top Chart] No waste data (all profitable)');
                // ë¹ˆ ì°¨íŠ¸ í‘œì‹œ
                const ctx = document.getElementById('wasteTopChart').getContext('2d');
                if (window.wasteChart && typeof window.wasteChart.destroy === 'function') {
                    window.wasteChart.destroy();
                }
                return;
            }

            // í‚¤ì›Œë“œëª… (ìµœëŒ€ 30ì)
            const labels = top10.map(d => {
                let keyword = String(d.keyword || '-');
                if (keyword.length > 30) {
                    keyword = keyword.substring(0, 30) + '...';
                }
                return keyword;
            });

            // ë‚­ë¹„ë¹„ìš© ë°ì´í„°
            const wastes = top10.map(d => d.waste);

            // ì°¨íŠ¸ ìƒì„±
            const ctx = document.getElementById('wasteTopChart').getContext('2d');

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (window.wasteChart && typeof window.wasteChart.destroy === 'function') {
                window.wasteChart.destroy();
            }

            window.wasteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë‚­ë¹„ë¹„ìš© (ì›)',
                        data: wastes,
                        backgroundColor: 'rgba(231, 76, 60, 0.8)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'ê´‘ê³ ë¹„ë‚­ë¹„ TOP 10',
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const item = top10[idx];
                                    return [
                                        'ë‚­ë¹„ë¹„ìš©: ' + formatNumber(item.waste) + 'ì›',
                                        'ê´‘ê³ ë¹„: ' + formatNumber(item.spend) + 'ì›',
                                        'ë§¤ì¶œì•¡: ' + formatNumber(item.revenue) + 'ì›'
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value) + 'ì›';
                                }
                            }
                        }
                    }
                }
            });

            console.log('[Waste Top Chart] Created successfully');
        }

        /* ========================================
           Filter & Search Functions
           ======================================== */

        function filterByROAS() {
            const threshold = parseFloat(document.getElementById('roasThreshold').value);

            if (isNaN(threshold)) {
                alert('ROAS ê¸°ì¤€ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            filteredData = globalData.filter(row => (row.ROAS || 0) <= threshold);

            if (filteredData.length === 0) {
                alert(`ROAS ${threshold}% ì´í•˜ì¸ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.`);
                filteredData = [...globalData];
            } else {
                alert(`âœ… ROAS ${threshold}% ì´í•˜ í‚¤ì›Œë“œ: ${filteredData.length}ê°œ`);
            }

            displayKeywordTable(filteredData);
            displayCharts(filteredData);
        }

        function resetFilter() {
            document.getElementById('roasThreshold').value = '';
            filteredData = [...globalData];
            displayKeywordTable(filteredData);
            displayCharts(filteredData);
        }

        function searchKeywords() {
            const query = document.getElementById('searchKeyword').value.toLowerCase();

            if (query === '') {
                filteredData = [...globalData];
            } else {
                filteredData = globalData.filter(row =>
                    (row.í‚¤ì›Œë“œ || '').toLowerCase().includes(query)
                );
            }

            displayKeywordTable(filteredData);
        }

        /* ========================================
           Table Sorting
           ======================================== */

        function sortTable(columnIndex) {
            if (currentSortColumn === columnIndex) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnIndex;
                currentSortOrder = 'desc';
            }

            displayKeywordTable(filteredData);
        }

        function getColumnName(index) {
            const columns = [
                'í‚¤ì›Œë“œ', 'ê´‘ê³  ë…¸ì¶œ ì§€ë©´', 'ë…¸ì¶œìˆ˜', 'í´ë¦­ìˆ˜', 'ê´‘ê³ ë¹„', 'í´ë¦­ë¥ ',
                'ì´ ì£¼ë¬¸ìˆ˜', 'ì´ íŒë§¤ìˆ˜ëŸ‰', 'ì´ ì „í™˜ë§¤ì¶œì•¡', 'CPC', 'ROAS'
            ];
            return columns[index];
        }

        /* ========================================
           Excel Download
           ======================================== */

        function downloadExcel() {
            if (!filteredData || filteredData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Prepare data for export
            const exportData = filteredData.map(row => ({
                'í‚¤ì›Œë“œ': row.í‚¤ì›Œë“œ || '-',
                'ê´‘ê³  ë…¸ì¶œ ì§€ë©´': row['ê´‘ê³  ë…¸ì¶œ ì§€ë©´'] || 'ê²€ìƒ‰ ì˜ì—­',
                'ë…¸ì¶œìˆ˜': row.ë…¸ì¶œìˆ˜ || 0,
                'í´ë¦­ìˆ˜': row.í´ë¦­ìˆ˜ || 0,
                'ê´‘ê³ ë¹„': row.ê´‘ê³ ë¹„ || 0,
                'í´ë¦­ë¥ (%)': (row.í´ë¦­ë¥  || 0).toFixed(2),
                'ì´ì£¼ë¬¸ìˆ˜': row['ì´ ì£¼ë¬¸ìˆ˜'] || 0,
                'ì´íŒë§¤ìˆ˜ëŸ‰': row['ì´ íŒë§¤ìˆ˜ëŸ‰'] || 0,
                'ì´ë§¤ì¶œì•¡': row['ì´ ì „í™˜ë§¤ì¶œì•¡'] || 0,
                'CPC': (row.CPC || 0).toFixed(0),
                'ROAS(%)': (row.ROAS || 0).toFixed(2)
            }));

            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ì¿ íŒ¡ê´‘ê³ ë¶„ì„");

            // Download
            const today = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `ì¿ íŒ¡ê´‘ê³ ë¶„ì„_${today}.xlsx`);
        }

        /* ========================================
           Recommendation Functions
           ======================================== */

        let allRecommendations = [];
        let currentRecommendations = [];

        async function getRecommendations() {
            if (!globalData || globalData.length === 0) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            // ì¤‘ë³µ í‚¤ì›Œë“œ ê²€ì¦ (ì§‘ê³„ë˜ì§€ ì•Šì€ ì›ë³¸ ë°ì´í„° ê°ì§€)
            const keywordCount = {};
            globalData.forEach(row => {
                const keyword = row.í‚¤ì›Œë“œ;
                if (keyword) {
                    keywordCount[keyword] = (keywordCount[keyword] || 0) + 1;
                }
            });

            const duplicates = Object.entries(keywordCount)
                .filter(([k, count]) => count > 1)
                .map(([k, count]) => `${k}(${count}ê°œ)`);

            if (duplicates.length > 0) {
                const msg = 'âš ï¸ ì¤‘ë³µëœ í‚¤ì›Œë“œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' +
                            'ì§‘ê³„ë˜ì§€ ì•Šì€ ì›ë³¸ ë°ì´í„°ë¡œ ë³´ì…ë‹ˆë‹¤.\n' +
                            'íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.\n\n' +
                            'ì¤‘ë³µ í‚¤ì›Œë“œ ì˜ˆì‹œ:\n' + duplicates.slice(0, 5).join(', ') +
                            (duplicates.length > 5 ? ` ì™¸ ${duplicates.length - 5}ê°œ` : '');
                alert(msg);
                console.warn('[Recommendations] Duplicate keywords detected:', duplicates.length);
                return;
            }

            try {
                console.log('[Recommendations] Fetching recommendations...');

                // Show loading
                LoadingState.show('AI ë¶„ì„ ì¤‘', 'AIê°€ í‚¤ì›Œë“œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'ë¶„ì„ ì¤‘');

                const response = await fetch('/api/ad-analysis/coupang-recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        data: globalData,
                        criteria: {
                            min_roas: 50,
                            max_cpc_multiplier: 2.0,
                            min_ctr_multiplier: 0.5
                        }
                    })
                });

                // Update progress
                LoadingState.update('ì¶”ì²œ ìƒì„± ì¤‘...', 80);

                const result = await response.json();

                if (result.success) {
                    LoadingState.update('ì™„ë£Œ!', 100);

                    setTimeout(() => {
                        allRecommendations = result.recommendations;
                        currentRecommendations = result.recommendations;
                        displayRecommendations(result.recommendations, result.summary);
                        document.getElementById('recommendationSection').style.display = 'block';
                        LoadingState.hide();

                        // Scroll to recommendations
                        document.getElementById('recommendationSection').scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });

                        console.log('[Recommendations] Success:', result.recommendations.length, 'keywords');
                    }, 300);
                } else {
                    LoadingState.hide();
                    alert('ì¶”ì²œ ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                LoadingState.hide();
                console.error('[Recommendations] Error:', error);
                alert('ì¶”ì²œ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        function displayRecommendations(recommendations, summary) {
            // Update summary cards
            document.getElementById('recWaste').textContent = formatNumber(summary.total_waste);
            document.getElementById('recCount').textContent = summary.keywords_to_exclude;
            document.getElementById('recSavings').textContent = summary.potential_savings.replace('%', '');

            // Update priority counts
            document.getElementById('allCount').textContent = recommendations.length;
            document.getElementById('criticalCount').textContent = summary.critical_priority || 0;
            document.getElementById('highCount').textContent = summary.high_priority;
            document.getElementById('mediumCount').textContent = summary.medium_priority;
            document.getElementById('lowCount').textContent = summary.low_priority;

            // Render table
            renderRecommendationTable(recommendations);
        }

        function renderRecommendationTable(recommendations) {
            const tbody = document.getElementById('recommendationTableBody');

            if (!recommendations || recommendations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" style="text-align: center; padding: 40px;">
                            ì¶”ì²œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = recommendations.map((rec) => {
                const priorityBadge = {
                    'critical': '<span class="priority-badge priority-critical">ğŸ”´ ì¦‰ì‹œì œì™¸</span>',
                    'high': '<span class="priority-badge priority-high">ğŸŸ  ì¡°ì†íˆì œì™¸</span>',
                    'medium': '<span class="priority-badge priority-medium">ğŸŸ¡ ê²€í† í•„ìš”</span>',
                    'low': '<span class="priority-badge priority-low">ğŸŸ¢ ëª¨ë‹ˆí„°ë§</span>',
                    'null': '<span class="priority-badge priority-none">âšª ë°ì´í„°ë¶€ì¡±</span>'
                }[rec.priority] || '<span class="priority-badge priority-none">âšª ë°ì´í„°ë¶€ì¡±</span>';

                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="rec-checkbox" data-keyword="${rec.keyword}">
                        </td>
                        <td><strong>${rec.score || 0}</strong></td>
                        <td>${priorityBadge}</td>
                        <td class="keyword-cell" title="${rec.keyword}"><strong>${rec.keyword}</strong></td>
                        <td style="font-size: 12px;">${rec.reason}</td>
                        <td>${formatNumber(rec.spend)}ì›</td>
                        <td>${formatNumber(rec.revenue)}ì›</td>
                        <td>${rec.roas.toFixed(1)}%</td>
                        <td class="text-danger">${formatNumber(rec.waste)}ì›</td>
                        <td class="text-danger">${rec.waste_rate ? rec.waste_rate.toFixed(1) + '%' : '-'}</td>
                        <td class="text-danger">${formatNumber(rec.opportunity_loss || 0)}ì›</td>
                        <td>${formatNumber(rec.clicks)}</td>
                        <td>${rec.ctr.toFixed(2)}%</td>
                        <td>${formatNumber(rec.cpc || 0)}ì›</td>
                    </tr>
                `;
            }).join('');
        }

        function filterRecommendations(priority) {
            if (!allRecommendations) return;

            let filtered;
            if (priority === 'all') {
                filtered = allRecommendations;
            } else {
                filtered = allRecommendations.filter(r => r.priority === priority);
            }

            currentRecommendations = filtered;
            renderRecommendationTable(filtered);

            // Update active tab
            document.querySelectorAll('.priority-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.priority === priority) {
                    tab.classList.add('active');
                }
            });
        }

        // Sorting state for recommendations (reuse global variables)
        // currentSortColumn and currentSortOrder are already declared globally

        function sortRecommendations(column) {
            if (!currentRecommendations) return;

            // Toggle sort order if clicking same column
            if (currentSortColumn === column) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                // Default to descending for most columns, ascending for keyword
                currentSortOrder = column === 'keyword' ? 'asc' : 'desc';
            }

            // Update sort indicators
            document.querySelectorAll('[id^="sort"]').forEach(el => {
                el.textContent = 'â†•';
            });
            const indicatorId = 'sort' + column.charAt(0).toUpperCase() + column.slice(1).replace('_', '_');
            const indicator = document.getElementById(indicatorId);
            if (indicator) {
                indicator.textContent = currentSortOrder === 'asc' ? 'â†‘' : 'â†“';
            }

            // Sort data
            const sorted = [...currentRecommendations].sort((a, b) => {
                let aVal, bVal;

                // Handle priority sorting specially
                if (column === 'priority') {
                    const priorityOrder = { 'critical': 0, 'high': 1, 'medium': 2, 'low': 3 };
                    aVal = priorityOrder[a.priority] || 999;
                    bVal = priorityOrder[b.priority] || 999;
                } else if (column === 'keyword') {
                    // String sorting
                    aVal = (a[column] || '').toLowerCase();
                    bVal = (b[column] || '').toLowerCase();
                    return currentSortOrder === 'asc'
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                } else {
                    // Numeric sorting
                    aVal = a[column] || 0;
                    bVal = b[column] || 0;
                }

                return currentSortOrder === 'asc' ? aVal - bVal : bVal - aVal;
            });

            renderRecommendationTable(sorted);
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAllRec').checked;
            document.querySelectorAll('.rec-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }

        function exportRecommendations() {
            if (!allRecommendations || allRecommendations.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ì¶”ì²œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const priorityLabels = {
                'critical': 'ì¦‰ì‹œì œì™¸',
                'high': 'ì¡°ì†íˆì œì™¸',
                'medium': 'ê²€í† í•„ìš”',
                'low': 'ëª¨ë‹ˆí„°ë§'
            };

            const exportData = allRecommendations.map(rec => ({
                'ì ìˆ˜': rec.score || 0,
                'ìš°ì„ ìˆœìœ„': priorityLabels[rec.priority] || rec.priority,
                'í‚¤ì›Œë“œ': rec.keyword,
                'ì œì™¸ ì‚¬ìœ ': rec.reason,
                'ê´‘ê³ ë¹„': rec.spend,
                'ë§¤ì¶œ': rec.revenue,
                'ROAS(%)': rec.roas.toFixed(2),
                'ë‚­ë¹„ë¹„ìš©': rec.waste,
                'ë‚­ë¹„ìœ¨(%)': rec.waste_rate ? rec.waste_rate.toFixed(1) : 0,
                'ê¸°íšŒë¹„ìš©': rec.opportunity_loss || 0,
                'í´ë¦­ìˆ˜': rec.clicks,
                'CTR(%)': rec.ctr.toFixed(2),
                'CPC': rec.cpc || 0
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ì œì™¸ì¶”ì²œí‚¤ì›Œë“œ");

            const today = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `ì¿ íŒ¡_ì œì™¸ì¶”ì²œí‚¤ì›Œë“œ_${today}.xlsx`);
        }

        function applyExclusions() {
            const selected = [];
            document.querySelectorAll('.rec-checkbox:checked').forEach(cb => {
                selected.push(cb.dataset.keyword);
            });

            if (selected.length === 0) {
                alert('ì œì™¸í•  í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!confirm(`${selected.length}ê°œ í‚¤ì›Œë“œë¥¼ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì œì™¸ëœ í‚¤ì›Œë“œëŠ” ë°ì´í„°ì—ì„œ í•„í„°ë§ë©ë‹ˆë‹¤.`)) {
                return;
            }

            console.log('[Exclusions] Removing keywords:', selected);

            // Remove from global data
            globalData = globalData.filter(row => !selected.includes(row.í‚¤ì›Œë“œ));
            filteredData = [...globalData];

            // Save updated data
            saveCoupangData(globalData);

            // Recalculate and display
            const summary = calculateSummary(globalData);
            displaySummary(summary);
            displayKeywordTable(filteredData);
            displayCharts(filteredData);

            // Regenerate recommendations
            getRecommendations();

            alert(`âœ… ${selected.length}ê°œ í‚¤ì›Œë“œê°€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        /* ========================================
           Utility Functions
           ======================================== */

        function formatNumber(num) {
            if (num === null || num === undefined || num === '') return '-';
            return Math.round(num).toLocaleString('ko-KR');
        }

        /* ========================================
           Sidebar Toggle
           ======================================== */

        // Sidebar simple toggle
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('sidebarToggle');

        if (toggleBtn && sidebar) {
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
            });
        }

        // Active menu item
        const currentPath = window.location.pathname;
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.getAttribute('href') === currentPath) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });

        // Mobile sidebar toggle
        const mobileToggle = document.getElementById('mobileToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function toggleMobileSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
            mobileToggle.textContent = sidebar.classList.contains('open') ? 'âœ•' : 'â˜°';
        }

        if (mobileToggle) {
            mobileToggle.addEventListener('click', toggleMobileSidebar);
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleMobileSidebar);
        }

        // Close sidebar on menu item click (mobile)
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('active');
                    mobileToggle.textContent = 'â˜°';
                }
            });
        });

        // Clear all data function
        function clearAllData() {
            if (confirm('ëª¨ë“  ëˆ„ì  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem(COUPANG_STORAGE_KEY);
                console.log('[STORAGE] All coupang data cleared');
                alert('âœ… ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                location.reload();
            }
        }
    </script>

    <!-- ë°°ë„ˆ ë¡œë” -->
    <script src="/static/js/banner-loader.js"></script>
</body>
</html>
