<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê´‘ê³  ROAS ë¶„ì„ê¸° | ë„¤ì´ë²„ ë©”íƒ€ êµ¬ê¸€ ê´‘ê³  ì„±ê³¼ ë¶„ì„ - ë§ˆì¼€íŒ…ê´‘ì¥</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="ê´‘ê³ ë°ì´í„°ë¶„ì„,ë„¤ì´ë²„ê²€ìƒ‰ê´‘ê³ ,ë„¤ì´ë²„ì‡¼í•‘ê´‘ê³ ,ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ê´‘ê³ ,ë©”íƒ€ê´‘ê³ ë¶„ì„,êµ¬ê¸€ê´‘ê³ ,ROASë¶„ì„">
    <meta name="keywords" content="ê´‘ê³ ë°ì´í„°ë¶„ì„,ë„¤ì´ë²„ê²€ìƒ‰ê´‘ê³ ,ë„¤ì´ë²„ì‡¼í•‘ê´‘ê³ ,ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ê´‘ê³ ,ROASê³„ì‚°ê¸°,ê´‘ê³ ë¶„ì„,ë„¤ì´ë²„ê´‘ê³ ,ë©”íƒ€ê´‘ê³ ,ê´‘ê³ ì„±ê³¼">
    <meta name="author" content="ë§ˆì¼€íŒ…ê´‘ì¥">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://dashboard.mbizsquare.com/ad-dashboard">

    <!-- Site Verification -->
    <meta name="naver-site-verification" content="cc6eb66db82f1cef83861f978e49ca76d7a72caa">
    <meta name="google-site-verification" content="i3kI5uL7O6tmcojS0WVBql-E5TUPPR1TkZt8Lwe5zyw">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="ê´‘ê³  ROAS ë¶„ì„ê¸° | ë„¤ì´ë²„ ë©”íƒ€ êµ¬ê¸€ ê´‘ê³  ì„±ê³¼ ë¶„ì„">
    <meta property="og:description" content="ë„¤ì´ë²„ ë©”íƒ€ êµ¬ê¸€ ê´‘ê³  ROAS ë¬´ë£Œ ë¶„ì„. CTR CPA ì „í™˜ìœ¨ ìë™ê³„ì‚°.">
    <meta property="og:url" content="https://dashboard.mbizsquare.com/ad-dashboard">
    <meta property="og:site_name" content="ë§ˆì¼€íŒ…ê´‘ì¥">
    <meta property="og:locale" content="ko_KR">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ê´‘ê³  ROAS ë¶„ì„ê¸° | ë„¤ì´ë²„ ë©”íƒ€ êµ¬ê¸€ ê´‘ê³  ì„±ê³¼ ë¶„ì„">
    <meta name="twitter:description" content="ë„¤ì´ë²„ ë©”íƒ€ êµ¬ê¸€ ê´‘ê³  ROAS ë¬´ë£Œ ë¶„ì„. CTR CPA ì „í™˜ìœ¨ ìë™ê³„ì‚°.">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg">
    <link rel="apple-touch-icon" href="/static/img/favicon.svg">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

    <!-- XLSX (Excel ë‚´ë³´ë‚´ê¸°) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- PDF ë‚´ë³´ë‚´ê¸° (html2pdf.js - ìë™ í˜ì´ì§€ ë¶„í• , í•œê¸€ ì§€ì›) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Sidebar CSS -->
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/header.css">
    <link rel="stylesheet" href="/static/css/ad-banner.css">

    <style>
        /* ========================================
           Looker Studio Style - Professional Design
           ======================================== */

        :root {
            /* Looker Studio Color Palette */
            --primary-blue: #1a73e8;
            --primary-blue-dark: #1557b0;
            --secondary-blue: #4285f4;
            --accent-green: #0f9d58;
            --accent-orange: #f9ab00;
            --accent-red: #ea4335;

            /* Neutral Colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-hover: #f1f3f4;
            --border-color: #dadce0;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --text-tertiary: #80868b;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            --shadow-md: 0 1px 3px 0 rgba(60,64,67,.3), 0 4px 8px 3px rgba(60,64,67,.15);
            --shadow-lg: 0 2px 6px 2px rgba(60,64,67,.3), 0 8px 16px 4px rgba(60,64,67,.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
        }

        /* ========================================
           Layout
           ======================================== */

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content - sidebar.cssì—ì„œ ê¸°ë³¸ ì •ì˜ë¨ */
        /* ì¶”ê°€ ìŠ¤íƒ€ì¼ë§Œ ì •ì˜ */

        /* Top Bar */
        .top-bar {
            background: var(--bg-secondary);
            padding: 16px 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .page-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-blue-dark);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            padding: 20px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Summary Section - Top 8 Key Metrics */
        .summary-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .summary-card {
            background: white;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .summary-card:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
        }

        .summary-card.highlight-green {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: var(--accent-green);
        }

        .summary-card.highlight-blue {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: var(--primary-blue);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .summary-unit {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .metric-card.blue {
            border-left-color: var(--primary-blue);
        }

        .metric-card.green {
            border-left-color: var(--accent-green);
        }

        .metric-card.orange {
            border-left-color: var(--accent-orange);
        }

        .metric-card.red {
            border-left-color: var(--accent-red);
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .metric-change {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .metric-change.positive {
            color: var(--accent-green);
        }

        .metric-change.negative {
            color: var(--accent-red);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 48px;
            text-align: center;
            background: var(--bg-hover);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--primary-blue);
            background: #e8f0fe;
        }

        .upload-area.dragging {
            border-color: var(--accent-green);
            background: #e6f4ea;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        /* Table */
        table, .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-hover);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 12px 16px;
            font-size: 14px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: var(--bg-hover);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-excellent {
            background: #e6f4ea;
            color: #137333;
        }

        .status-good {
            background: #fef7e0;
            color: #ea8600;
        }

        .status-poor {
            background: #fce8e6;
            color: #c5221f;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Sidebar Sections */
        .sidebar-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sidebar-item {
            background: var(--bg-hover);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-item:hover {
            background: #e8f0fe;
            transform: translateX(-2px);
        }

        .sidebar-item-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sidebar-item-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .sidebar-compact-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .sidebar-compact-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
            background: white;
        }

        .progress-bar-container {
            background: var(--bg-hover);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-blue);
            transition: width 0.3s;
        }

        .progress-bar.warning {
            background: var(--accent-orange);
        }

        .progress-bar.danger {
            background: var(--accent-red);
        }

        .sidebar-btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            width: 100%;
            margin-bottom: 8px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .spinner-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-blue);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .spinner-ring {
            border: 4px solid transparent;
            border-top: 4px solid var(--secondary-blue);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .loading-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue));
            width: 0%;
            transition: width 0.3s ease;
            background-size: 200% 100%;
            animation: progress-shimmer 1.5s infinite;
        }

        @keyframes progress-shimmer {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }

        .loading-step {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        /* Filter Buttons */
        .filter-btn {
            padding: 6px 14px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: var(--bg-hover);
            border-color: var(--primary-blue);
        }

        .filter-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        /* ========================================
           RESPONSIVE DESIGN - MOBILE & TABLET
           ======================================== */

        /* Tablet (max-width: 1024px) */
        @media (max-width: 1024px) {
            /* Sidebar, main-contentëŠ” sidebar.cssì—ì„œ ê´€ë¦¬ */

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .section-header h2 {
                font-size: 18px;
            }

            .metric-value {
                font-size: 26px;
            }

            .metric-label {
                font-size: 12px;
            }

            .card {
                padding: 15px;
            }

            .page-header {
                padding: 15px 20px;
            }

            .page-title {
                font-size: 22px;
            }
        }

        /* Mobile (max-width: 768px) */
        @media (max-width: 768px) {
            /* Layout - sidebar.cssì—ì„œ ê´€ë¦¬ */
            .dashboard-container {
                grid-template-columns: 1fr;
            }

            /* Prevent horizontal overflow */
            body {
                overflow-x: hidden;
            }

            .main-content {
                overflow-x: hidden;
                padding: 12px !important;
            }

            /* Top Bar ì„¸ë¡œ ë°°ì¹˜ */
            .top-bar {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
                padding: 12px !important;
            }

            .top-bar-actions {
                width: 100%;
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
            }

            .top-bar-actions .btn {
                flex: 1 1 auto;
                min-width: 80px;
                justify-content: center;
            }

            /* Card ë‚´ë¶€ flex ìš”ì†Œë“¤ ì„¸ë¡œ ë°°ì¹˜ ê°•ì œ */
            .card > div[style*="display: flex"] {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px !important;
            }

            .card > div > div[style*="display: flex"] {
                flex-wrap: wrap !important;
                gap: 8px !important;
            }

            /* ê¸°ê°„ ì„ íƒ ë²„íŠ¼ë“¤ wrap */
            .filter-btn {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }

            /* ë°ì´í„° ê´€ë¦¬ ë²„íŠ¼ë“¤ */
            .card .btn {
                padding: 8px 12px !important;
                font-size: 12px !important;
                white-space: nowrap;
            }

            /* Date input í¬ê¸° ì¡°ì • */
            .form-input[type="date"] {
                width: 100% !important;
                max-width: 150px !important;
                padding: 8px !important;
                font-size: 14px !important;
            }

            /* Page header responsive */
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 12px !important;
            }

            .page-title {
                font-size: 18px;
            }

            .page-subtitle {
                font-size: 12px;
            }

            .top-actions {
                width: 100%;
                flex-direction: column;
                gap: 8px;
            }

            .top-actions .btn {
                width: 100%;
                justify-content: center;
            }

            /* Card Header ì„¸ë¡œ ë°°ì¹˜ */
            .card-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
            }

            .card-header .btn {
                width: 100%;
                justify-content: center;
            }

            /* Date range picker responsive */
            .date-range-picker {
                flex-direction: column;
                gap: 10px;
            }

            .date-range-picker input {
                font-size: 14px;
            }

            /* Summary grid - 2ì—´ ë°°ì¹˜ */
            .summary-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }

            .summary-card {
                padding: 12px !important;
            }

            .summary-value {
                font-size: 20px !important;
            }

            .summary-label {
                font-size: 10px !important;
            }

            .summary-unit {
                font-size: 10px !important;
            }

            .metric-value {
                font-size: 22px;
            }

            .metric-label {
                font-size: 11px;
            }

            .metric-change {
                font-size: 11px;
            }

            /* Metrics Grid 2ì—´ */
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            .metric-card {
                padding: 12px !important;
            }

            /* ëª¨ë“  ì¸ë¼ì¸ 2ì—´ ê·¸ë¦¬ë“œë¥¼ 1ì—´ë¡œ ë³€ê²½ (í•µì‹¬!) */
            [style*="grid-template-columns: 1fr 1fr"],
            [style*="grid-template-columns:1fr 1fr"],
            div[style*="display: grid"][style*="1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* creativesContainer ë‚´ë¶€ ê·¸ë¦¬ë“œ */
            #creativesContainer > div[style*="display: grid"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* page-overview ë‚´ë¶€ ê·¸ë¦¬ë“œë“¤ */
            #page-overview > div[style*="display: grid"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* ë¦¬ë“œí˜• ìº í˜ì¸ ë‚´ë¶€ flex ì„¸ë¡œ ë°°ì¹˜ */
            div[style*="display: flex"][style*="justify-content: space-around"] {
                flex-direction: column !important;
                gap: 16px !important;
                align-items: center !important;
            }

            /* Charts grid - stack vertically */
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .chart-container {
                height: 250px;
            }

            /* Cards */
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .section-header h2 {
                font-size: 16px;
            }

            .section-actions {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }

            .section-actions .btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            /* Tables - horizontal scroll */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* ì¹´ë“œ ì•ˆì— í…Œì´ë¸”ì´ ìˆìœ¼ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
            .card:has(table),
            .card:has(.data-table) {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
            }

            .data-table,
            #campaignTable {
                min-width: 500px;
                font-size: 11px;
            }

            .data-table th,
            .data-table td,
            #campaignTable th,
            #campaignTable td {
                padding: 6px 4px;
                white-space: nowrap;
            }

            .data-table th,
            #campaignTable th {
                font-size: 10px;
            }

            /* Hide less important columns on mobile */
            .data-table th:nth-child(n+6),
            .data-table td:nth-child(n+6) {
                display: none;
            }

            /* Buttons - touch friendly */
            .btn {
                min-height: 44px;
                padding: 10px 16px;
                font-size: 14px;
                border-radius: 8px;
            }

            .btn-icon {
                min-width: 44px;
                min-height: 44px;
                padding: 10px;
            }

            /* Modal responsive */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 5% auto;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .modal-body {
                font-size: 14px;
            }

            .modal-footer {
                flex-direction: column;
                gap: 8px;
            }

            .modal-footer .btn {
                width: 100%;
            }

            /* Form groups */
            .form-group {
                margin-bottom: 12px;
            }

            .form-input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 12px;
            }

            label {
                font-size: 12px;
            }

            /* Upload area */
            .upload-area {
                padding: 30px 15px;
                font-size: 14px;
            }

            .upload-icon {
                font-size: 40px;
            }

            /* Filter buttons */
            .filter-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .filter-btn {
                font-size: 12px;
                padding: 8px 10px;
            }

            /* Status badges */
            .status-badge,
            .badge {
                font-size: 10px;
                padding: 3px 8px;
            }

            /* Insights box */
            .insights-box {
                padding: 15px;
                font-size: 13px;
                line-height: 1.5;
            }

            /* Campaign cards grid */
            .campaigns-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .campaign-card {
                padding: 12px;
            }

            .campaign-name {
                font-size: 14px;
            }

            /* Comparison table */
            .comparison-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Loading spinner */
            .loading-overlay {
                padding: 30px;
            }

            .spinner {
                width: 40px;
                height: 40px;
            }

            /* Menu items */
            .menu-item {
                padding: 12px 15px;
                font-size: 14px;
            }

            .menu-icon {
                font-size: 18px;
            }

            /* Sidebar header */
            .sidebar-header {
                padding: 15px;
            }

            .sidebar-logo {
                font-size: 18px;
            }

            /* Stats container */
            .stats-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Action buttons group */
            .button-group {
                flex-direction: column;
                gap: 8px;
            }

            .button-group .btn {
                width: 100%;
            }

            /* Tabs */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                display: flex;
                gap: 8px;
                padding-bottom: 5px;
            }

            .tab {
                white-space: nowrap;
                font-size: 13px;
                padding: 8px 12px;
            }
        }

        /* Extra small mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .page-title {
                font-size: 18px;
            }

            .metric-value {
                font-size: 20px;
            }

            .metric-label {
                font-size: 10px;
            }

            .card {
                padding: 10px;
            }

            .section-header h2 {
                font-size: 14px;
            }

            .chart-container {
                height: 200px;
            }

            .btn {
                font-size: 13px;
                padding: 8px 12px;
            }

            .modal-content {
                width: 98%;
                padding: 15px;
            }

            .form-input {
                padding: 10px;
            }

            .summary-grid {
                gap: 8px;
            }

            .filter-buttons {
                grid-template-columns: 1fr;
            }
        }

        /* Landscape mobile optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            .page-header {
                padding: 10px 15px;
            }

            .chart-container {
                height: 200px;
            }

            .modal-content {
                max-height: 85vh;
            }
        }

        /* ê¸°ê°„ì„ íƒ ë°˜ì‘í˜• (1200px ì´í•˜) */
        @media (max-width: 1200px) {
            /* ê¸°ê°„ ì„ íƒ ì¹´ë“œ ë‚´ë¶€ í”Œë ‰ìŠ¤ */
            .card > div[style*="display: flex"][style*="justify-content: space-between"] {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
            }

            /* ë‚ ì§œ ì…ë ¥ í•„ë“œ ë„ˆë¹„ ì¡°ì • */
            #dateStart, #dateEnd {
                width: 130px !important;
            }
        }

        /* ê¸°ê°„ì„ íƒ ëª¨ë°”ì¼ (768px ì´í•˜) */
        @media (max-width: 768px) {
            /* í•„í„° ë²„íŠ¼ ê·¸ë¦¬ë“œ ë°°ì¹˜ */
            .card > div > div[style*="display: flex"][style*="gap: 8px"]:has(.filter-btn) {
                display: flex !important;
                flex-wrap: wrap !important;
            }

            .filter-btn {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }

            /* ë°ì´í„° ê´€ë¦¬ ë²„íŠ¼ ê·¸ë£¹ */
            .card > div[style*="display: flex"][style*="flex-wrap"] {
                gap: 8px !important;
            }

            .card > div[style*="display: flex"][style*="flex-wrap"] .btn {
                padding: 6px 12px !important;
                font-size: 12px !important;
            }
        }

        /* Print styles - PDF ì¶œë ¥ìš© */
        @media print {
            /* ë¸Œë¼ìš°ì € ê¸°ë³¸ í—¤ë”/í‘¸í„° ì œê±° (ë‚ ì§œ, URL ë“±) */
            @page {
                margin: 10mm;
                size: A4 portrait;
            }

            /* ë¶ˆí•„ìš”í•œ ìš”ì†Œ ìˆ¨ê¹€ */
            .sidebar,
            .mobile-menu-toggle,
            .top-actions,
            .section-actions,
            .top-navigation,
            .filter-section,
            .btn,
            button,
            #pdfLoading {
                display: none !important;
            }

            /* ë©”ì¸ ì»¨í…ì¸  ì „ì²´ ë„ˆë¹„ë¡œ í™•ì¥ + ìƒë‹¨ ì—¬ë°± ì œê±° */
            .main-content {
                margin: 0 !important;
                margin-left: 0 !important;
                margin-top: 0 !important;
                padding: 15px !important;
                width: 100% !important;
                max-width: none !important;
                position: static !important;
            }

            /* fixed/absolute ìš”ì†Œë“¤ì„ staticìœ¼ë¡œ ë³€ê²½ */
            .top-navigation,
            .sidebar,
            header,
            nav {
                position: static !important;
            }

            /* ë°°ê²½ìƒ‰ ì¶œë ¥ í™œì„±í™” */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* ì¹´ë“œê°€ í˜ì´ì§€ ê²½ê³„ì—ì„œ ì˜ë¦¬ì§€ ì•Šë„ë¡ */
            .card,
            .metric-card,
            .summary-card,
            .chart-container,
            table {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }

            /* ê·¸ë¦¬ë“œ ë‹¨ì¼ ì»¬ëŸ¼ìœ¼ë¡œ ë³€ê²½ */
            [style*="grid-template-columns: 1fr 1fr"],
            [style*="grid-template-columns:1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ë†’ì´ ì¡°ì • */
            .chart-container {
                height: auto !important;
                min-height: 250px !important;
                max-height: 350px !important;
            }

            /* v10.2: íŠ¸ë Œë“œ ì°¨íŠ¸ ê°€ë¡œ ì§¤ë¦¼ ë°©ì§€ */
            #trendChart {
                width: 100% !important;
                max-width: 100% !important;
                height: 280px !important;
            }

            .card:has(#trendChart) .chart-container {
                height: 300px !important;
                overflow: hidden !important;
            }

            /* í˜ì´ì§€ í—¤ë” */
            .page-header {
                padding: 10px 0 !important;
            }

            /* body ì—¬ë°± ì œê±° */
            body {
                margin: 0 !important;
                padding: 0 !important;
            }
        }

        /* Utility classes for responsive */
        .mobile-only {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: block;
            }

            .desktop-only {
                display: none;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                padding: 12px 18px;
            }

            .menu-item {
                padding: 14px 16px;
            }

            .filter-btn {
                padding: 10px 14px;
            }

            .data-table td {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" id="mobileToggle" aria-label="ë©”ë‰´ ì—´ê¸°">â˜°</button>

    <!-- Top Header -->
    <header class="top-header">
        <div class="header-left">
            <h1 class="logo-text"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:20px;height:20px;vertical-align:middle;margin-right:6px;filter:brightness(0) invert(1);">ë§ˆì¼€íŒ…ê´‘ì¥ ê´‘ê³ ë¶„ì„</h1>
            <span class="logo-subtitle">ê´‘ê³ ë¶„ì„</span>
        </div>
        <div class="header-right">
            <a href="http://pf.kakao.com/_DZwYn" target="_blank" class="header-btn"><img src="/static/img/icons/guide.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> <span class="btn-text">ì œíœ´ë¬¸ì˜</span></a>
            <a href="https://mbizsquare.com" target="_blank" class="header-btn"><img src="/static/img/icons/dashboard.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> <span class="btn-text">ë°”ë¡œê°€ê¸°</span></a>
            <div class="user-info">
                <span class="user-nickname"><img src="/static/img/icons/calculator.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> {{ (user.get('username') or user.get('user_id', 'User')) if user else 'ë‹‰ë„¤ì„' }}</span>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>ë©”ë‰´</h2>
        </div>
        <nav class="sidebar-menu">
            <a href="/" class="menu-item">
                <span class="icon"><img src="/static/img/icons/dashboard.svg" alt=""></span>
                <span class="label">ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a href="/guide" class="menu-item">
                <span class="icon"><img src="/static/img/icons/guide.svg" alt=""></span>
                <span class="label">ì´ìš©ì•ˆë‚´</span>
            </a>
            <a href="/ad-dashboard" class="menu-item active">
                <span class="icon"><img src="/static/img/icons/chart.svg" alt=""></span>
                <span class="label">ê´‘ê³ ë¶„ì„</span>
            </a>
            <a href="/ad-dashboard/coupang" class="menu-item">
                <span class="icon"><img src="/static/img/icons/cart.svg" alt=""></span>
                <span class="label">ì¿ íŒ¡ê´‘ê³ ë¶„ì„</span>
            </a>
            <a href="/ad-dashboard/profit-simulator" class="menu-item">
                <span class="icon"><img src="/static/img/icons/calculator.svg" alt=""></span>
                <span class="label">ìˆ˜ìµ ì‹œë®¬ë ˆì´í„°</span>
            </a>
            <a href="/ad-dashboard/ad-efficiency" class="menu-item">
                <span class="icon"><img src="/static/img/icons/target.svg" alt=""></span>
                <span class="label">ì†ìµë¶„ê¸° ROAS</span>
            </a>
            <a href="/ad-dashboard/keyword-combiner" class="menu-item">
                <span class="icon"><img src="/static/img/icons/combine.svg" alt=""></span>
                <span class="label">í‚¤ì›Œë“œ ì¡°í•©ê¸°</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
            <!-- Page Header -->
            <div class="top-bar">
                <div>
                    <div class="page-title">ì¼ë°˜ + ë©”íƒ€ ê´‘ê³  ë¶„ì„</div>
                    <div class="page-subtitle">ì‹¤ì‹œê°„ ê´‘ê³  ì„±ê³¼ ë¶„ì„ ë° ì¸ì‚¬ì´íŠ¸</div>
                </div>
            </div>

            <!-- ê·¸ë¦¬ë“œ ë°°ë„ˆ 2x4 (200x60 x 8ê°œ) -->
            <div id="generalGridBanners"></div>

            <!-- Page: Overview -->
            <div id="page-overview" class="page-content">
                <!-- Date Filter Section -->
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="font-weight: 600; color: var(--text-primary); margin-right: 8px;"><img src="/static/img/icons/calendar.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> ê¸°ê°„ ì„ íƒ:</span>
                            <button class="filter-btn active" data-filter="all" onclick="applyDateFilter('all')">ì „ì²´</button>
                            <button class="filter-btn" data-filter="today" onclick="applyDateFilter('today')">ì˜¤ëŠ˜</button>
                            <button class="filter-btn" data-filter="week" onclick="applyDateFilter('week')">ìµœê·¼ 7ì¼</button>
                            <button class="filter-btn" data-filter="month" onclick="applyDateFilter('month')">ìµœê·¼ 30ì¼</button>
                            <button class="filter-btn" data-filter="custom" onclick="openCustomDateModal()">ì»¤ìŠ¤í…€ ê¸°ê°„</button>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="date" id="dateStart" class="form-input" style="width: 140px; padding: 6px 10px;">
                            <span style="color: var(--text-secondary);">~</span>
                            <input type="date" id="dateEnd" class="form-input" style="width: 140px; padding: 6px 10px;">
                            <button class="btn btn-primary" onclick="applyCustomDateRange()" style="padding: 6px 16px;">ì ìš©</button>
                        </div>
                    </div>
                    <div id="currentDateRange" style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">
                        í˜„ì¬ ê¸°ê°„: ì „ì²´ ë°ì´í„°
                    </div>
                </div>

                <!-- Action Buttons Bar -->
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="font-weight: 600; color: var(--text-primary); margin-right: 8px;">ğŸ“Š ë°ì´í„° ê´€ë¦¬:</span>

                            <!-- í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ë“œë¡­ë‹¤ìš´ -->
                            <div style="position: relative; display: inline-block;">
                                <button class="btn btn-secondary" id="templateDropdownBtn" onclick="toggleTemplateDropdown(event)" style="padding: 8px 16px;">
                                    <img src="/static/img/icons/download.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ â–¼
                                </button>
                                <div id="templateDropdown" class="hidden" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; min-width: 180px; margin-top: 4px;">
                                    <a href="/api/ad-analysis/template/unified" style="display: block; padding: 10px 16px; color: var(--text-primary); text-decoration: none;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
                                        ğŸ“‹ í†µí•© í…œí”Œë¦¿ (ê¶Œì¥)
                                    </a>
                                </div>
                            </div>

                            <!-- íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ -->
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="padding: 8px 16px;">
                                <img src="/static/img/icons/upload.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> íŒŒì¼ ì—…ë¡œë“œ
                            </button>

                            <!-- ìˆ˜ê¸° ì…ë ¥ ë²„íŠ¼ -->
                            <button class="btn btn-success" onclick="openManualInputModal()" style="padding: 8px 16px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border: none;">
                                âœï¸ ìˆ˜ë™ ì…ë ¥
                            </button>

                            <!-- ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ë²„íŠ¼ -->
                            <button class="btn btn-secondary" onclick="clearAllData()" style="padding: 8px 16px;">
                                ğŸ—‘ï¸ ì´ˆê¸°í™”
                            </button>
                        </div>

                        <div style="display: flex; gap: 8px; align-items: center;">
                            <!-- ì €ì¥ ë²„íŠ¼ (ê³„ì • ì—°ë™ ì „ê¹Œì§€ ìˆ¨ê¹€)
                            <button class="btn btn-secondary" onclick="openSaveAnalysisModal()" style="padding: 8px 16px;">
                                <img src="/static/img/icons/save.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> ì €ì¥
                            </button>
                            -->

                            <!-- ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ (ê³„ì • ì—°ë™ ì „ê¹Œì§€ ìˆ¨ê¹€)
                            <button class="btn btn-secondary" onclick="openLoadAnalysisModal()" style="padding: 8px 16px;">
                                ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                            -->

                            <!-- PDF ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ -->
                            <button class="btn btn-secondary" onclick="exportToPDF()" style="padding: 8px 16px;">
                                <img src="/static/img/icons/file.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> PDF ë‚´ë³´ë‚´ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Top Summary Section - 8 Key Metrics -->
                <div class="summary-section">
                    <h3 style="margin-bottom: 15px; font-size: 18px; color: var(--text-primary);">ğŸ“Š í•µì‹¬ ì§€í‘œ ìš”ì•½</h3>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">ì´ ë¹„ìš©</div>
                            <div class="summary-value" id="summarySpend">-</div>
                            <div class="summary-unit">ì›</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">ì „í™˜ìˆ˜</div>
                            <div class="summary-value" id="summaryConversions">-</div>
                            <div class="summary-unit">ê±´</div>
                        </div>

                        <div class="summary-card highlight-green">
                            <div class="summary-label">ì´ ë§¤ì¶œ</div>
                            <div class="summary-value" id="summaryRevenue">-</div>
                            <div class="summary-unit">ì›</div>
                        </div>

                        <div class="summary-card highlight-blue">
                            <div class="summary-label">ROAS</div>
                            <div class="summary-value" id="summaryRoas">-</div>
                            <div class="summary-unit">%</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">ë…¸ì¶œìˆ˜</div>
                            <div class="summary-value" id="summaryImpressions">-</div>
                            <div class="summary-unit">íšŒ</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">í´ë¦­ìˆ˜</div>
                            <div class="summary-value" id="summaryClicks">-</div>
                            <div class="summary-unit">íšŒ</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">í´ë¦­ë¥  (CTR)</div>
                            <div class="summary-value" id="summaryCtr">-</div>
                            <div class="summary-unit">%</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">ì „í™˜ìœ¨ (CVR)</div>
                            <div class="summary-value" id="summaryCvr">-</div>
                            <div class="summary-unit">%</div>
                        </div>
                    </div>

                    <!-- ê³„ì‚° ê³µì‹ ì„¤ëª… -->
                    <div style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-size: 11px; color: #5f6368; line-height: 1.6;">
                        <strong>ğŸ“ ê³„ì‚° ê³µì‹:</strong><br>
                        â€¢ ROAS = (ë§¤ì¶œ Ã· ë¹„ìš©) Ã— 100<br>
                        â€¢ CTR = (í´ë¦­ìˆ˜ Ã· ë…¸ì¶œìˆ˜) Ã— 100<br>
                        â€¢ CVR = (ì „í™˜ìˆ˜ Ã· í´ë¦­ìˆ˜) Ã— 100
                    </div>
                </div>

                <!-- Metrics Grid (ê¸°ì¡´ 4ê°œ ì¹´ë“œ - í•˜ìœ„ ì„¹ì…˜) -->
                <div class="metrics-grid" id="metricsGrid">
                    <div class="metric-card blue">
                        <div class="metric-label">í‰ê·  ROAS</div>
                        <div class="metric-value">-</div>
                        <div class="metric-change positive">
                            <span>â†‘</span>
                            <span>-</span>
                        </div>
                    </div>

                    <div class="metric-card green">
                        <div class="metric-label">í´ë¦­ë¥  (CTR)</div>
                        <div class="metric-value">-</div>
                        <div class="metric-change positive">
                            <span>â†‘</span>
                            <span>-</span>
                        </div>
                    </div>

                    <div class="metric-card orange">
                        <div class="metric-label">ì „í™˜ë‹¹ ë¹„ìš© (CPA)</div>
                        <div class="metric-value">-</div>
                        <div class="metric-change negative">
                            <span>â†“</span>
                            <span>-</span>
                        </div>
                    </div>

                    <div class="metric-card red">
                        <div class="metric-label">ì „í™˜ìœ¨ (CVR)</div>
                        <div class="metric-value">-</div>
                        <div class="metric-change positive">
                            <span>â†‘</span>
                            <span>-</span>
                        </div>
                    </div>
                </div>

                <!-- Chart 1: ì¼ë³„ ì„±ê³¼ íŠ¸ë Œë“œ (full width) -->
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-header">
                        <div class="card-title"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> ì¼ë³„ ì„±ê³¼ íŠ¸ë Œë“œ</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- ì„±ê³¼ ë¶„í¬ ì¹´ë“œ (ë§¤ì¶œí˜• + ë¦¬ë“œí˜• ë¶„ë¦¬) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <!-- ë§¤ì¶œí˜• ìº í˜ì¸ ì„±ê³¼ (ROAS ê¸°ì¤€) -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> ë§¤ì¶œí˜• ìº í˜ì¸ ì„±ê³¼</div>
                        </div>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="salesDistributionChart"></canvas>
                        </div>
                        <div style="padding: 12px; background: #f5f7fa; border-radius: 8px; font-size: 12px; margin: 0 16px 16px;">
                            <strong>ROAS ê¸°ì¤€</strong><br>
                            <span style="color: #0f9d58;">â— ìš°ìˆ˜: 400% ì´ìƒ</span><br>
                            <span style="color: #f4b400;">â— ë³´í†µ: 300~400%</span><br>
                            <span style="color: #ea4335;">â— ê°œì„ í•„ìš”: 300% ë¯¸ë§Œ</span>
                        </div>
                    </div>

                    <!-- ë¦¬ë“œí˜• ìº í˜ì¸ ì„±ê³¼ (CPA ìˆ«ì í‘œì‹œ) -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ‘¥ ë¦¬ë“œí˜• ìº í˜ì¸ ì„±ê³¼</div>
                        </div>
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">í‰ê·  ë¦¬ë“œë‹¹ ë¹„ìš© (CPA)</div>
                            <div id="avgCpaDisplay" style="font-size: 42px; font-weight: 700; color: #1a73e8;">
                                -
                            </div>
                            <div style="margin-top: 20px; display: flex; justify-content: space-around;">
                                <div>
                                    <div style="font-size: 28px; font-weight: 600;" id="leadTotalCount">0</div>
                                    <div style="font-size: 12px; color: #666;">ì´ ë¦¬ë“œìˆ˜</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: 600;" id="leadTotalSpend">0</div>
                                    <div style="font-size: 12px; color: #666;">ì´ ê´‘ê³ ë¹„</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: 600;" id="leadCampaignCount">0</div>
                                    <div style="font-size: 12px; color: #666;">ìº í˜ì¸ìˆ˜</div>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: #f5f7fa; border-radius: 8px; font-size: 12px; margin: 0 16px 16px;">
                            <strong>CPA = ê´‘ê³ ë¹„ Ã· ì „í™˜ìˆ˜</strong><br>
                            ë¦¬ë“œ 1ê±´ íšë“ì— ë“¤ì–´ê°„ ë¹„ìš©
                        </div>
                    </div>
                </div>

                <!-- 2x2 Charts Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">

                    <!-- Chart 3: ì˜ˆì‚° ë°°ë¶„ (Pie Chart) -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ’° ìº í˜ì¸ë³„ ì˜ˆì‚° ë°°ë¶„</div>
                        </div>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="budgetPieChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 4: ì „í™˜ í¼ë„ -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ”» ì „í™˜ í¼ë„</div>
                            <span id="impressionsEstimatedBadge" class="badge badge-warning" style="display: none;">âš ï¸ ë…¸ì¶œìˆ˜ ì¶”ì •ë¨</span>
                        </div>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="conversionFunnelChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 5: ìš”ì¼ë³„ ì„±ê³¼ íˆíŠ¸ë§µ -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><img src="/static/img/icons/calendar.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> ìš”ì¼ë³„ ì„±ê³¼</div>
                        </div>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="weekdayHeatmapChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Campaign Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ìº í˜ì¸ ì„±ê³¼</div>
                    </div>
                    <table id="campaignTable">
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>ìº í˜ì¸ëª…</th>
                                <th>ê´‘ê³ ìœ í˜•</th>
                                <th>ì£¼ìš”ì§€í‘œ</th>
                                <th>CTR</th>
                                <th>ì „í™˜ë‹¨ê°€</th>
                                <th>ì§€ì¶œì•¡</th>
                                <th>ë©”ëª¨</th>
                            </tr>
                        </thead>
                        <tbody id="campaignTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 48px; color: var(--text-secondary);">
                                    ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ìº í˜ì¸ ë¶„ì„ì´ í‘œì‹œë©ë‹ˆë‹¤
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section: Data Upload -->
            <!-- Hidden file input for upload -->
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">

            <!-- Section: Creative Analysis -->
            <h2 style="margin: 40px 0 16px; font-size: 20px; color: var(--text-primary); font-weight: 600; padding: 12px 20px; background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 4px solid #ffc107; border-radius: 8px;">â­ ê´‘ê³  í•µì‹¬ ë¶„ì„</h2>

            <!-- Page: Creative Analysis -->
            <div id="page-creatives" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ¨ ì†Œì¬ ì„±ê³¼ ë¶„ì„</div>
                        <div class="card-subtitle">ê´‘ê³  ì†Œì¬ë³„ ROAS ë° ì „í™˜ìœ¨ ìˆœìœ„</div>
                    </div>

                    <div id="creativesContainer">
                        <!-- Grid for TOP 10 Tables -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <!-- ROAS TOP 10 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title" style="font-size: 16px;">ğŸ“Š ROAS TOP 10 ì†Œì¬</div>
                                </div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ìˆœìœ„</th>
                                            <th>ì†Œì¬ëª…</th>
                                            <th>íƒ€ì…</th>
                                            <th>ROAS</th>
                                            <th>ë§¤ì¶œ</th>
                                            <th>ì§€ì¶œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="roasTopCreativesTable">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                                                ì†Œì¬ ë°ì´í„°ê°€ í¬í•¨ëœ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- CVR TOP 10 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title" style="font-size: 16px;"><img src="/static/img/icons/target.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> ì „í™˜ìœ¨ TOP 10 ì†Œì¬</div>
                                </div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ìˆœìœ„</th>
                                            <th>ì†Œì¬ëª…</th>
                                            <th>íƒ€ì…</th>
                                            <th>CVR</th>
                                            <th>ì „í™˜ìˆ˜</th>
                                            <th>í´ë¦­ìˆ˜</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cvrTopCreativesTable">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                                                ì†Œì¬ ë°ì´í„°ê°€ í¬í•¨ëœ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Full Creative Performance Table -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">ì „ì²´ ì†Œì¬ ì„±ê³¼</div>
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ì†Œì¬ëª…</th>
                                        <th>íƒ€ì…</th>
                                        <th>í”Œë«í¼</th>
                                        <th>ROAS</th>
                                        <th>CVR</th>
                                        <th>CTR</th>
                                        <th>CPA</th>
                                        <th>ì „í™˜ìˆ˜</th>
                                        <th>ì§€ì¶œì•¡</th>
                                        <th>ë§¤ì¶œì•¡</th>
                                        <th>ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="allCreativesTable">
                                    <tr>
                                        <td colspan="11" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                                            ì†Œì¬ ë°ì´í„°ê°€ í¬í•¨ëœ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="creativesEmptyState" class="hidden">
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¨</div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                ì†Œì¬ ë¶„ì„ì„ ìœ„í•œ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤
                            </div>
                            <div style="color: var(--text-secondary); margin-bottom: 24px;">
                                'í‘œì¤€ í…œí”Œë¦¿' ë˜ëŠ” 'ê³ ê¸‰ í…œí”Œë¦¿'ì„ ì‚¬ìš©í•˜ì—¬ ì†Œì¬ ì •ë³´ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”
                            </div>
                            <button class="btn btn-primary" onclick="document.querySelector('[data-page=\\'upload\\']').click()">
                                <img src="/static/img/icons/upload.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> ë°ì´í„° ì—…ë¡œë“œí•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

    </main>

    <!-- Loading Overlay (Enhanced) -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner-wrapper">
                <div class="spinner"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3 id="loadingTitle" class="loading-title">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</h3>
            <p id="loadingMessage" class="loading-message">íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <p id="loadingStep" class="loading-step">1/3 ë‹¨ê³„ ì§„í–‰ ì¤‘</p>
        </div>
    </div>

    <script>
        // Global Data Storage
        let currentMetricsData = null;
        let currentDailyData = null;
        let originalDailyData = null;  // ì›ë³¸ ë°ì´í„° ë³´ì¡´ (ê¸°ê°„ í•„í„°ë§ ì‹œ ì‚¬ìš©)
        let currentCampaignData = null;
        let currentDateFilter = 'all';

        // LocalStorage Key
        const STORAGE_KEY = 'ad_dashboard_accumulated_data';

        // Loading State Manager
        const LoadingState = {
            show(title, message, step = null) {
                const overlay = document.getElementById('loadingOverlay');
                const titleEl = document.getElementById('loadingTitle');
                const messageEl = document.getElementById('loadingMessage');
                const stepEl = document.getElementById('loadingStep');
                const progressBar = document.getElementById('progressBar');

                overlay.classList.remove('hidden');
                titleEl.textContent = title;
                messageEl.textContent = message;

                if (step) {
                    stepEl.textContent = step;
                    stepEl.style.display = 'block';
                } else {
                    stepEl.style.display = 'none';
                }

                progressBar.style.width = '0%';
                setTimeout(() => progressBar.style.width = '30%', 100);
            },

            update(message, progress) {
                const messageEl = document.getElementById('loadingMessage');
                const progressBar = document.getElementById('progressBar');

                messageEl.textContent = message;
                progressBar.style.width = `${progress}%`;
            },

            hide() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('hidden');
            }
        };

        // Save data to localStorage
        function saveToLocalStorage(newDailyData) {
            try {
                // Get existing data
                const existingData = loadFromLocalStorage();

                // Merge new data with existing
                const mergedData = mergeDataArrays(existingData, newDailyData);

                // Save merged data
                localStorage.setItem(STORAGE_KEY, JSON.stringify(mergedData));
                console.log('[STORAGE] Saved data:', mergedData.length, 'days');

                return mergedData;
            } catch (error) {
                console.error('[STORAGE] Save error:', error);
                return newDailyData;
            }
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    console.log('[STORAGE] Loaded data:', data.length, 'days');
                    return data;
                }
            } catch (error) {
                console.error('[STORAGE] Load error:', error);
            }
            return [];
        }

        // Merge daily data arrays (avoid duplicates by date + campaign)
        function mergeDataArrays(existingData, newData) {
            const merged = [...existingData];

            newData.forEach(newItem => {
                const existingIndex = merged.findIndex(item =>
                    item.date === newItem.date && item.campaign_name === newItem.campaign_name
                );

                if (existingIndex >= 0) {
                    // Update existing entry
                    merged[existingIndex] = newItem;
                    console.log('[MERGE] Updated:', newItem.date, newItem.campaign_name);
                } else {
                    // Add new entry
                    merged.push(newItem);
                    console.log('[MERGE] Added:', newItem.date, newItem.campaign_name);
                }
            });

            // Sort by date
            merged.sort((a, b) => new Date(a.date) - new Date(b.date));

            return merged;
        }

        // Clear all accumulated data
        function clearAllData() {
            if (confirm('ëª¨ë“  ëˆ„ì  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem(STORAGE_KEY);
                currentMetricsData = null;
                currentDailyData = null;
                currentCampaignData = null;
                console.log('[STORAGE] All data cleared');
                alert('âœ… ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');

                // Reload page to reset UI
                location.reload();
            }
        }

        // Recalculate metrics from daily data
        function recalculateMetrics(dailyData) {
            console.log('[RECALC] recalculateMetrics called with data:', dailyData);
            if (!dailyData || dailyData.length === 0) {
                console.log('[RECALC] No data, returning null');
                return null;
            }

            // Aggregate totals
            const totals = dailyData.reduce((acc, row, index) => {
                try {
                    acc.spend += parseFloat(row.spend) || 0;
                    acc.revenue += parseFloat(row.revenue) || 0;
                    acc.clicks += parseInt(row.clicks) || 0;
                    acc.conversions += parseInt(row.conversions) || 0;
                    acc.impressions += parseInt(row.impressions) || 0;
                } catch (e) {
                    console.error(`[RECALC] Error processing row ${index}:`, row, e);
                }
                return acc;
            }, { spend: 0, revenue: 0, clicks: 0, conversions: 0, impressions: 0 });

            console.log('[RECALC] Totals:', totals);

            // Calculate campaign metrics first
            const campaigns = calculateCampaignMetrics(dailyData);
            console.log('[RECALC] Campaigns:', campaigns);

            // Calculate aggregate metrics
            const metrics = {
                total_spend: totals.spend,
                total_revenue: totals.revenue,
                total_clicks: totals.clicks,
                total_conversions: totals.conversions,
                total_impressions: totals.impressions,
                avg_roas: totals.spend > 0 ? totals.revenue / totals.spend : 0,
                avg_ctr: totals.impressions > 0 ? (totals.clicks / totals.impressions) * 100 : 0,
                avg_cpc: totals.clicks > 0 ? totals.spend / totals.clicks : 0,
                avg_cpa: totals.conversions > 0 ? totals.spend / totals.conversions : 0,
                cvr: totals.clicks > 0 ? (totals.conversions / totals.clicks) * 100 : 0,
                avg_order_value: totals.conversions > 0 ? totals.revenue / totals.conversions : 0,
                daily_trend: dailyData.map(d => ({
                    ...d,
                    roas: d.spend > 0 ? d.revenue / d.spend : 0,
                    ctr: d.impressions > 0 ? (d.clicks / d.impressions) * 100 : 0,
                    cvr: d.clicks > 0 ? (d.conversions / d.clicks) * 100 : 0,
                    cpa: d.conversions > 0 ? d.spend / d.conversions : 0
                })),
                campaigns: campaigns
            };

            console.log('[RECALC] Final metrics:', metrics);
            return metrics;
        }

        // Calculate campaign-level metrics
        function calculateCampaignMetrics(dailyData) {
            console.log('[CAMPAIGN] calculateCampaignMetrics called with:', dailyData.length, 'rows');
            const campaignMap = {};

            // Group by campaign
            dailyData.forEach((row, index) => {
                console.log(`[CAMPAIGN] Processing row ${index}:`, row);
                const name = row.campaign_name || 'Unknown Campaign';
                if (!name) {
                    console.warn('[CAMPAIGN] Row missing campaign_name:', row);
                    return; // Skip this row
                }

                if (!campaignMap[name]) {
                    campaignMap[name] = {
                        campaign_name: name,
                        ad_type: row.ad_type || 'sales',
                        spend: 0,
                        revenue: 0,
                        clicks: 0,
                        conversions: 0,
                        impressions: 0
                    };
                }

                try {
                    campaignMap[name].spend += parseFloat(row.spend) || 0;
                    campaignMap[name].revenue += parseFloat(row.revenue) || 0;
                    campaignMap[name].clicks += parseInt(row.clicks) || 0;
                    campaignMap[name].conversions += parseInt(row.conversions) || 0;
                    campaignMap[name].impressions += parseInt(row.impressions) || 0;
                } catch (e) {
                    console.error('[CAMPAIGN] Error processing row:', row, e);
                }
            });

            // Convert to array and calculate derived metrics
            const campaigns = Object.values(campaignMap).map(c => {
                const roas = c.spend > 0 ? c.revenue / c.spend : 0;
                const cpa = c.conversions > 0 ? c.spend / c.conversions : 0;
                const enrichedCampaign = {
                    ...c,
                    roas: roas,
                    ctr: c.impressions > 0 ? (c.clicks / c.impressions) * 100 : 0,
                    cpa: cpa,
                    cvr: c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0
                };
                enrichedCampaign.status = getStatusFromMetrics(enrichedCampaign);
                return enrichedCampaign;
            });

            // Sort by ROAS and add rank
            campaigns.sort((a, b) => b.roas - a.roas);
            campaigns.forEach((c, index) => {
                c.rank = index + 1;
            });

            return campaigns;
        }

        // Get status classification from ROAS
        function getStatusFromRoas(roas) {
            if (roas >= 4.0) return 'excellent';
            if (roas >= 3.0) return 'good';
            return 'poor';
        }

        // Get status classification based on ad_type (Lead: CPA, Sales: ROAS)
        function getStatusFromMetrics(campaign) {
            const adType = campaign.ad_type || 'sales';

            if (adType === 'lead') {
                const cpa = campaign.cpa || 0;
                if (cpa > 0 && cpa <= 30000) return 'excellent';
                if (cpa <= 50000) return 'good';
                return 'poor';
            } else {
                const roas = campaign.roas || 0;
                if (roas >= 4.0) return 'excellent';
                if (roas >= 3.0) return 'good';
                return 'poor';
            }
        }

        // Update data summary badge (v10.3: ë°°ì§€ ì‚­ì œë¨ - ì´ˆê¸°í™” ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´)
        function updateDataSummaryBadge() {
            // ê¸°ì¡´ ë°°ì§€ê°€ ìˆìœ¼ë©´ ì œê±°
            const existingBadge = document.getElementById('dataSummaryBadge');
            if (existingBadge) {
                existingBadge.remove();
            }
        }

        // Dropdown Toggle Functions
        function toggleTemplateDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('templateDropdown');
            const exportDropdown = document.getElementById('exportDropdown');
            // Close other dropdown
            if (exportDropdown) exportDropdown.classList.add('hidden');
            dropdown.classList.toggle('hidden');
        }

        function toggleExportDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('exportDropdown');
            const templateDropdown = document.getElementById('templateDropdown');
            // Close other dropdown
            if (templateDropdown) templateDropdown.classList.add('hidden');
            dropdown.classList.toggle('hidden');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#templateDropdownBtn') && !e.target.closest('#templateDropdown')) {
                const templateDropdown = document.getElementById('templateDropdown');
                if (templateDropdown) templateDropdown.classList.add('hidden');
            }
            if (!e.target.closest('#exportDropdownBtn') && !e.target.closest('#exportDropdown')) {
                const exportDropdown = document.getElementById('exportDropdown');
                if (exportDropdown) exportDropdown.classList.add('hidden');
            }
        });

        // Export Functions
        function exportToExcel() {
            // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
            if (typeof XLSX === 'undefined') {
                alert('Excel ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            // localStorageì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const storedData = loadFromLocalStorage();

            if (!storedData || storedData.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Sheet 1: Daily Data
                const dailySheet = XLSX.utils.json_to_sheet(storedData.map(row => ({
                    'ë‚ ì§œ': row.date,
                    'ìº í˜ì¸ëª…': row.campaign_name,
                    'ê´‘ê³ ìœ í˜•': row.ad_type === 'lead' ? 'ì ì¬ê³ ê°' : 'ë§¤ì¶œí˜•',
                    'ì§€ì¶œì•¡': row.spend,
                    'ë…¸ì¶œìˆ˜': row.impressions || 0,
                    'í´ë¦­ìˆ˜': row.clicks,
                    'ì „í™˜ìˆ˜': row.conversions,
                    'ë§¤ì¶œì•¡': row.revenue
                })));
                XLSX.utils.book_append_sheet(wb, dailySheet, 'ì¼ë³„ë°ì´í„°');

                // Sheet 2: Campaign Summary
                if (currentCampaignData && currentCampaignData.length > 0) {
                    const campaignSheet = XLSX.utils.json_to_sheet(currentCampaignData.map(c => ({
                        'ìº í˜ì¸ëª…': c.campaign_name,
                        'ê´‘ê³ ìœ í˜•': c.ad_type === 'lead' ? 'ì ì¬ê³ ê°' : 'ë§¤ì¶œí˜•',
                        'ROAS': c.roas,
                        'CPL': c.cpl || '-',
                        'CTR': c.ctr,
                        'CPA': c.cpa,
                        'ì§€ì¶œì•¡': c.spend,
                        'ë§¤ì¶œì•¡': c.revenue,
                        'ì „í™˜ìˆ˜': c.conversions
                    })));
                    XLSX.utils.book_append_sheet(wb, campaignSheet, 'ìº í˜ì¸ë³„ìš”ì•½');
                }

                // Download
                const fileName = `ê´‘ê³ ë¶„ì„_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                alert('âœ… Excel íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('[exportToExcel] Error:', error);
                alert('âŒ Excel ìƒì„± ì‹¤íŒ¨: ' + error.message);
            }
        }

        function exportToPDF() {
            // ë°ì´í„° í™•ì¸
            const storedData = loadFromLocalStorage();
            if (!storedData || storedData.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            // ì¸ì‡„ ì•ˆë‚´
            alert('ì¸ì‡„ ëŒ€í™”ìƒìì—ì„œ "PDFë¡œ ì €ì¥"ì„ ì„ íƒí•˜ì„¸ìš”.\n\nê¶Œì¥ ì„¤ì •:\n- ìš©ì§€: A4\n- ì—¬ë°±: ê¸°ë³¸ê°’ ë˜ëŠ” ìµœì†Œ\n- ë°°ê²½ ê·¸ë˜í”½: ì²´í¬ âœ“\n- ë¨¸ë¦¬ê¸€/ë°”ë‹¥ê¸€: í•´ì œ (ì˜µì…˜ì—ì„œ)');

            // ë¸Œë¼ìš°ì € ì¸ì‡„ í˜¸ì¶œ
            window.print();
        }

        // Download Template Function
        function downloadTemplate(type) {
            // Redirect to template download API
            window.location.href = `/api/ad-analysis/template/${type}`;
        }

        // Export to CSV Function
        function exportToCSV() {
            const storedData = loadFromLocalStorage();

            if (!storedData || storedData.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            // Create CSV content
            const headers = ['ë‚ ì§œ', 'ìº í˜ì¸ëª…', 'ê´‘ê³ ìœ í˜•', 'ì§€ì¶œì•¡', 'ë…¸ì¶œìˆ˜', 'í´ë¦­ìˆ˜', 'ì „í™˜ìˆ˜', 'ë§¤ì¶œì•¡'];
            const rows = storedData.map(row => [
                row.date,
                row.campaign_name,
                row.ad_type === 'lead' ? 'ì ì¬ê³ ê°' : 'ë§¤ì¶œí˜•',
                row.spend,
                row.impressions || 0,
                row.clicks,
                row.conversions,
                row.revenue
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma
                    const str = String(cell);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(','))
            ].join('\n');

            // Add BOM for Excel compatibility with Korean characters
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ê´‘ê³ ë¶„ì„_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // Load Analysis Modal Functions
        function openLoadAnalysisModal() {
            loadSavedAnalysesList();
            document.getElementById('loadAnalysisModal').classList.remove('hidden');
        }

        function closeLoadAnalysisModal() {
            document.getElementById('loadAnalysisModal').classList.add('hidden');
        }

        // Page Initialization - Load existing data
        function initializePage() {
            console.log('[INIT] Initializing page...');

            // Check for existing data in localStorage
            const storedData = loadFromLocalStorage();
            console.log('[INIT] Found stored data:', storedData.length, 'rows');

            if (storedData.length > 0) {
                // Recalculate metrics from stored data
                const metrics = recalculateMetrics(storedData);
                console.log('[INIT] Recalculated metrics:', metrics);

                // Display stored data
                displayMetrics(metrics);
                displayChart(metrics.daily_trend);
                displayCampaigns(metrics.campaigns);

                // Update badge
                updateDataSummaryBadge();

                console.log('[INIT] Page initialized with stored data');
            } else {
                console.log('[INIT] No stored data found');
            }
        }

        // Manual Input Modal Functions
        let manualDataBuffer = [];

        function openManualInputModal() {
            manualDataBuffer = [];
            document.getElementById('manualInputModal').classList.remove('hidden');
            updateManualDataPreview();
        }

        function closeManualInputModal() {
            document.getElementById('manualInputModal').classList.add('hidden');
            manualDataBuffer = [];
        }

        function addManualData() {
            const date = document.getElementById('manualDate').value;
            const campaign = document.getElementById('manualCampaign').value;
            const adType = document.getElementById('manualAdType').value;
            const spend = parseFloat(document.getElementById('manualSpend').value) || 0;
            const clicks = parseInt(document.getElementById('manualClicks').value) || 0;
            const conversions = parseInt(document.getElementById('manualConversions').value) || 0;
            const revenue = parseFloat(document.getElementById('manualRevenue').value) || 0;
            const impressions = parseInt(document.getElementById('manualImpressions').value) || 0;

            if (!date || !campaign) {
                alert('ë‚ ì§œì™€ ìº í˜ì¸ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            // ì ì¬ê³ ê° ìœ í˜•ì´ë©´ ë§¤ì¶œì•¡ì€ 0ìœ¼ë¡œ ì„¤ì •
            const finalRevenue = adType === 'lead' ? 0 : revenue;

            manualDataBuffer.push({
                date,
                campaign_name: campaign,
                ad_type: adType,
                spend,
                clicks,
                conversions,
                revenue: finalRevenue,
                impressions
            });

            // Clear inputs except date and campaign
            document.getElementById('manualSpend').value = '';
            document.getElementById('manualClicks').value = '';
            document.getElementById('manualConversions').value = '';
            document.getElementById('manualRevenue').value = '';
            document.getElementById('manualImpressions').value = '';

            updateManualDataPreview();
            alert(`ë°ì´í„° ì¶”ê°€ë¨ (ì´ ${manualDataBuffer.length}ê±´)`);
        }

        function updateManualDataPreview() {
            document.getElementById('manualDataCount').textContent = manualDataBuffer.length;
        }

        // submitManualData is defined later with API integration

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('[INIT] DOM Content Loaded');
            initializePage();
        });

        // Page Navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.dataset.page;

                // Update active menu
                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                this.classList.add('active');

                // Show page
                document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
                document.getElementById(`page-${page}`).classList.remove('hidden');
            });
        });

        // File Upload
        const fileInput = document.getElementById('fileInput');

        console.log('[DEBUG] File input initialized:', fileInput ? 'found' : 'not found');

        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                console.log('[DEBUG] File input changed, files:', e.target.files.length);
                if (e.target.files.length > 0) {
                    console.log('[DEBUG] Uploading file:', e.target.files[0].name);
                    uploadFile(e.target.files[0]);
                }
            });
        }

        // Upload File Function
        async function uploadFile(file) {
            console.log('[DEBUG] uploadFile called with:', file.name, file.size, 'bytes');

            // Step 1: Show loading
            LoadingState.show('íŒŒì¼ ì—…ë¡œë“œ ì¤‘', 'íŒŒì¼ì„ ê²€ì¦í•˜ê³  ìˆìŠµë‹ˆë‹¤...', '1/4 ë‹¨ê³„');
            console.log('[DEBUG] Loading overlay shown');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('snapshot_name', `ë¶„ì„ ${new Date().toLocaleDateString()}`);

            try {
                console.log('[DEBUG] Starting fetch request...');

                // Step 2: Upload to server
                LoadingState.update('ì„œë²„ì— ì—…ë¡œë“œ ì¤‘...', 25);

                const response = await fetch('/api/ad-analysis/upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('[DEBUG] Response received, status:', response.status);

                // Step 3: Process data
                LoadingState.update('ë°ì´í„° ì²˜ë¦¬ ì¤‘...', 50);

                const result = await response.json();
                console.log('[DEBUG] Result:', result);

                if (result.success) {
                    console.log('[DEBUG] Upload successful, processing data...');

                    // Save new daily data to localStorage and merge with existing
                    // campaign_name í¬í•¨ëœ daily_data ìš°ì„  ì‚¬ìš© (ì—†ìœ¼ë©´ daily_trendë¡œ í´ë°±)
                    const newDailyData = result.metrics.daily_data || result.metrics.daily_trend || [];
                    console.log('[DEBUG] Using daily_data with campaign names:', newDailyData.length, 'rows');
                    const mergedDailyData = saveToLocalStorage(newDailyData);
                    console.log('[DEBUG] Merged data count:', mergedDailyData.length);

                    // Recalculate metrics from accumulated data
                    const accumulatedMetrics = recalculateMetrics(mergedDailyData);
                    console.log('[DEBUG] Accumulated metrics:', accumulatedMetrics);

                    // Update data summary badge
                    updateDataSummaryBadge();

                    // Step 4: Render charts
                    LoadingState.update('ì°¨íŠ¸ ìƒì„± ì¤‘...', 75);

                    // Switch to overview page FIRST (with null check)
                    const overviewBtn = document.querySelector('[data-page="overview"]');
                    if (overviewBtn) {
                        overviewBtn.click();
                        // Wait for tab transition, then display data
                        setTimeout(() => {
                            console.log('[DEBUG] Displaying metrics after tab switch (upload)...');
                            displayMetrics(accumulatedMetrics);
                            displayChart(accumulatedMetrics.daily_trend);
                            displayCampaigns(accumulatedMetrics.campaigns);

                            // í•µì‹¬ë¶„ì„ ì„¹ì…˜ ì—…ë°ì´íŠ¸
                            if (accumulatedMetrics.creatives && accumulatedMetrics.creatives.length > 0) {
                                console.log('[DEBUG] Displaying creatives:', accumulatedMetrics.creatives.length);
                                displayCreatives(accumulatedMetrics.creatives);
                            } else {
                                console.log('[DEBUG] No creative data, showing empty state');
                                showNoCreativeDataState();
                            }

                            // Complete
                            LoadingState.update('ì™„ë£Œ!', 100);

                            setTimeout(() => {
                                LoadingState.hide();
                                alert('âœ… ì—…ë¡œë“œ ë° ë¶„ì„ ì™„ë£Œ! ëˆ„ì  ë°ì´í„°: ' + mergedDailyData.length + 'í–‰');
                            }, 300);
                        }, 100);
                    } else {
                        // No overview button, display immediately
                        displayMetrics(accumulatedMetrics);
                        displayChart(accumulatedMetrics.daily_trend);
                        displayCampaigns(accumulatedMetrics.campaigns);

                        // í•µì‹¬ë¶„ì„ ì„¹ì…˜ ì—…ë°ì´íŠ¸
                        if (accumulatedMetrics.creatives && accumulatedMetrics.creatives.length > 0) {
                            displayCreatives(accumulatedMetrics.creatives);
                        } else {
                            showNoCreativeDataState();
                        }

                        // Complete
                        LoadingState.update('ì™„ë£Œ!', 100);

                        setTimeout(() => {
                            LoadingState.hide();
                            alert('âœ… ì—…ë¡œë“œ ë° ë¶„ì„ ì™„ë£Œ! ëˆ„ì  ë°ì´í„°: ' + mergedDailyData.length + 'í–‰');
                        }, 300);
                    }
                } else {
                    LoadingState.hide();
                    alert('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                LoadingState.hide();
                console.error('[DEBUG] Upload error:', error);
                alert('âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ ìƒë‹¨ì˜ ì œíœ´ë¬¸ì˜ë¥¼ í†µí•´ ë¬¸ì˜í•´ì£¼ì„¸ìš” : ' + error.message);
            }
        }

        // Display Metrics
        function displayMetrics(metrics) {
            console.log('[displayMetrics] Called with:', metrics);

            // Store data globally for filtering
            currentMetricsData = metrics;

            // ì›ë³¸ ë°ì´í„° ì €ì¥ (ìµœì´ˆ 1íšŒë§Œ)
            if (!originalDailyData || originalDailyData.length === 0) {
                originalDailyData = metrics.daily_trend || [];
                console.log('[displayMetrics] Original data saved:', originalDailyData.length, 'records');
            }

            currentDailyData = metrics.daily_trend || [];
            currentCampaignData = metrics.campaigns || [];

            // Update 8 Summary Cards (Top Section) with error handling
            try {
                const el1 = document.getElementById('summarySpend');
                if (el1) {
                    el1.textContent = (metrics.total_spend / 10000).toFixed(0) + 'ë§Œ';
                    console.log('[displayMetrics] Updated summarySpend');
                } else {
                    console.warn('[displayMetrics] summarySpend element not found');
                }

                const el2 = document.getElementById('summaryConversions');
                if (el2) el2.textContent = (metrics.total_conversions || 0).toLocaleString();

                const el3 = document.getElementById('summaryRevenue');
                if (el3) {
                    el3.textContent = (metrics.total_revenue / 10000).toFixed(0) + 'ë§Œ';
                    console.log('[displayMetrics] Updated summaryRevenue');
                }

                const el4 = document.getElementById('summaryRoas');
                if (el4) {
                    el4.textContent = ((metrics.avg_roas || 0) * 100).toFixed(0);
                    console.log('[displayMetrics] Updated summaryRoas');
                }

                const el5 = document.getElementById('summaryImpressions');
                if (el5) el5.textContent = ((metrics.total_impressions || 0) / 1000).toFixed(0) + 'K';

                const el6 = document.getElementById('summaryClicks');
                if (el6) el6.textContent = (metrics.total_clicks || 0).toLocaleString();

                const el7 = document.getElementById('summaryCtr');
                if (el7) el7.textContent = (metrics.avg_ctr || 0).toFixed(0);

                const el8 = document.getElementById('summaryCvr');
                if (el8) el8.textContent = (metrics.cvr || 0).toFixed(0);

                console.log('[displayMetrics] Summary cards updated successfully');
            } catch (error) {
                console.error('[displayMetrics] Error updating summary cards:', error);
            }

            // Update metric cards (existing 4 cards)
            const cards = document.querySelectorAll('.metric-card');
            if (cards.length >= 4) {
                cards[0].querySelector('.metric-value').textContent = ((metrics.avg_roas || 0) * 100).toFixed(0) + '%' || '-';
                cards[1].querySelector('.metric-value').textContent = (metrics.avg_ctr || 0).toFixed(0) + '%' || '-';
                cards[2].querySelector('.metric-value').textContent = (metrics.avg_cpa || 0).toLocaleString() + 'ì›' || '-';
                cards[3].querySelector('.metric-value').textContent = (metrics.cvr || 0).toFixed(0) + '%' || '-';
            }

            // Display all charts
            if (metrics.daily_trend) {
                displayChart(metrics.daily_trend);
            }

            // Display new advanced charts
            if (metrics.campaigns) {
                displayCampaigns(metrics.campaigns);
                displayROASDistribution(metrics.campaigns);
                displayBudgetPieChart(metrics.campaigns);
                displayConversionFunnel(metrics);
                displayCampaignComparison(metrics.campaigns);
                displayWeekdayHeatmap(metrics.daily_trend);
            }

            // Display creative analysis
            if (metrics.creatives && metrics.creatives.length > 0) {
                displayCreatives(metrics.creatives);
            }
        }

        // Display Chart
        let trendChart = null;
        function displayChart(dailyData) {
            const chartElement = document.getElementById('trendChart');
            if (!chartElement) {
                console.log('[displayChart] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (trendChart) {
                trendChart.destroy();
            }

            const dates = dailyData.map(d => d.date);
            const roasData = dailyData.map(d => (d.roas || 0) * 100); // Convert to percentage
            const spendData = dailyData.map(d => d.spend / 10000);
            const revenueData = dailyData.map(d => (d.revenue || 0) / 10000);
            const conversionsData = dailyData.map(d => d.conversions || 0);

            // Calculate data ranges for better axis scaling
            const roasMax = Math.max(...roasData.filter(v => v != null && !isNaN(v)));
            const roasMin = Math.min(...roasData.filter(v => v != null && !isNaN(v)));
            const spendMax = Math.max(...spendData.filter(v => v != null && !isNaN(v)));

            console.log('[displayChart] ROAS range:', roasMin, '-', roasMax);
            console.log('[displayChart] Spend max:', spendMax);

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'ROAS (%)',
                            data: roasData,
                            borderColor: 'rgb(46, 204, 113)',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: 'rgb(46, 204, 113)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'ë§¤ì¶œ (ë§Œì›)',
                            data: revenueData,
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            tension: 0.4,
                            yAxisID: 'y2'
                        },
                        {
                            label: 'ì „í™˜ìˆ˜',
                            data: conversionsData,
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            tension: 0.4,
                            yAxisID: 'y3'
                        },
                        {
                            label: 'ì§€ì¶œ (ë§Œì›)',
                            data: spendData,
                            type: 'bar',
                            backgroundColor: 'rgba(52, 152, 219, 0.3)',
                            borderColor: 'rgb(52, 152, 219)',
                            borderWidth: 1,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 13, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label === 'ROAS (%)') {
                                        label += context.parsed.y.toFixed(0) + '%';
                                    } else if (context.dataset.label === 'ì „í™˜ìˆ˜') {
                                        label += context.parsed.y.toFixed(0) + 'ê±´';
                                    } else if (context.dataset.label.includes('ë§Œì›')) {
                                        label += context.parsed.y.toFixed(0) + 'ë§Œì›';
                                    } else {
                                        label += context.parsed.y.toFixed(0);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ROAS (%)',
                                color: 'rgb(46, 204, 113)',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            suggestedMax: roasMax > 0 ? Math.ceil(roasMax * 1.2) : 500,
                            ticks: {
                                stepSize: 50,
                                color: 'rgb(46, 204, 113)',
                                font: { weight: 'bold', size: 12 },
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(46, 204, 113, 0.1)',
                                drawBorder: true,
                                borderColor: 'rgb(46, 204, 113)',
                                borderWidth: 2
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ë§¤ì¶œ/ì§€ì¶œ (ë§Œì›)',
                                color: 'rgb(255, 159, 64)',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            ticks: {
                                color: 'rgb(255, 159, 64)',
                                font: { weight: 'bold', size: 12 }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        y3: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ì „í™˜ìˆ˜',
                                color: 'rgb(153, 102, 255)',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            ticks: {
                                color: 'rgb(153, 102, 255)',
                                font: { weight: 'bold', size: 12 }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });

            console.log('[displayChart] Chart rendered successfully with enhanced ROAS visibility');
        }

        // Chart 2a: ë§¤ì¶œí˜• ìº í˜ì¸ ROAS ë¶„í¬ (Doughnut Chart)
        let salesDistChart = null;
        function displaySalesDistribution(campaigns) {
            const salesCampaigns = campaigns.filter(c => (c.ad_type || 'sales') === 'sales');

            const chartElement = document.getElementById('salesDistributionChart');
            if (!chartElement) {
                console.log('[displaySalesDistribution] Chart element not found');
                return;
            }

            const ctx = chartElement.getContext('2d');
            if (salesDistChart) {
                salesDistChart.destroy();
            }

            if (salesCampaigns.length === 0) {
                // ë§¤ì¶œí˜• ìº í˜ì¸ì´ ì—†ëŠ” ê²½ìš°
                salesDistChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ë§¤ì¶œí˜• ìº í˜ì¸ ì—†ìŒ'],
                        datasets: [{ data: [1], backgroundColor: ['#e0e0e0'] }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
                return;
            }

            // ROAS ê¸°ì¤€ ë¶„ë¥˜
            const excellent = salesCampaigns.filter(c => c.roas >= 4.0).length;
            const good = salesCampaigns.filter(c => c.roas >= 3.0 && c.roas < 4.0).length;
            const poor = salesCampaigns.filter(c => c.roas < 3.0).length;
            const total = salesCampaigns.length;

            const excellentPct = ((excellent / total) * 100).toFixed(1);
            const goodPct = ((good / total) * 100).toFixed(1);
            const poorPct = ((poor / total) * 100).toFixed(1);

            salesDistChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `ìš°ìˆ˜ ${excellent}ê°œ (${excellentPct}%)`,
                        `ë³´í†µ ${good}ê°œ (${goodPct}%)`,
                        `ê°œì„ í•„ìš” ${poor}ê°œ (${poorPct}%)`
                    ],
                    datasets: [{
                        data: [excellent, good, poor],
                        backgroundColor: ['#0f9d58', '#f4b400', '#ea4335'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 11 }, padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label;
                                }
                            }
                        }
                    }
                }
            });

            console.log('[displaySalesDistribution] Sales campaigns:', total, 'Excellent:', excellent, 'Good:', good, 'Poor:', poor);
        }

        // Chart 2b: ë¦¬ë“œí˜• ìº í˜ì¸ CPA ìš”ì•½ (ìˆ«ì í‘œì‹œ)
        function displayLeadSummary(campaigns) {
            const leadCampaigns = campaigns.filter(c => c.ad_type === 'lead');

            const avgCpaEl = document.getElementById('avgCpaDisplay');
            const leadCountEl = document.getElementById('leadTotalCount');
            const leadSpendEl = document.getElementById('leadTotalSpend');
            const leadCampaignCountEl = document.getElementById('leadCampaignCount');

            if (!avgCpaEl) {
                console.log('[displayLeadSummary] Elements not found');
                return;
            }

            if (leadCampaigns.length === 0) {
                avgCpaEl.textContent = 'ë°ì´í„° ì—†ìŒ';
                avgCpaEl.style.fontSize = '24px';
                avgCpaEl.style.color = '#999';
                leadCountEl.textContent = '-';
                leadSpendEl.textContent = '-';
                leadCampaignCountEl.textContent = '0';
                return;
            }

            const totalSpend = leadCampaigns.reduce((sum, c) => sum + (c.spend || 0), 0);
            const totalConversions = leadCampaigns.reduce((sum, c) => sum + (c.conversions || 0), 0);
            const avgCpa = totalConversions > 0 ? Math.round(totalSpend / totalConversions) : 0;

            // í‰ê·  CPA í‘œì‹œ
            if (avgCpa > 0) {
                avgCpaEl.textContent = avgCpa.toLocaleString() + 'ì›';
                avgCpaEl.style.fontSize = '42px';
                avgCpaEl.style.color = '#1a73e8';
            } else {
                avgCpaEl.textContent = 'ì „í™˜ ì—†ìŒ';
                avgCpaEl.style.fontSize = '24px';
                avgCpaEl.style.color = '#ea4335';
            }

            // ì´ ë¦¬ë“œìˆ˜
            leadCountEl.textContent = totalConversions.toLocaleString() + 'ê±´';

            // ì´ ê´‘ê³ ë¹„
            if (totalSpend >= 100000000) {
                leadSpendEl.textContent = (totalSpend / 100000000).toFixed(1) + 'ì–µ';
            } else {
                leadSpendEl.textContent = Math.round(totalSpend / 10000).toLocaleString() + 'ë§Œ';
            }

            // ìº í˜ì¸ ìˆ˜
            leadCampaignCountEl.textContent = leadCampaigns.length + 'ê°œ';

            console.log('[displayLeadSummary] Lead campaigns:', leadCampaigns.length, 'Total conversions:', totalConversions, 'Avg CPA:', avgCpa);
        }

        // ê¸°ì¡´ í•¨ìˆ˜ í˜¸í™˜ì„± ìœ ì§€ (ë‘ í•¨ìˆ˜ ë™ì‹œ í˜¸ì¶œ)
        function displayROASDistribution(campaigns) {
            displaySalesDistribution(campaigns);
            displayLeadSummary(campaigns);
        }

        // Chart 3: Budget Pie Chart
        let budgetPieChart = null;
        function displayBudgetPieChart(campaigns) {
            // Data validation
            if (!campaigns || campaigns.length === 0) {
                console.log('[displayBudgetPieChart] No campaign data to display');
                return;
            }

            const chartElement = document.getElementById('budgetPieChart');
            if (!chartElement) {
                console.log('[displayBudgetPieChart] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (budgetPieChart) {
                budgetPieChart.destroy();
            }

            // Top 5 campaigns by spend
            const topCampaigns = [...campaigns]
                .sort((a, b) => b.spend - a.spend)
                .slice(0, 5);

            const otherSpend = campaigns
                .slice(5)
                .reduce((sum, c) => sum + c.spend, 0);

            const labels = topCampaigns.map(c => c.campaign_name);
            const data = topCampaigns.map(c => c.spend / 10000);

            if (otherSpend > 0) {
                labels.push('ê¸°íƒ€');
                data.push(otherSpend / 10000);
            }

            const colors = ['#1a73e8', '#0f9d58', '#f4b400', '#ea4335', '#9334e6', '#95a5a6'];

            budgetPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(0)}ë§Œì› (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Chart 4: Conversion Funnel
        let conversionFunnelChart = null;
        function displayConversionFunnel(metrics) {
            // Data validation
            if (!metrics) {
                console.log('[displayConversionFunnel] No metrics data to display');
                return;
            }

            const chartElement = document.getElementById('conversionFunnelChart');
            if (!chartElement) {
                console.log('[displayConversionFunnelChart] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (conversionFunnelChart) {
                conversionFunnelChart.destroy();
            }

            const impressions = metrics.total_impressions || 0;
            const clicks = metrics.total_clicks || 0;
            const conversions = metrics.total_conversions || 0;

            // Calculate conversion rates
            const ctr = impressions > 0 ? ((clicks / impressions) * 100).toFixed(2) : 0;
            const cvr = clicks > 0 ? ((conversions / clicks) * 100).toFixed(2) : 0;

            // Show/hide impression estimation badge
            const badge = document.getElementById('impressionsEstimatedBadge');
            if (metrics.impressions_estimated) {
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }

            conversionFunnelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        `ë…¸ì¶œìˆ˜`,
                        `í´ë¦­ìˆ˜ (CTR ${ctr}%)`,
                        `ì „í™˜ìˆ˜ (CVR ${cvr}%)`
                    ],
                    datasets: [{
                        label: 'ì „í™˜ í¼ë„',
                        data: [impressions, clicks, conversions],
                        backgroundColor: ['#1a73e8', '#0f9d58', '#f4b400'],
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const label = context.label;
                                    return `${label}: ${value.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            console.log('[displayConversionFunnel] Funnel rendered with CTR:', ctr, '% CVR:', cvr, '%');
        }

        // Chart 5: Campaign Comparison (Bar Chart)
        let campaignComparisonChart = null;
        function displayCampaignComparison(campaigns) {
            // Data validation
            if (!campaigns || campaigns.length === 0) {
                console.log('[displayCampaignComparison] No campaign data to display');
                return;
            }

            const chartElement = document.getElementById('campaignComparisonChart');
            if (!chartElement) {
                console.log('[displayCampaignComparison] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (campaignComparisonChart) {
                campaignComparisonChart.destroy();
            }

            // Top 8 campaigns by ROAS
            const topCampaigns = [...campaigns]
                .sort((a, b) => b.roas - a.roas)
                .slice(0, 8);

            const labels = topCampaigns.map(c => c.campaign_name.length > 15 ? c.campaign_name.substring(0, 15) + '...' : c.campaign_name);
            const roasData = topCampaigns.map(c => c.roas);

            campaignComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ROAS',
                        data: roasData,
                        backgroundColor: roasData.map(r => r >= 4.0 ? '#0f9d58' : r >= 3.0 ? '#f4b400' : '#ea4335'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'ROAS' }
                        }
                    }
                }
            });
        }

        // Update comparison chart based on selected metric
        function updateComparisonChart() {
            const metric = document.getElementById('comparisonMetricSelect').value;

            if (!currentCampaignData || currentCampaignData.length === 0) {
                return;
            }

            const topCampaigns = [...currentCampaignData]
                .sort((a, b) => b[metric] - a[metric])
                .slice(0, 8);

            const labels = topCampaigns.map(c => c.campaign_name.length > 15 ? c.campaign_name.substring(0, 15) + '...' : c.campaign_name);

            let data, label, color;

            switch(metric) {
                case 'roas':
                    data = topCampaigns.map(c => c.roas);
                    label = 'ROAS';
                    color = data.map(r => r >= 4.0 ? '#0f9d58' : r >= 3.0 ? '#f4b400' : '#ea4335');
                    break;
                case 'spend':
                    data = topCampaigns.map(c => c.spend / 10000);
                    label = 'ì§€ì¶œì•¡ (ë§Œì›)';
                    color = '#1a73e8';
                    break;
                case 'revenue':
                    data = topCampaigns.map(c => c.revenue / 10000);
                    label = 'ë§¤ì¶œì•¡ (ë§Œì›)';
                    color = '#0f9d58';
                    break;
                case 'conversions':
                    data = topCampaigns.map(c => c.conversions);
                    label = 'ì „í™˜ìˆ˜';
                    color = '#f4b400';
                    break;
            }

            if (campaignComparisonChart) {
                campaignComparisonChart.data.labels = labels;
                campaignComparisonChart.data.datasets[0].data = data;
                campaignComparisonChart.data.datasets[0].label = label;
                campaignComparisonChart.data.datasets[0].backgroundColor = color;
                campaignComparisonChart.update();
            }
        }

        // Chart 6: Weekday Heatmap (Bar Chart)
        let weekdayHeatmapChart = null;
        function displayWeekdayHeatmap(dailyData) {
            // Data validation
            if (!dailyData || dailyData.length === 0) {
                console.log('[displayWeekdayHeatmap] No data to display');
                return;
            }

            const chartElement = document.getElementById('weekdayHeatmapChart');
            if (!chartElement) {
                console.log('[displayWeekdayHeatmap] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (weekdayHeatmapChart) {
                weekdayHeatmapChart.destroy();
            }

            // Group by day of week with expanded metrics
            const weekdayData = {
                'ì¼': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                'ì›”': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                'í™”': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                'ìˆ˜': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                'ëª©': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                'ê¸ˆ': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                'í† ': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 }
            };

            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            dailyData.forEach(d => {
                // íƒ€ì„ì¡´ ë¬¸ì œ í•´ê²°: ë¡œì»¬ íƒ€ì„ì¡´ìœ¼ë¡œ ëª…ì‹œì  íŒŒì‹±
                const parts = d.date.split('-');
                const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                const dayName = dayNames[date.getDay()];
                weekdayData[dayName].spend += d.spend || 0;
                weekdayData[dayName].revenue += d.revenue || 0;
                weekdayData[dayName].conversions += d.conversions || 0;
                weekdayData[dayName].clicks += d.clicks || 0;
                weekdayData[dayName].impressions += d.impressions || 0;
                weekdayData[dayName].count += 1;
            });

            // Calculate averages per weekday
            const labels = dayNames;
            const avgSpend = labels.map(day => weekdayData[day].count > 0 ? weekdayData[day].spend / weekdayData[day].count / 10000 : 0);
            const avgRevenue = labels.map(day => weekdayData[day].count > 0 ? weekdayData[day].revenue / weekdayData[day].count / 10000 : 0);
            const avgConversions = labels.map(day => weekdayData[day].count > 0 ? weekdayData[day].conversions / weekdayData[day].count : 0);
            const avgROAS = labels.map(day => {
                const totalSpend = weekdayData[day].spend;
                const totalRevenue = weekdayData[day].revenue;
                return totalSpend > 0 ? ((totalRevenue / totalSpend) * 100) : 0;  // Convert to percentage
            });
            const avgCTR = labels.map(day => {
                const totalImpressions = weekdayData[day].impressions;
                const totalClicks = weekdayData[day].clicks;
                return totalImpressions > 0 ? ((totalClicks / totalImpressions) * 100) : 0;
            });
            const avgCVR = labels.map(day => {
                const totalClicks = weekdayData[day].clicks;
                const totalConversions = weekdayData[day].conversions;
                return totalClicks > 0 ? ((totalConversions / totalClicks) * 100) : 0;
            });

            weekdayHeatmapChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ROAS',
                            data: avgROAS,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: 'rgb(46, 204, 113)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'í‰ê·  ë§¤ì¶œ (ë§Œì›)',
                            data: avgRevenue,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgb(52, 152, 219)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'í‰ê·  ì§€ì¶œ (ë§Œì›)',
                            data: avgSpend,
                            backgroundColor: 'rgba(155, 89, 182, 0.7)',
                            borderColor: 'rgb(155, 89, 182)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'í‰ê·  ì „í™˜ìˆ˜',
                            data: avgConversions,
                            backgroundColor: 'rgba(241, 196, 15, 0.7)',
                            borderColor: 'rgb(241, 196, 15)',
                            borderWidth: 1,
                            yAxisID: 'y2'
                        },
                        {
                            label: 'CVR (%)',
                            data: avgCVR,
                            backgroundColor: 'rgba(230, 126, 34, 0.7)',
                            borderColor: 'rgb(230, 126, 34)',
                            borderWidth: 1,
                            yAxisID: 'y3'
                        },
                        {
                            label: 'CTR (%)',
                            data: avgCTR,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgb(231, 76, 60)',
                            borderWidth: 1,
                            yAxisID: 'y3'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 11 },
                                padding: 10,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    if (label.includes('ROAS')) {
                                        label += value.toFixed(0) + '%';  // Now ROAS is already in percentage
                                    } else if (label.includes('%')) {
                                        label += value.toFixed(1) + '%';
                                    } else if (label.includes('ë§Œì›')) {
                                        label += value.toFixed(0) + 'ë§Œì›';
                                    } else {
                                        label += value.toFixed(1);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ROAS (%)',
                                font: { size: 11, weight: 'bold' }
                            },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ê¸ˆì•¡ (ë§Œì›)',
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                font: { size: 10 }
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ì „í™˜ìˆ˜',
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                font: { size: 10 }
                            }
                        },
                        y3: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ë¹„ìœ¨ (%)',
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });

            console.log('[displayWeekdayHeatmap] Chart rendered with expanded metrics (ROAS, revenue, spend, conversions, CVR, CTR)');
        }

        // Display Campaigns
        function displayCampaigns(campaigns) {
            const tbody = document.getElementById('campaignTableBody');

            if (campaigns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 48px; color: var(--text-secondary);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = campaigns.map((c, index) => {
                // ê´‘ê³ ìœ í˜• í‘œì‹œ
                const adType = c.ad_type || 'sales';
                const adTypeLabel = adType === 'lead' ? 'ì ì¬ê³ ê°' : 'ë§¤ì¶œí˜•';
                const adTypeClass = adType === 'lead' ? 'background: #e3f2fd; color: #1565c0;' : 'background: #e8f5e9; color: #2e7d32;';

                // ì£¼ìš”ì§€í‘œ í‘œì‹œ (ë§¤ì¶œí˜•: ROAS, ì ì¬ê³ ê°: CPL)
                let primaryMetricDisplay;
                if (adType === 'lead') {
                    const cpl = c.cpl || c.cpa || 0;
                    primaryMetricDisplay = `CPL ${cpl.toLocaleString()}ì›`;
                } else {
                    const roas = ((c.roas || 0) * 100).toFixed(0);
                    primaryMetricDisplay = `ROAS ${roas}%`;
                }

                // ì „í™˜ë‹¨ê°€ (CPA ë˜ëŠ” CPL)
                const costPerConversion = c.cpl || c.cpa || 0;
                const costLabel = adType === 'lead' ? 'CPL' : 'CPA';

                const hasMemo = hasCampaignMemo(c.campaign_name);
                const memoButton = `
                    <button
                        onclick="event.stopPropagation(); openCampaignMemoModal('${c.campaign_name.replace(/'/g, "\\'")}')"
                        class="btn btn-secondary"
                        style="padding: 4px 10px; font-size: 12px; ${hasMemo ? 'background: var(--accent-green); color: white;' : ''}"
                        title="${hasMemo ? 'ë©”ëª¨ ìˆìŒ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)' : 'ë©”ëª¨ ì¶”ê°€'}">
                        ${hasMemo ? 'ğŸ“âœ“' : 'ğŸ“'}
                    </button>
                `;

                return `
                    <tr onclick="showCampaignDetail(${index})" style="cursor: pointer;" title="í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°">
                        <td>${c.rank || '-'}</td>
                        <td style="font-weight: 500;">${c.campaign_name}</td>
                        <td><span style="padding: 2px 8px; border-radius: 4px; font-size: 12px; ${adTypeClass}">${adTypeLabel}</span></td>
                        <td><strong>${primaryMetricDisplay}</strong></td>
                        <td>${(c.ctr || 0).toFixed(1)}%</td>
                        <td>${costPerConversion.toLocaleString()}ì›</td>
                        <td>${((c.spend || 0) / 10000).toFixed(0)}ë§Œì›</td>
                        <td>${memoButton}</td>
                    </tr>
                `;
            }).join('');
        }

        // Display Creatives
        function displayCreatives(creatives) {
            console.log('[Creative Analysis] Displaying creatives:', creatives);

            if (!creatives || creatives.length === 0) {
                console.log('[Creative Analysis] No creative data available');
                return;
            }

            // Sort by ROAS for ROAS TOP 10
            const roasTop = [...creatives].sort((a, b) => (b.roas || 0) - (a.roas || 0)).slice(0, 10);

            // Sort by CVR for CVR TOP 10
            const cvrTop = [...creatives].sort((a, b) => (b.cvr || 0) - (a.cvr || 0)).slice(0, 10);

            // Update ROAS TOP 10 Table
            const roasTableBody = document.getElementById('roasTopCreativesTable');
            roasTableBody.innerHTML = roasTop.map((c, index) => `
                <tr>
                    <td style="font-weight: 600;">${index + 1}</td>
                    <td style="font-weight: 500;">${c.ad_creative_name}</td>
                    <td>${c.creative_type || '-'}</td>
                    <td><strong style="color: var(--accent-green);">${((c.roas || 0) * 100).toFixed(0)}%</strong></td>
                    <td>${((c.revenue || 0) / 10000).toFixed(0)}ë§Œ</td>
                    <td>${((c.spend || 0) / 10000).toFixed(0)}ë§Œ</td>
                </tr>
            `).join('');

            // Update CVR TOP 10 Table
            const cvrTableBody = document.getElementById('cvrTopCreativesTable');
            cvrTableBody.innerHTML = cvrTop.map((c, index) => `
                <tr>
                    <td style="font-weight: 600;">${index + 1}</td>
                    <td style="font-weight: 500;">${c.ad_creative_name}</td>
                    <td>${c.creative_type || '-'}</td>
                    <td><strong style="color: var(--primary-blue);">${(c.cvr || 0).toFixed(1)}%</strong></td>
                    <td>${(c.conversions || 0).toLocaleString()}</td>
                    <td>${(c.clicks || 0).toLocaleString()}</td>
                </tr>
            `).join('');

            // Update All Creatives Table
            const allCreativesBody = document.getElementById('allCreativesTable');
            allCreativesBody.innerHTML = creatives.map(c => {
                let statusClass = 'status-excellent';
                let statusText = 'ìš°ìˆ˜';

                if (c.roas < 3.0) {
                    statusClass = 'status-poor';
                    statusText = 'ê°œì„ í•„ìš”';
                } else if (c.roas < 4.0) {
                    statusClass = 'status-good';
                    statusText = 'ë³´í†µ';
                }

                return `
                    <tr>
                        <td style="font-weight: 500;">${c.ad_creative_name}</td>
                        <td>${c.creative_type || '-'}</td>
                        <td>${c.platform || '-'}</td>
                        <td><strong>${((c.roas || 0) * 100).toFixed(0)}%</strong></td>
                        <td>${(c.cvr || 0).toFixed(1)}%</td>
                        <td>${(c.ctr || 0).toFixed(1)}%</td>
                        <td>${(c.cpa || 0).toLocaleString()}ì›</td>
                        <td>${((c.spend || 0) / 10000).toFixed(0)}ë§Œì›</td>
                        <td>${((c.revenue || 0) / 10000).toFixed(0)}ë§Œì›</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');

            console.log('[Creative Analysis] Tables updated successfully');
        }

        // Show no creative data state
        function showNoCreativeDataState() {
            console.log('[Creative Analysis] No creative data - showing campaign fallback');

            // Use campaign data as fallback
            if (!currentCampaignData || currentCampaignData.length === 0) {
                const emptyMessage = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                            â„¹ï¸ ë¶„ì„í•  ìº í˜ì¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                const roasTableBody = document.getElementById('roasTopCreativesTable');
                const cvrTableBody = document.getElementById('cvrTopCreativesTable');
                const allCreativesBody = document.getElementById('allCreativesTable');

                if (roasTableBody) roasTableBody.innerHTML = emptyMessage;
                if (cvrTableBody) cvrTableBody.innerHTML = emptyMessage;
                if (allCreativesBody) allCreativesBody.innerHTML = emptyMessage;
                return;
            }

            // Sort by ROAS (descending) for TOP 10
            const roasTopCampaigns = [...currentCampaignData]
                .sort((a, b) => (b.roas || 0) - (a.roas || 0))
                .slice(0, 10);

            // Sort by CVR (descending) for TOP 10
            const cvrTopCampaigns = [...currentCampaignData]
                .map(c => {
                    const cvr = c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0;
                    return { ...c, cvr };
                })
                .sort((a, b) => b.cvr - a.cvr)
                .slice(0, 10);

            // Display ROAS TOP 10 (í—¤ë”: ìˆœìœ„, ì†Œì¬ëª…, íƒ€ì…, ROAS, ë§¤ì¶œ, ì§€ì¶œ - 6ê°œ)
            const roasTableBody = document.getElementById('roasTopCreativesTable');
            if (roasTableBody) {
                roasTableBody.innerHTML = roasTopCampaigns.map((campaign, idx) => {
                    const roas = (campaign.roas || 0) * 100;
                    const spend = campaign.spend || 0;
                    const revenue = campaign.revenue || 0;
                    const adType = campaign.ad_type || 'sales';
                    const typeStyle = adType === 'lead'
                        ? 'background: #e3f2fd; color: #1565c0;'
                        : 'background: #e8f5e9; color: #2e7d32;';
                    const typeLabel = adType === 'lead' ? 'ë¦¬ë“œ' : 'ë§¤ì¶œ';

                    return `
                        <tr onclick="showCampaignDetail(${currentCampaignData.indexOf(campaign)})" style="cursor: pointer;">
                            <td>${idx + 1}</td>
                            <td>${campaign.campaign_name || 'Unknown'}</td>
                            <td><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; ${typeStyle}">${typeLabel}</span></td>
                            <td><strong style="color: #2ecc71;">${roas.toFixed(0)}%</strong></td>
                            <td>${(revenue / 10000).toFixed(0)}ë§Œ</td>
                            <td>${(spend / 10000).toFixed(0)}ë§Œ</td>
                        </tr>
                    `;
                }).join('');
            }

            // Display CVR TOP 10 (í—¤ë”: ìˆœìœ„, ì†Œì¬ëª…, íƒ€ì…, CVR, ì „í™˜ìˆ˜, í´ë¦­ìˆ˜ - 6ê°œ)
            const cvrTableBody = document.getElementById('cvrTopCreativesTable');
            if (cvrTableBody) {
                cvrTableBody.innerHTML = cvrTopCampaigns.map((campaign, idx) => {
                    const cvr = campaign.cvr || 0;
                    const clicks = campaign.clicks || 0;
                    const conversions = campaign.conversions || 0;
                    const adType = campaign.ad_type || 'sales';
                    const typeStyle = adType === 'lead'
                        ? 'background: #e3f2fd; color: #1565c0;'
                        : 'background: #e8f5e9; color: #2e7d32;';
                    const typeLabel = adType === 'lead' ? 'ë¦¬ë“œ' : 'ë§¤ì¶œ';

                    return `
                        <tr onclick="showCampaignDetail(${currentCampaignData.indexOf(campaign)})" style="cursor: pointer;">
                            <td>${idx + 1}</td>
                            <td>${campaign.campaign_name || 'Unknown'}</td>
                            <td><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; ${typeStyle}">${typeLabel}</span></td>
                            <td><strong style="color: #9b59b6;">${cvr.toFixed(1)}%</strong></td>
                            <td>${conversions}ê±´</td>
                            <td>${clicks}íšŒ</td>
                        </tr>
                    `;
                }).join('');
            }

            // Display All Campaigns (í—¤ë”: ì†Œì¬ëª…, íƒ€ì…, í”Œë«í¼, ROAS, CVR, CTR, CPA, ì „í™˜ìˆ˜, ì§€ì¶œì•¡, ë§¤ì¶œì•¡, ìƒíƒœ - 11ê°œ)
            const allCreativesBody = document.getElementById('allCreativesTable');
            if (allCreativesBody) {
                allCreativesBody.innerHTML = currentCampaignData.map((campaign, idx) => {
                    const roas = (campaign.roas || 0) * 100;
                    const cpa = campaign.cpa || 0;
                    const cvr = campaign.clicks > 0 ? (campaign.conversions / campaign.clicks) * 100 : 0;
                    const ctr = campaign.ctr || 0;
                    const spend = campaign.spend || 0;
                    const revenue = campaign.revenue || 0;
                    const conversions = campaign.conversions || 0;
                    const adType = campaign.ad_type || 'sales';
                    const typeStyle = adType === 'lead'
                        ? 'background: #e3f2fd; color: #1565c0;'
                        : 'background: #e8f5e9; color: #2e7d32;';
                    const typeLabel = adType === 'lead' ? 'ë¦¬ë“œ' : 'ë§¤ì¶œ';

                    // ìƒíƒœ ë°°ì§€ (ad_typeë³„ ë‹¤ë¥¸ ê¸°ì¤€)
                    let statusBadge, statusClass;
                    if (adType === 'lead') {
                        if (cpa > 0 && cpa <= 30000) { statusBadge = 'ìš°ìˆ˜'; statusClass = 'status-excellent'; }
                        else if (cpa <= 50000) { statusBadge = 'ë³´í†µ'; statusClass = 'status-good'; }
                        else { statusBadge = 'ê°œì„ í•„ìš”'; statusClass = 'status-poor'; }
                    } else {
                        const roasVal = campaign.roas || 0;
                        if (roasVal >= 4.0) { statusBadge = 'ìš°ìˆ˜'; statusClass = 'status-excellent'; }
                        else if (roasVal >= 3.0) { statusBadge = 'ë³´í†µ'; statusClass = 'status-good'; }
                        else { statusBadge = 'ê°œì„ í•„ìš”'; statusClass = 'status-poor'; }
                    }

                    return `
                        <tr onclick="showCampaignDetail(${idx})" style="cursor: pointer;">
                            <td style="font-weight: 500;">${campaign.campaign_name || 'Unknown'}</td>
                            <td><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; ${typeStyle}">${typeLabel}</span></td>
                            <td>-</td>
                            <td><strong>${roas.toFixed(0)}%</strong></td>
                            <td>${cvr.toFixed(1)}%</td>
                            <td>${ctr.toFixed(1)}%</td>
                            <td>${cpa.toLocaleString()}ì›</td>
                            <td>${conversions.toLocaleString()}ê±´</td>
                            <td>${(spend / 10000).toFixed(0)}ë§Œì›</td>
                            <td>${(revenue / 10000).toFixed(0)}ë§Œì›</td>
                            <td><span class="status-badge ${statusClass}">${statusBadge}</span></td>
                        </tr>
                    `;
                }).join('');
            }

            console.log('[Creative Analysis] Campaign fallback displayed:', {
                roasTop: roasTopCampaigns.length,
                cvrTop: cvrTopCampaigns.length,
                all: currentCampaignData.length
            });
        }

        // Campaign Detail Modal
        function showCampaignDetail(index) {
            const campaign = currentCampaignData[index];
            if (!campaign) return;

            const adType = campaign.ad_type || 'sales';
            const cpa = campaign.cpa || 0;
            const cvr = campaign.clicks > 0 ? ((campaign.conversions / campaign.clicks) * 100).toFixed(1) : 0;

            // Determine background color based on ad_type and performance
            let bgColor;
            if (adType === 'lead') {
                bgColor = cpa <= 30000 ? '#e8f5e9' : cpa > 50000 ? '#ffebee' : '#fff3e0';
            } else {
                bgColor = campaign.roas >= 4.0 ? '#e8f5e9' : campaign.roas < 3.0 ? '#ffebee' : '#fff3e0';
            }

            const modalContent = `
                <div class="modal-content" style="max-width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: var(--text-primary);"><img src="/static/img/icons/target.svg" alt="" style="width:20px;height:20px;vertical-align:middle;"> ${campaign.campaign_name}</h2>
                        <button class="btn btn-secondary" onclick="closeCampaignDetailModal()">âœ• ë‹«ê¸°</button>
                    </div>

                    <div class="summary-grid" style="margin-bottom: 24px;">
                        ${adType === 'lead' ? `
                            <!-- Lead campaign metrics -->
                            <div class="summary-card highlight-blue">
                                <div class="summary-label">CPA (ì „í™˜ë‹¹ë¹„ìš©)</div>
                                <div class="summary-value">${(cpa / 1000).toFixed(0)}</div>
                                <div class="summary-unit">ì²œì›</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">ì§€ì¶œì•¡</div>
                                <div class="summary-value">${((campaign.spend || 0) / 10000).toFixed(0)}</div>
                                <div class="summary-unit">ë§Œì›</div>
                            </div>
                            <div class="summary-card highlight-green">
                                <div class="summary-label">ì „í™˜ìˆ˜</div>
                                <div class="summary-value">${(campaign.conversions || 0).toLocaleString()}</div>
                                <div class="summary-unit">ê±´</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">ì „í™˜ìœ¨</div>
                                <div class="summary-value">${cvr}</div>
                                <div class="summary-unit">%</div>
                            </div>
                        ` : `
                            <!-- Sales campaign metrics -->
                            <div class="summary-card highlight-blue">
                                <div class="summary-label">ROAS</div>
                                <div class="summary-value">${((campaign.roas || 0) * 100).toFixed(0)}</div>
                                <div class="summary-unit">%</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">ì§€ì¶œì•¡</div>
                                <div class="summary-value">${((campaign.spend || 0) / 10000).toFixed(0)}</div>
                                <div class="summary-unit">ë§Œì›</div>
                            </div>
                            <div class="summary-card highlight-green">
                                <div class="summary-label">ë§¤ì¶œì•¡</div>
                                <div class="summary-value">${((campaign.revenue || 0) / 10000).toFixed(0)}</div>
                                <div class="summary-unit">ë§Œì›</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">ì „í™˜ìˆ˜</div>
                                <div class="summary-value">${(campaign.conversions || 0).toLocaleString()}</div>
                                <div class="summary-unit">ê±´</div>
                            </div>
                        `}
                    </div>

                    <div class="card" style="background: ${bgColor}; padding: 20px;">
                        <h3 style="margin-bottom: 12px; font-size: 16px;"><img src="/static/img/icons/lightbulb.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> AI ê¶Œì¥ì‚¬í•­</h3>
                        <p style="margin: 0; line-height: 1.6;">
                            ${getCampaignRecommendation(campaign)}
                        </p>
                    </div>
                </div>
            `;

            const modalDiv = document.getElementById('campaignDetailModal');
            modalDiv.innerHTML = modalContent;
            modalDiv.classList.remove('hidden');
        }

        function getCampaignRecommendation(campaign) {
            const adType = campaign.ad_type || 'sales';
            const roas = campaign.roas || 0;
            const roasPercent = (roas * 100).toFixed(0);
            const ctr = campaign.ctr || 0;
            const cvr = ((campaign.conversions || 0) / (campaign.clicks || 1)) * 100;
            const cpa = campaign.cpa || 0;

            // Different logic for lead vs sales campaigns
            if (adType === 'lead') {
                // Lead campaign - judge by CPA and CVR
                if (cpa > 0 && cpa <= 30000) {
                    return `âœ… <strong>ìš°ìˆ˜í•œ ì„±ê³¼!</strong> ì „í™˜ë‹¹ ë¹„ìš© ${cpa.toLocaleString()}ì›ìœ¼ë¡œ ëª©í‘œ ë‹¬ì„± ì¤‘ì…ë‹ˆë‹¤. ì „í™˜ìœ¨ ${cvr.toFixed(1)}%ë¥¼ ìœ ì§€í•˜ë©° ì˜ˆì‚° í™•ëŒ€ë¥¼ ê³ ë ¤í•˜ì„¸ìš”.`;
                } else if (cpa > 30000 && cpa <= 50000) {
                    if (cvr < 2.0) {
                        return `âš ï¸ ì „í™˜ìœ¨ ${cvr.toFixed(1)}%ë¡œ ë‚®ìŠµë‹ˆë‹¤. ëœë”©í˜ì´ì§€ ê°œì„  ë˜ëŠ” íƒ€ê²ŸíŒ… ì¡°ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`;
                    } else {
                        return `âœ… ì–‘í˜¸í•œ ì„±ê³¼ì…ë‹ˆë‹¤. ì „í™˜ë‹¹ ${cpa.toLocaleString()}ì›ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.`;
                    }
                } else if (cpa > 50000) {
                    return `âŒ ì „í™˜ë‹¹ ë¹„ìš© ${cpa.toLocaleString()}ì›ìœ¼ë¡œ ëª©í‘œ ëŒ€ë¹„ ë†’ìŠµë‹ˆë‹¤. íƒ€ê²ŸíŒ… ì¬ê²€í†  ë˜ëŠ” ê´‘ê³  ì†Œì¬ ë³€ê²½ì„ ê³ ë ¤í•˜ì„¸ìš”.`;
                } else {
                    return `âš ï¸ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¶©ë¶„í•œ ì „í™˜ ë°ì´í„° ìˆ˜ì§‘ í›„ ì¬í‰ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤.`;
                }
            } else {
                // Sales campaign - judge by ROAS
                if (roas >= 4.0) {
                    return `âœ… <strong>ìš°ìˆ˜í•œ ì„±ê³¼!</strong> ROAS ${roasPercent}%ë¡œ ëª©í‘œ ì´ˆê³¼ë‹¬ì„± ì¤‘ì…ë‹ˆë‹¤. ì˜ˆì‚°ì„ ëŠ˜ë ¤ ë” ë§ì€ ìˆ˜ìµì„ ì°½ì¶œí•˜ì„¸ìš”.`;
                } else if (roas >= 3.0) {
                    if (ctr < 2.0) {
                        return `âš ï¸ í´ë¦­ë¥  ${ctr.toFixed(1)}%ë¡œ ë‚®ìŠµë‹ˆë‹¤. ê´‘ê³  ì†Œì¬ ê°œì„  ë˜ëŠ” íƒ€ê²ŸíŒ… ì¡°ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`;
                    } else {
                        return `âœ… ì–‘í˜¸í•œ ì„±ê³¼ì…ë‹ˆë‹¤. ROAS ${roasPercent}%ë¥¼ ìœ ì§€í•˜ë©° ì˜ˆì‚° í™•ëŒ€ë¥¼ ê³ ë ¤í•˜ì„¸ìš”.`;
                    }
                } else {
                    return `âŒ ROAS ${roasPercent}%ë¡œ ëª©í‘œ ë¯¸ë‹¬ì…ë‹ˆë‹¤. ìº í˜ì¸ ì „ë©´ ì¬ê²€í†  ë˜ëŠ” ì¼ì‹œ ì¤‘ì§€ë¥¼ ê³ ë ¤í•˜ì„¸ìš”.`;
                }
            }
        }

        function closeCampaignDetailModal() {
            document.getElementById('campaignDetailModal').classList.add('hidden');
        }
        // Manual Input Modal - closeManualInputModal is already defined above

        // REMOVED: Duplicate function addManualDataRow() - use addManualData() instead which includes ad_type

        function updateManualDataPreview() {
            const count = document.getElementById('manualDataCount');
            const preview = document.getElementById('manualDataPreview');

            count.textContent = manualDataBuffer.length;

            if (manualDataBuffer.length > 0) {
                const last = manualDataBuffer[manualDataBuffer.length - 1];
                preview.innerHTML = `
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        <strong>ë§ˆì§€ë§‰ ì…ë ¥:</strong><br>
                        ${last.date} | ${last.campaign_name} | ì§€ì¶œ: ${last.spend.toLocaleString()}ì› | í´ë¦­: ${last.clicks}
                    </div>
                `;
            } else {
                preview.innerHTML = '';
            }
        }

        async function submitManualData() {
            if (manualDataBuffer.length === 0) {
                alert('ì…ë ¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');

            try {
                const response = await fetch('/api/ad-analysis/manual-input', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        snapshot_name: `ìˆ˜ê¸°ì…ë ¥ ${new Date().toLocaleDateString()}`,
                        data: manualDataBuffer
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('[DEBUG] Manual input successful, processing data...');
                    console.log('[DEBUG] Result metrics:', result.metrics);
                    console.log('[DEBUG] Result daily_data:', result.metrics.daily_data);
                    console.log('[DEBUG] Result daily_trend:', result.metrics.daily_trend);

                    // Save new daily data to localStorage and merge with existing
                    // campaign_name í¬í•¨ëœ daily_data ìš°ì„  ì‚¬ìš© (ì—†ìœ¼ë©´ daily_trendë¡œ í´ë°±)
                    const newDailyData = result.metrics.daily_data || result.metrics.daily_trend || [];
                    console.log('[DEBUG] Using daily_data with campaign names:', newDailyData.length, 'rows');
                    console.log('[DEBUG] newDailyData:', newDailyData);

                    const mergedDailyData = saveToLocalStorage(newDailyData);
                    console.log('[DEBUG] Merged data count:', mergedDailyData.length);
                    console.log('[DEBUG] mergedDailyData:', mergedDailyData);

                    // Recalculate metrics from accumulated data
                    const accumulatedMetrics = recalculateMetrics(mergedDailyData);
                    console.log('[DEBUG] Accumulated metrics:', accumulatedMetrics);

                    // Only proceed if we have valid metrics
                    if (!accumulatedMetrics) {
                        console.error('[DEBUG] ERROR: accumulatedMetrics is null/undefined!');
                        alert('ë°ì´í„° ê³„ì‚° ì˜¤ë¥˜ ë°œìƒ');
                        loadingOverlay.classList.add('hidden');
                        return;
                    }

                    // Update data summary badge
                    updateDataSummaryBadge();

                    alert(`âœ… ì—…ë¡œë“œ ì™„ë£Œ! (${manualDataBuffer.length}ê±´) ëˆ„ì  ë°ì´í„°: ${mergedDailyData.length}í–‰`);
                    closeManualInputModal();

                    // Switch to overview FIRST
                    const overviewBtn2 = document.querySelector('[data-page="overview"]');
                    if (overviewBtn2) {
                        overviewBtn2.click();
                        // Wait for tab transition, then display data
                        setTimeout(() => {
                            console.log('[DEBUG] Displaying metrics after tab switch...');
                            displayMetrics(accumulatedMetrics);
                            displayChart(accumulatedMetrics.daily_trend);
                            displayCampaigns(accumulatedMetrics.campaigns);
                        }, 100);
                    } else {
                        // No overview button, display immediately
                        displayMetrics(accumulatedMetrics);
                        displayChart(accumulatedMetrics.daily_trend);
                        displayCampaigns(accumulatedMetrics.campaigns);

                        // í•µì‹¬ë¶„ì„ ì„¹ì…˜ ì—…ë°ì´íŠ¸
                        if (accumulatedMetrics.creatives && accumulatedMetrics.creatives.length > 0) {
                            displayCreatives(accumulatedMetrics.creatives);
                        } else {
                            showNoCreativeDataState();
                        }
                    }
                } else {
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Manual input error:', error);
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Date Filtering Functions
        function applyDateFilter(filterType) {
            currentDateFilter = filterType;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-filter="${filterType}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // í•­ìƒ localStorageì—ì„œ ì›ë³¸ ë°ì´í„° ë¡œë“œ (ê°€ì¥ ì•ˆì •ì )
            const originalData = loadFromLocalStorage();
            if (!originalData || originalData.length === 0) {
                alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            let filteredData = [];

            // ë¡œì»¬ ë‚ ì§œë¥¼ UTC ë³€í™˜ ì—†ì´ ì§ì ‘ ìƒì„± (íƒ€ì„ì¡´ ë¬¸ì œ í•´ê²°)
            const today = new Date();
            const todayStr = today.getFullYear() + '-' +
                             String(today.getMonth() + 1).padStart(2, '0') + '-' +
                             String(today.getDate()).padStart(2, '0');

            console.log('[applyDateFilter] Today (local):', todayStr);

            switch(filterType) {
                case 'all':
                    filteredData = originalData;
                    document.getElementById('currentDateRange').textContent = 'í˜„ì¬ ê¸°ê°„: ì „ì²´ ë°ì´í„°';
                    console.log('[applyDateFilter] All data:', originalData.length, 'records');
                    break;

                case 'today':
                    filteredData = originalData.filter(d => d.date === todayStr);
                    document.getElementById('currentDateRange').textContent = `í˜„ì¬ ê¸°ê°„: ${todayStr}`;
                    console.log('[applyDateFilter] Today filter:', todayStr, '-> found', filteredData.length, 'records');
                    break;

                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 6);  // 7ì¼ = ì˜¤ëŠ˜ í¬í•¨ 6ì¼ ì „
                    const weekAgoStr = weekAgo.getFullYear() + '-' +
                                       String(weekAgo.getMonth() + 1).padStart(2, '0') + '-' +
                                       String(weekAgo.getDate()).padStart(2, '0');
                    // ìƒí•œì„  ì¶”ê°€: ì˜¤ëŠ˜ê¹Œì§€ë§Œ í¬í•¨
                    filteredData = originalData.filter(d => d.date >= weekAgoStr && d.date <= todayStr);
                    document.getElementById('currentDateRange').textContent = `í˜„ì¬ ê¸°ê°„: ${weekAgoStr} ~ ${todayStr}`;
                    console.log('[applyDateFilter] Week filter:', weekAgoStr, '~', todayStr, '-> found', filteredData.length, 'records');
                    break;

                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setDate(today.getDate() - 29);  // 30ì¼ = ì˜¤ëŠ˜ í¬í•¨ 29ì¼ ì „
                    const monthAgoStr = monthAgo.getFullYear() + '-' +
                                        String(monthAgo.getMonth() + 1).padStart(2, '0') + '-' +
                                        String(monthAgo.getDate()).padStart(2, '0');
                    // ìƒí•œì„  ì¶”ê°€: ì˜¤ëŠ˜ê¹Œì§€ë§Œ í¬í•¨
                    filteredData = originalData.filter(d => d.date >= monthAgoStr && d.date <= todayStr);
                    document.getElementById('currentDateRange').textContent = `í˜„ì¬ ê¸°ê°„: ${monthAgoStr} ~ ${todayStr}`;
                    console.log('[applyDateFilter] Month filter:', monthAgoStr, '~', todayStr, '-> found', filteredData.length, 'records');
                    break;
            }

            // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            currentDailyData = filteredData;
            originalDailyData = originalData;

            // ëª¨ë“  ì‹œê°í™” ê°±ì‹ 
            if (filteredData.length > 0) {
                recalculateMetricsForPeriod(filteredData);
            } else {
                alert('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        function applyCustomDateRange() {
            const startDate = document.getElementById('dateStart').value;
            const endDate = document.getElementById('dateEnd').value;

            if (!startDate || !endDate) {
                alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            if (startDate > endDate) {
                alert('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤');
                return;
            }

            currentDateFilter = 'custom';
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const customBtn = document.querySelector('[data-filter="custom"]');
            if (customBtn) customBtn.classList.add('active');

            // í•µì‹¬ ìˆ˜ì •: í•­ìƒ localStorageì—ì„œ ì›ë³¸ ë°ì´í„° ë¡œë“œ
            const originalData = loadFromLocalStorage();
            if (!originalData || originalData.length === 0) {
                alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            const filteredData = originalData.filter(d => d.date >= startDate && d.date <= endDate);
            document.getElementById('currentDateRange').textContent = `í˜„ì¬ ê¸°ê°„: ${startDate} ~ ${endDate}`;

            // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            currentDailyData = filteredData;
            originalDailyData = originalData;

            if (filteredData.length > 0) {
                recalculateMetricsForPeriod(filteredData);
            } else {
                alert('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        function recalculateMetricsForPeriod(filteredData) {
            if (!filteredData || filteredData.length === 0) {
                alert('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');

                // UI ì´ˆê¸°í™” - 0 ê°’ìœ¼ë¡œ í‘œì‹œ
                const emptyMetrics = {
                    total_spend: 0,
                    total_revenue: 0,
                    total_clicks: 0,
                    total_conversions: 0,
                    total_impressions: 0,
                    avg_roas: 0,
                    avg_ctr: 0,
                    avg_cpa: 0,
                    cvr: 0,
                    daily_trend: [],
                    campaigns: []
                };
                displayMetrics(emptyMetrics);
                displayCampaigns([]);

                // ì°¨íŠ¸ ì´ˆê¸°í™”
                if (typeof trendChart !== 'undefined' && trendChart) {
                    trendChart.destroy();
                    trendChart = null;
                }
                if (typeof roasDistChart !== 'undefined' && roasDistChart) {
                    roasDistChart.destroy();
                    roasDistChart = null;
                }
                if (typeof budgetPieChart !== 'undefined' && budgetPieChart) {
                    budgetPieChart.destroy();
                    budgetPieChart = null;
                }
                return;
            }

            // Calculate totals from filtered daily data
            const total_spend = filteredData.reduce((sum, d) => sum + (d.spend || 0), 0);
            const total_revenue = filteredData.reduce((sum, d) => sum + (d.revenue || 0), 0);
            const total_clicks = filteredData.reduce((sum, d) => sum + (d.clicks || 0), 0);
            const total_conversions = filteredData.reduce((sum, d) => sum + (d.conversions || 0), 0);
            const total_impressions = filteredData.reduce((sum, d) => sum + (d.impressions || 0), 0);

            // Recalculate campaign metrics from filtered data
            const filteredCampaigns = calculateCampaignMetricsFromDaily(filteredData);

            const metrics = {
                total_spend,
                total_revenue,
                total_clicks,
                total_conversions,
                total_impressions,
                avg_roas: total_spend > 0 ? (total_revenue / total_spend) : 0,
                avg_ctr: total_impressions > 0 ? ((total_clicks / total_impressions) * 100) : 0,
                avg_cpa: total_conversions > 0 ? (total_spend / total_conversions) : 0,
                cvr: total_clicks > 0 ? ((total_conversions / total_clicks) * 100) : 0,
                daily_trend: filteredData,
                campaigns: filteredCampaigns
            };

            // Update all visualizations
            displayMetrics(metrics);
            displayChart(filteredData);
            displayROASDistribution(filteredCampaigns);
            displayBudgetPieChart(filteredCampaigns);
            displayConversionFunnel(metrics);
            displayCampaignComparison(filteredCampaigns);
            displayWeekdayHeatmap(filteredData);
            displayCampaigns(filteredCampaigns);
        }

        // Helper function to calculate campaign metrics from daily data
        function calculateCampaignMetricsFromDaily(dailyData) {
            const campaignMap = {};

            // Group by campaign
            dailyData.forEach(d => {
                const name = d.campaign_name;
                if (!campaignMap[name]) {
                    campaignMap[name] = {
                        campaign_name: name,
                        ad_type: d.ad_type || 'sales',
                        spend: 0,
                        revenue: 0,
                        clicks: 0,
                        conversions: 0,
                        impressions: 0
                    };
                }
                campaignMap[name].spend += (d.spend || 0);
                campaignMap[name].revenue += (d.revenue || 0);
                campaignMap[name].clicks += (d.clicks || 0);
                campaignMap[name].conversions += (d.conversions || 0);
                campaignMap[name].impressions += (d.impressions || 0);
            });

            // Calculate derived metrics
            return Object.values(campaignMap).map(c => {
                c.roas = c.spend > 0 ? (c.revenue / c.spend) : 0;
                c.ctr = c.impressions > 0 ? ((c.clicks / c.impressions) * 100) : 0;
                c.cpa = c.conversions > 0 ? (c.spend / c.conversions) : 0;
                c.cvr = c.clicks > 0 ? ((c.conversions / c.clicks) * 100) : 0;
                c.status = getStatusFromMetrics(c);
                return c;
            }).sort((a, b) => b.roas - a.roas); // Sort by ROAS descending
        }

        function openCustomDateModal() {
            // Just focus on date inputs
            document.getElementById('dateStart').focus();
        }

        // ========================================
        // Phase 2.1: Saved Analyses Feature
        // ========================================

        let currentAnalysisId = null; // Track current analysis being edited in memo modal

        // Open Save Analysis Modal
        function openSaveAnalysisModal() {
            const accumulatedData = localStorage.getItem(STORAGE_KEY);

            if (!accumulatedData || JSON.parse(accumulatedData).length === 0) {
                alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            document.getElementById('saveAnalysisModal').classList.remove('hidden');
            document.getElementById('saveAnalysisName').value = '';
            document.getElementById('saveAnalysisNotes').value = '';
        }

        // Close Save Analysis Modal
        function closeSaveAnalysisModal() {
            document.getElementById('saveAnalysisModal').classList.add('hidden');
        }

        // Confirm Save Analysis
        function confirmSaveAnalysis() {
            const name = document.getElementById('saveAnalysisName').value.trim();
            const notes = document.getElementById('saveAnalysisNotes').value.trim();

            if (!name) {
                alert('ë¶„ì„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const accumulatedData = localStorage.getItem(STORAGE_KEY);
            if (!accumulatedData) {
                alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const data = JSON.parse(accumulatedData);
            const timestamp = new Date().getTime();
            const analysisKey = `saved_analysis_${timestamp}`;

            const savedAnalysis = {
                name: name,
                notes: notes,
                timestamp: timestamp,
                saveDate: new Date().toISOString(),
                data: data,
                rowCount: data.length
            };

            localStorage.setItem(analysisKey, JSON.stringify(savedAnalysis));

            alert('âœ… ë¶„ì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeSaveAnalysisModal();
            loadSavedAnalysesList();
        }

        // Load Saved Analyses List
        function loadSavedAnalysesList() {
            const listContainer = document.getElementById('savedAnalysesList');
            const savedAnalyses = [];

            // Get all saved analyses from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('saved_analysis_')) {
                    const data = JSON.parse(localStorage.getItem(key));
                    data.key = key;
                    savedAnalyses.push(data);
                }
            }

            // Sort by timestamp descending (newest first)
            savedAnalyses.sort((a, b) => b.timestamp - a.timestamp);

            if (savedAnalyses.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                        ì €ì¥ëœ ë¶„ì„ì´ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ë¶„ì„ì„ ì €ì¥í•˜ë ¤ë©´ ìƒë‹¨ì˜ 'ì €ì¥' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = savedAnalyses.map(analysis => `
                <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;"
                     onmouseover="this.style.background='var(--bg-hover)'"
                     onmouseout="this.style.background='white'">
                    <div style="flex: 1;">
                        <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 6px;">${analysis.name}</h4>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
                            ì €ì¥ì¼ì‹œ: ${new Date(analysis.saveDate).toLocaleString('ko-KR')}
                        </p>
                        <p style="font-size: 13px; color: var(--text-secondary);">
                            ë°ì´í„° ìˆ˜: ${analysis.rowCount.toLocaleString()}ê±´
                        </p>
                        ${analysis.notes ? `<p style="font-size: 13px; color: var(--text-tertiary); margin-top: 6px; font-style: italic;">ë©”ëª¨: ${analysis.notes}</p>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="loadSavedAnalysis('${analysis.key}')" style="padding: 6px 12px; font-size: 13px;">
                            ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        <button class="btn btn-secondary" onclick="deleteSavedAnalysis('${analysis.key}')" style="padding: 6px 12px; font-size: 13px; background: var(--accent-red); color: white;">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load Saved Analysis
        function loadSavedAnalysis(key) {
            if (!confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ì €ì¥ëœ ë¶„ì„ìœ¼ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            const savedAnalysis = JSON.parse(localStorage.getItem(key));
            if (!savedAnalysis) {
                alert('ë¶„ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Replace current accumulated data
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedAnalysis.data));

            // Recalculate and refresh displays
            const metrics = calculateMetrics(savedAnalysis.data);
            displayAllData(metrics, savedAnalysis.data);

            alert(`âœ… "${savedAnalysis.name}" ë¶„ì„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Delete Saved Analysis
        function deleteSavedAnalysis(key) {
            const savedAnalysis = JSON.parse(localStorage.getItem(key));

            if (!confirm(`"${savedAnalysis.name}" ë¶„ì„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            localStorage.removeItem(key);
            alert('âœ… ë¶„ì„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadSavedAnalysesList();
        }

        // ========================================
        // Phase 2.2: Period Comparison Feature
        // ========================================

        function comparePeriods() {
            const periodAStart = document.getElementById('periodAStart').value;
            const periodAEnd = document.getElementById('periodAEnd').value;
            const periodBStart = document.getElementById('periodBStart').value;
            const periodBEnd = document.getElementById('periodBEnd').value;

            if (!periodAStart || !periodAEnd || !periodBStart || !periodBEnd) {
                alert('ëª¨ë“  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const accumulatedData = localStorage.getItem(STORAGE_KEY);
            if (!accumulatedData) {
                alert('ë¹„êµí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const allData = JSON.parse(accumulatedData);

            // Filter data for each period
            const periodAData = allData.filter(row => {
                const date = row.date;
                return date >= periodAStart && date <= periodAEnd;
            });

            const periodBData = allData.filter(row => {
                const date = row.date;
                return date >= periodBStart && date <= periodBEnd;
            });

            if (periodAData.length === 0 || periodBData.length === 0) {
                alert('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Calculate metrics for each period
            const metricsA = calculateMetrics(periodAData);
            const metricsB = calculateMetrics(periodBData);

            // Display comparison
            displayPeriodComparison(metricsA, metricsB);
        }

        function displayPeriodComparison(metricsA, metricsB) {
            const tbody = document.getElementById('comparisonTableBody');
            const resultDiv = document.getElementById('comparisonResult');

            const metrics = [
                { key: 'avg_roas', label: 'ROAS', format: (v) => v.toFixed(2), better: 'higher' },
                { key: 'avg_ctr', label: 'CTR (%)', format: (v) => v.toFixed(2), better: 'higher' },
                { key: 'avg_cpa', label: 'CPA (ì›)', format: (v) => v.toLocaleString(), better: 'lower' },
                { key: 'cvr', label: 'ì „í™˜ìœ¨ (%)', format: (v) => v.toFixed(2), better: 'higher' },
                { key: 'total_spend', label: 'ì´ ì§€ì¶œ (ì›)', format: (v) => v.toLocaleString(), better: 'lower' },
                { key: 'total_revenue', label: 'ì´ ë§¤ì¶œ (ì›)', format: (v) => v.toLocaleString(), better: 'higher' }
            ];

            tbody.innerHTML = metrics.map(metric => {
                const valueA = metricsA[metric.key] || 0;
                const valueB = metricsB[metric.key] || 0;
                const change = valueB !== 0 ? ((valueA - valueB) / valueB * 100) : 0;

                let trendIcon = '';
                let trendColor = '';

                if (Math.abs(change) < 0.1) {
                    trendIcon = 'â¡ï¸';
                    trendColor = 'var(--text-secondary)';
                } else if (change > 0) {
                    if (metric.better === 'higher') {
                        trendIcon = 'ğŸ“ˆ';
                        trendColor = 'var(--accent-green)';
                    } else {
                        trendIcon = 'ğŸ“‰';
                        trendColor = 'var(--accent-red)';
                    }
                } else {
                    if (metric.better === 'higher') {
                        trendIcon = 'ğŸ“‰';
                        trendColor = 'var(--accent-red)';
                    } else {
                        trendIcon = 'ğŸ“ˆ';
                        trendColor = 'var(--accent-green)';
                    }
                }

                return `
                    <tr>
                        <td style="font-weight: 500;">${metric.label}</td>
                        <td>${metric.format(valueA)}</td>
                        <td>${metric.format(valueB)}</td>
                        <td style="color: ${trendColor}; font-weight: 600;">${change.toFixed(1)}%</td>
                        <td style="font-size: 18px;">${trendIcon}</td>
                    </tr>
                `;
            }).join('');

            resultDiv.classList.remove('hidden');

            // Scroll to results
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ========================================
        // Phase 3.1: Goal Management
        // ========================================

        function saveGoal() {
            const month = document.getElementById('goalMonth').value;
            const budget = parseFloat(document.getElementById('goalBudget').value);
            const targetRoas = parseFloat(document.getElementById('goalRoas').value);

            if (!month || !budget || !targetRoas) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const goalKey = `monthly_goal_${month}`;
            const goalData = {
                month: month,
                budget: budget,
                targetRoas: targetRoas,
                savedAt: new Date().toISOString()
            };

            localStorage.setItem(goalKey, JSON.stringify(goalData));
            alert('âœ… ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

            // Display budget pacing
            displayBudgetPacing(month);
        }

        function displayBudgetPacing(month) {
            const goalKey = `monthly_goal_${month}`;
            const goalData = localStorage.getItem(goalKey);

            if (!goalData) {
                alert('í•´ë‹¹ ì›”ì˜ ëª©í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const goal = JSON.parse(goalData);
            const accumulatedData = localStorage.getItem(STORAGE_KEY);

            if (!accumulatedData) {
                alert('ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const allData = JSON.parse(accumulatedData);

            // Filter data for the target month
            const monthData = allData.filter(row => row.date.startsWith(month));

            if (monthData.length === 0) {
                alert('í•´ë‹¹ ì›”ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const metrics = calculateMetrics(monthData);
            const spent = metrics.total_spend;
            const budget = goal.budget;

            // Calculate progress
            const spentRate = (spent / budget * 100).toFixed(1);

            // Calculate days progress
            const [year, monthNum] = month.split('-').map(Number);
            const today = new Date();
            const daysInMonth = new Date(year, monthNum, 0).getDate();

            let daysProgress;
            if (today.getFullYear() === year && today.getMonth() + 1 === monthNum) {
                daysProgress = (today.getDate() / daysInMonth * 100).toFixed(1);
            } else {
                daysProgress = 100; // Past month
            }

            // Determine status
            let status, statusColor, suggestion;

            if (spentRate > daysProgress * 1.1) {
                status = 'FAST (ë¹ ë¦„)';
                statusColor = 'var(--accent-red)';
                suggestion = 'ì˜ˆì‚° ì†Œì§„ ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤. ì¼ì¼ ì˜ˆì‚°ì„ ì¡°ì •í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.';
            } else if (spentRate < daysProgress * 0.9) {
                status = 'SLOW (ëŠë¦¼)';
                statusColor = 'var(--accent-orange)';
                suggestion = 'ì˜ˆì‚° ì†Œì§„ì´ ëŠë¦½ë‹ˆë‹¤. ê´‘ê³  ë…¸ì¶œì„ ëŠ˜ë¦¬ëŠ” ê²ƒì„ ê³ ë ¤í•˜ì„¸ìš”.';
            } else {
                status = 'ON_TRACK (ì •ìƒ)';
                statusColor = 'var(--accent-green)';
                suggestion = 'ì˜ˆì‚°ì´ ì •ìƒì ìœ¼ë¡œ ì†Œì§„ë˜ê³  ìˆìŠµë‹ˆë‹¤.';
            }

            // Display
            const contentDiv = document.getElementById('budgetPacingContent');
            contentDiv.innerHTML = `
                <div style="background: var(--bg-hover); padding: 20px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">ì›” ì˜ˆì‚°</p>
                            <p style="font-size: 20px; font-weight: 600;">${budget.toLocaleString()}ì›</p>
                        </div>
                        <div>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">ì‚¬ìš©ì•¡</p>
                            <p style="font-size: 20px; font-weight: 600;">${spent.toLocaleString()}ì› (${spentRate}%)</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">ì˜ˆì‚° ì†Œì§„ìœ¨</p>
                        <div style="background: #e0e0e0; height: 24px; border-radius: 12px; overflow: hidden;">
                            <div style="width: ${Math.min(spentRate, 100)}%; height: 100%; background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue)); transition: width 0.5s;"></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">ì¼ì • ì§„í–‰ë¥ </p>
                        <div style="background: #e0e0e0; height: 24px; border-radius: 12px; overflow: hidden;">
                            <div style="width: ${daysProgress}%; height: 100%; background: linear-gradient(90deg, #95a5a6, #7f8c8d); transition: width 0.5s;"></div>
                        </div>
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor};">
                        <p style="font-size: 14px; font-weight: 600; color: ${statusColor}; margin-bottom: 8px;">
                            ìƒíƒœ: ${status}
                        </p>
                        <p style="font-size: 13px; color: var(--text-secondary);">
                            ${suggestion}
                        </p>
                    </div>

                    <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: white; padding: 12px; border-radius: 6px;">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">ëª©í‘œ ROAS</p>
                            <p style="font-size: 18px; font-weight: 600;">${goal.targetRoas.toFixed(1)}</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px;">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">í˜„ì¬ ROAS</p>
                            <p style="font-size: 18px; font-weight: 600; color: ${metrics.avg_roas >= goal.targetRoas ? 'var(--accent-green)' : 'var(--accent-orange)'}">
                                ${metrics.avg_roas.toFixed(2)}
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('budgetPacingResult').classList.remove('hidden');

            // Scroll to results
            document.getElementById('budgetPacingResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Auto-load budget pacing when goal month changes
        document.addEventListener('DOMContentLoaded', function() {
            const goalMonthInput = document.getElementById('goalMonth');
            if (goalMonthInput) {
                goalMonthInput.addEventListener('change', function() {
                    const month = this.value;
                    const goalKey = `monthly_goal_${month}`;
                    const goalData = localStorage.getItem(goalKey);

                    if (goalData) {
                        const goal = JSON.parse(goalData);
                        document.getElementById('goalBudget').value = goal.budget;
                        document.getElementById('goalRoas').value = goal.targetRoas;
                        displayBudgetPacing(month);
                    }
                });
            }

            // ë‚ ì§œ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ê¸°ê°„ ì„ íƒ ìë™ ì ìš©)
            const dateStartInput = document.getElementById('dateStart');
            const dateEndInput = document.getElementById('dateEnd');

            if (dateStartInput) {
                dateStartInput.addEventListener('change', function() {
                    const endDate = document.getElementById('dateEnd').value;
                    if (this.value && endDate) {
                        applyCustomDateRange();
                    }
                });
            }

            if (dateEndInput) {
                dateEndInput.addEventListener('change', function() {
                    const startDate = document.getElementById('dateStart').value;
                    if (startDate && this.value) {
                        applyCustomDateRange();
                    }
                });
            }

            // Load saved analyses list on page load
            loadSavedAnalysesList();

            // Set current month as default
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            if (goalMonthInput) {
                goalMonthInput.value = currentMonth;
            }
        });

        // ========================================
        // Phase 3.2: Campaign Memo Feature
        // ========================================

        let currentCampaignName = null;

        // Open Campaign Memo Modal
        function openCampaignMemoModal(campaignName) {
            currentCampaignName = campaignName;
            document.getElementById('memoModalTitle').textContent = `ğŸ“ ${campaignName} ë©”ëª¨`;

            // Load existing memo
            const memoKey = `campaign_memo_${campaignName}`;
            const existingMemo = localStorage.getItem(memoKey) || '';
            document.getElementById('campaignMemoText').value = existingMemo;

            document.getElementById('campaignMemoModal').classList.remove('hidden');
        }

        // Close Campaign Memo Modal
        function closeCampaignMemoModal() {
            document.getElementById('campaignMemoModal').classList.add('hidden');
            currentCampaignName = null;
        }

        // Save Campaign Memo
        function saveCampaignMemo() {
            if (!currentCampaignName) return;

            const memoText = document.getElementById('campaignMemoText').value.trim();
            const memoKey = `campaign_memo_${currentCampaignName}`;

            if (memoText) {
                localStorage.setItem(memoKey, memoText);
                alert('âœ… ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                localStorage.removeItem(memoKey);
                alert('âœ… ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            closeCampaignMemoModal();

            // Refresh campaign table to update memo icons
            if (currentCampaignData) {
                displayCampaigns(currentCampaignData);
            }
        }

        // Check if campaign has memo
        function hasCampaignMemo(campaignName) {
            const memoKey = `campaign_memo_${campaignName}`;
            return localStorage.getItem(memoKey) !== null;
        }
    </script>

    <!-- Manual Input Modal -->
    <div id="manualInputModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="margin-bottom: 20px;">ì¼ë³„ ë°ì´í„° ìˆ˜ë™ ì…ë ¥</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>ë‚ ì§œ *</label>
                    <input type="date" id="manualDate" class="form-input" required>
                </div>
                <div>
                    <label>ìº í˜ì¸ëª… *</label>
                    <input type="text" id="manualCampaign" class="form-input" placeholder="ì˜ˆ: ë¸”í”„_ì‹ ê·œ" required>
                </div>
                <div>
                    <label>ê´‘ê³ ìœ í˜• *</label>
                    <select id="manualAdType" class="form-input">
                        <option value="sales">ë§¤ì¶œí˜• (êµ¬ë§¤ì „í™˜)</option>
                        <option value="lead">ì ì¬ê³ ê° (ë¦¬ë“œìˆ˜ì§‘)</option>
                    </select>
                </div>
                <div>
                    <label>ì§€ì¶œì•¡ (ì›) *</label>
                    <input type="number" id="manualSpend" class="form-input" placeholder="150000" required>
                </div>
                <div>
                    <label>ë…¸ì¶œìˆ˜</label>
                    <input type="number" id="manualImpressions" class="form-input" placeholder="45000">
                </div>
                <div>
                    <label>í´ë¦­ìˆ˜ *</label>
                    <input type="number" id="manualClicks" class="form-input" placeholder="1200" required>
                </div>
                <div>
                    <label>ì „í™˜ìˆ˜ *</label>
                    <input type="number" id="manualConversions" class="form-input" placeholder="48" required>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>ë§¤ì¶œì•¡ (ì›) *</label>
                    <input type="number" id="manualRevenue" class="form-input" placeholder="540000" required>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="addManualData()">â• ì¶”ê°€</button>
                <button class="btn btn-success" onclick="submitManualData()">âœ… ì™„ë£Œ (<span id="manualDataCount">0</span>ê±´)</button>
                <button class="btn btn-secondary" onclick="closeManualInputModal()">ì·¨ì†Œ</button>
            </div>

            <div id="manualDataPreview"></div>
        </div>
    </div>

    <!-- Campaign Detail Modal -->
    <div id="campaignDetailModal" class="modal hidden"></div>

    <!-- Save Analysis Modal (ê³„ì • ì—°ë™ ì „ê¹Œì§€ ìˆ¨ê¹€)
    <div id="saveAnalysisModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 20px;">ğŸ’¾ ë¶„ì„ ì €ì¥í•˜ê¸°</h3>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">ë¶„ì„ ì´ë¦„ *</label>
                <input type="text" id="saveAnalysisName" class="form-input" placeholder="ì˜ˆ: 2024ë…„ 11ì›” 2ì£¼ì°¨">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">ë©”ëª¨ (ì„ íƒ)</label>
                <textarea id="saveAnalysisNotes" class="form-input" rows="4" placeholder="ì´ ë¶„ì„ì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="confirmSaveAnalysis()">ğŸ’¾ ì €ì¥</button>
                <button class="btn btn-secondary" onclick="closeSaveAnalysisModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    -->

    <!-- Load Analysis Modal (ê³„ì • ì—°ë™ ì „ê¹Œì§€ ìˆ¨ê¹€)
    <div id="loadAnalysisModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="margin-bottom: 20px;">ğŸ“‚ ì €ì¥ëœ ë¶„ì„ ë¶ˆëŸ¬ì˜¤ê¸°</h3>

            <div id="savedAnalysesList" style="max-height: 400px; overflow-y: auto;">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeLoadAnalysisModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    -->

    <!-- Campaign Memo Modal -->
    <div id="campaignMemoModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 20px;" id="memoModalTitle">ğŸ“ ìº í˜ì¸ ë©”ëª¨</h3>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">ë©”ëª¨</label>
                <textarea id="campaignMemoText" class="form-input" rows="6" placeholder="ì´ ìº í˜ì¸ì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="saveCampaignMemo()">ğŸ’¾ ì €ì¥</button>
                <button class="btn btn-secondary" onclick="closeCampaignMemoModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // Mobile sidebar toggle
        const mobileToggle = document.getElementById('mobileToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
            mobileToggle.textContent = sidebar.classList.contains('open') ? 'âœ•' : 'â˜°';
        }

        if (mobileToggle) {
            mobileToggle.addEventListener('click', toggleSidebar);
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }

        // Close sidebar on menu item click (mobile)
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('active');
                    mobileToggle.textContent = 'â˜°';
                }
            });
        });

        // Active menu item
        const currentPath = window.location.pathname;
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.getAttribute('href') === currentPath) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    </script>

    <!-- ë°°ë„ˆ ë¡œë” -->
    <script src="/static/js/banner-loader.js"></script>
</body>
</html>
