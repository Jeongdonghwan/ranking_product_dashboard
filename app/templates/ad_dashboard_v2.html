<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>광고 ROAS 분석기 | 네이버 메타 구글 광고 성과 분석 - 마케팅광장</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="광고데이터분석,네이버검색광고,네이버쇼핑광고,스마트스토어광고,메타광고분석,구글광고,ROAS분석">
    <meta name="keywords" content="광고데이터분석,네이버검색광고,네이버쇼핑광고,스마트스토어광고,ROAS계산기,광고분석,네이버광고,메타광고,광고성과">
    <meta name="author" content="마케팅광장">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://dashboard.mbizsquare.com/ad-dashboard">

    <!-- Site Verification -->
    <meta name="naver-site-verification" content="cc6eb66db82f1cef83861f978e49ca76d7a72caa">
    <meta name="google-site-verification" content="i3kI5uL7O6tmcojS0WVBql-E5TUPPR1TkZt8Lwe5zyw">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="광고 ROAS 분석기 | 네이버 메타 구글 광고 성과 분석">
    <meta property="og:description" content="네이버 메타 구글 광고 ROAS 무료 분석. CTR CPA 전환율 자동계산.">
    <meta property="og:url" content="https://dashboard.mbizsquare.com/ad-dashboard">
    <meta property="og:site_name" content="마케팅광장">
    <meta property="og:locale" content="ko_KR">
    <meta property="og:image" content="https://dashboard.mbizsquare.com/static/img/og-image.svg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="광고 ROAS 분석기 | 네이버 메타 구글 광고 성과 분석">
    <meta name="twitter:description" content="네이버 메타 구글 광고 ROAS 무료 분석. CTR CPA 전환율 자동계산.">
    <meta name="twitter:image" content="https://dashboard.mbizsquare.com/static/img/og-image.svg">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "광고 ROAS 분석기",
        "url": "https://dashboard.mbizsquare.com/ad-dashboard",
        "description": "네이버 메타 구글 광고 ROAS 무료 분석. CTR CPA 전환율 자동계산.",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Web",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "KRW"
        }
    }
    </script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg">
    <link rel="apple-touch-icon" href="/static/img/favicon.svg">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

    <!-- XLSX (Excel 내보내기) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- PDF 내보내기 (html2pdf.js - 자동 페이지 분할, 한글 지원) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Sidebar CSS -->
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/header.css">
    <link rel="stylesheet" href="/static/css/ad-banner.css">

    <style>
        /* ========================================
           Looker Studio Style - Professional Design
           ======================================== */

        :root {
            /* Looker Studio Color Palette */
            --primary-blue: #1a73e8;
            --primary-blue-dark: #1557b0;
            --secondary-blue: #4285f4;
            --accent-green: #0f9d58;
            --accent-orange: #f9ab00;
            --accent-red: #ea4335;

            /* Neutral Colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-hover: #f1f3f4;
            --border-color: #dadce0;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --text-tertiary: #80868b;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            --shadow-md: 0 1px 3px 0 rgba(60,64,67,.3), 0 4px 8px 3px rgba(60,64,67,.15);
            --shadow-lg: 0 2px 6px 2px rgba(60,64,67,.3), 0 8px 16px 4px rgba(60,64,67,.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
        }

        /* ========================================
           Layout
           ======================================== */

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content - sidebar.css에서 기본 정의됨 */
        /* 추가 스타일만 정의 */

        /* Top Bar */
        .top-bar {
            background: var(--bg-secondary);
            padding: 16px 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .page-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-blue-dark);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            padding: 20px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Summary Section - Top 8 Key Metrics */
        .summary-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .summary-card {
            background: white;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .summary-card:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
        }

        .summary-card.highlight-green {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: var(--accent-green);
        }

        .summary-card.highlight-blue {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: var(--primary-blue);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .summary-unit {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .metric-card.blue {
            border-left-color: var(--primary-blue);
        }

        .metric-card.green {
            border-left-color: var(--accent-green);
        }

        .metric-card.orange {
            border-left-color: var(--accent-orange);
        }

        .metric-card.red {
            border-left-color: var(--accent-red);
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .metric-change {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .metric-change.positive {
            color: var(--accent-green);
        }

        .metric-change.negative {
            color: var(--accent-red);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 48px;
            text-align: center;
            background: var(--bg-hover);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--primary-blue);
            background: #e8f0fe;
        }

        .upload-area.dragging {
            border-color: var(--accent-green);
            background: #e6f4ea;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        /* Table */
        table, .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-hover);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 12px 16px;
            font-size: 14px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: var(--bg-hover);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-excellent {
            background: #e6f4ea;
            color: #137333;
        }

        .status-good {
            background: #fef7e0;
            color: #ea8600;
        }

        .status-poor {
            background: #fce8e6;
            color: #c5221f;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Sidebar Sections */
        .sidebar-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sidebar-item {
            background: var(--bg-hover);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-item:hover {
            background: #e8f0fe;
            transform: translateX(-2px);
        }

        .sidebar-item-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sidebar-item-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .sidebar-compact-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .sidebar-compact-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
            background: white;
        }

        .progress-bar-container {
            background: var(--bg-hover);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-blue);
            transition: width 0.3s;
        }

        .progress-bar.warning {
            background: var(--accent-orange);
        }

        .progress-bar.danger {
            background: var(--accent-red);
        }

        .sidebar-btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            width: 100%;
            margin-bottom: 8px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .spinner-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-blue);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .spinner-ring {
            border: 4px solid transparent;
            border-top: 4px solid var(--secondary-blue);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .loading-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue));
            width: 0%;
            transition: width 0.3s ease;
            background-size: 200% 100%;
            animation: progress-shimmer 1.5s infinite;
        }

        @keyframes progress-shimmer {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }

        .loading-step {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        /* Filter Buttons */
        .filter-btn {
            padding: 6px 14px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: var(--bg-hover);
            border-color: var(--primary-blue);
        }

        .filter-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        /* ========================================
           RESPONSIVE DESIGN - MOBILE & TABLET
           ======================================== */

        /* Tablet (max-width: 1024px) */
        @media (max-width: 1024px) {
            /* Sidebar, main-content는 sidebar.css에서 관리 */

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .section-header h2 {
                font-size: 18px;
            }

            .metric-value {
                font-size: 26px;
            }

            .metric-label {
                font-size: 12px;
            }

            .card {
                padding: 15px;
            }

            .page-header {
                padding: 15px 20px;
            }

            .page-title {
                font-size: 22px;
            }
        }

        /* Mobile (max-width: 768px) */
        @media (max-width: 768px) {
            /* Layout - sidebar.css에서 관리 */
            .dashboard-container {
                grid-template-columns: 1fr;
            }

            /* Prevent horizontal overflow */
            body {
                overflow-x: hidden;
            }

            .main-content {
                overflow-x: hidden;
                padding: 12px !important;
            }

            /* Top Bar 세로 배치 */
            .top-bar {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
                padding: 12px !important;
            }

            .top-bar-actions {
                width: 100%;
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
            }

            .top-bar-actions .btn {
                flex: 1 1 auto;
                min-width: 80px;
                justify-content: center;
            }

            /* Card 내부 flex 요소들 세로 배치 강제 */
            .card > div[style*="display: flex"] {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px !important;
            }

            .card > div > div[style*="display: flex"] {
                flex-wrap: wrap !important;
                gap: 8px !important;
            }

            /* 기간 선택 버튼들 wrap */
            .filter-btn {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }

            /* 데이터 관리 버튼들 */
            .card .btn {
                padding: 8px 12px !important;
                font-size: 12px !important;
                white-space: nowrap;
            }

            /* Date input 크기 조정 */
            .form-input[type="date"] {
                width: 100% !important;
                max-width: 150px !important;
                padding: 8px !important;
                font-size: 14px !important;
            }

            /* Page header responsive */
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 12px !important;
            }

            .page-title {
                font-size: 18px;
            }

            .page-subtitle {
                font-size: 12px;
            }

            .top-actions {
                width: 100%;
                flex-direction: column;
                gap: 8px;
            }

            .top-actions .btn {
                width: 100%;
                justify-content: center;
            }

            /* Card Header 세로 배치 */
            .card-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
            }

            .card-header .btn {
                width: 100%;
                justify-content: center;
            }

            /* Date range picker responsive */
            .date-range-picker {
                flex-direction: column;
                gap: 10px;
            }

            .date-range-picker input {
                font-size: 14px;
            }

            /* Summary grid - 2열 배치 */
            .summary-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }

            .summary-card {
                padding: 12px !important;
            }

            .summary-value {
                font-size: 20px !important;
            }

            .summary-label {
                font-size: 10px !important;
            }

            .summary-unit {
                font-size: 10px !important;
            }

            .metric-value {
                font-size: 22px;
            }

            .metric-label {
                font-size: 11px;
            }

            .metric-change {
                font-size: 11px;
            }

            /* Metrics Grid 2열 */
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            .metric-card {
                padding: 12px !important;
            }

            /* 모든 인라인 2열 그리드를 1열로 변경 (핵심!) */
            [style*="grid-template-columns: 1fr 1fr"],
            [style*="grid-template-columns:1fr 1fr"],
            div[style*="display: grid"][style*="1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* creativesContainer 내부 그리드 */
            #creativesContainer > div[style*="display: grid"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* page-overview 내부 그리드들 */
            #page-overview > div[style*="display: grid"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* 리드형 캠페인 내부 flex 세로 배치 */
            div[style*="display: flex"][style*="justify-content: space-around"] {
                flex-direction: column !important;
                gap: 16px !important;
                align-items: center !important;
            }

            /* Charts grid - stack vertically */
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .chart-container {
                height: 250px;
            }

            /* Cards */
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .section-header h2 {
                font-size: 16px;
            }

            .section-actions {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }

            .section-actions .btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            /* Tables - horizontal scroll */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* 카드 안에 테이블이 있으면 가로 스크롤 허용 */
            .card:has(table),
            .card:has(.data-table) {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
            }

            .data-table,
            #campaignTable {
                min-width: 500px;
                font-size: 11px;
            }

            .data-table th,
            .data-table td,
            #campaignTable th,
            #campaignTable td {
                padding: 6px 4px;
                white-space: nowrap;
            }

            .data-table th,
            #campaignTable th {
                font-size: 10px;
            }

            /* Hide less important columns on mobile */
            .data-table th:nth-child(n+6),
            .data-table td:nth-child(n+6) {
                display: none;
            }

            /* Buttons - touch friendly */
            .btn {
                min-height: 44px;
                padding: 10px 16px;
                font-size: 14px;
                border-radius: 8px;
            }

            .btn-icon {
                min-width: 44px;
                min-height: 44px;
                padding: 10px;
            }

            /* Modal responsive */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 5% auto;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .modal-body {
                font-size: 14px;
            }

            .modal-footer {
                flex-direction: column;
                gap: 8px;
            }

            .modal-footer .btn {
                width: 100%;
            }

            /* Form groups */
            .form-group {
                margin-bottom: 12px;
            }

            .form-input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 12px;
            }

            label {
                font-size: 12px;
            }

            /* Upload area */
            .upload-area {
                padding: 30px 15px;
                font-size: 14px;
            }

            .upload-icon {
                font-size: 40px;
            }

            /* Filter buttons */
            .filter-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .filter-btn {
                font-size: 12px;
                padding: 8px 10px;
            }

            /* Status badges */
            .status-badge,
            .badge {
                font-size: 10px;
                padding: 3px 8px;
            }

            /* Insights box */
            .insights-box {
                padding: 15px;
                font-size: 13px;
                line-height: 1.5;
            }

            /* Campaign cards grid */
            .campaigns-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .campaign-card {
                padding: 12px;
            }

            .campaign-name {
                font-size: 14px;
            }

            /* Comparison table */
            .comparison-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Loading spinner */
            .loading-overlay {
                padding: 30px;
            }

            .spinner {
                width: 40px;
                height: 40px;
            }

            /* Menu items */
            .menu-item {
                padding: 12px 15px;
                font-size: 14px;
            }

            .menu-icon {
                font-size: 18px;
            }

            /* Sidebar header */
            .sidebar-header {
                padding: 15px;
            }

            .sidebar-logo {
                font-size: 18px;
            }

            /* Stats container */
            .stats-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Action buttons group */
            .button-group {
                flex-direction: column;
                gap: 8px;
            }

            .button-group .btn {
                width: 100%;
            }

            /* Tabs */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                display: flex;
                gap: 8px;
                padding-bottom: 5px;
            }

            .tab {
                white-space: nowrap;
                font-size: 13px;
                padding: 8px 12px;
            }
        }

        /* Extra small mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .page-title {
                font-size: 18px;
            }

            .metric-value {
                font-size: 20px;
            }

            .metric-label {
                font-size: 10px;
            }

            .card {
                padding: 10px;
            }

            .section-header h2 {
                font-size: 14px;
            }

            .chart-container {
                height: 200px;
            }

            .btn {
                font-size: 13px;
                padding: 8px 12px;
            }

            .modal-content {
                width: 98%;
                padding: 15px;
            }

            .form-input {
                padding: 10px;
            }

            .summary-grid {
                gap: 8px;
            }

            .filter-buttons {
                grid-template-columns: 1fr;
            }
        }

        /* Landscape mobile optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            .page-header {
                padding: 10px 15px;
            }

            .chart-container {
                height: 200px;
            }

            .modal-content {
                max-height: 85vh;
            }
        }

        /* 기간선택 반응형 (1200px 이하) */
        @media (max-width: 1200px) {
            /* 기간 선택 카드 내부 플렉스 */
            .card > div[style*="display: flex"][style*="justify-content: space-between"] {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
            }

            /* 날짜 입력 필드 너비 조정 */
            #dateStart, #dateEnd {
                width: 130px !important;
            }
        }

        /* 기간선택 모바일 (768px 이하) */
        @media (max-width: 768px) {
            /* 필터 버튼 그리드 배치 */
            .card > div > div[style*="display: flex"][style*="gap: 8px"]:has(.filter-btn) {
                display: flex !important;
                flex-wrap: wrap !important;
            }

            .filter-btn {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }

            /* 데이터 관리 버튼 그룹 */
            .card > div[style*="display: flex"][style*="flex-wrap"] {
                gap: 8px !important;
            }

            .card > div[style*="display: flex"][style*="flex-wrap"] .btn {
                padding: 6px 12px !important;
                font-size: 12px !important;
            }
        }

        /* Print styles - PDF 출력용 */
        @media print {
            /* 브라우저 기본 헤더/푸터 제거 (날짜, URL 등) */
            @page {
                margin: 10mm;
                size: A4 portrait;
            }

            /* 불필요한 요소 숨김 */
            .sidebar,
            .mobile-menu-toggle,
            .top-actions,
            .section-actions,
            .top-navigation,
            .filter-section,
            .btn,
            button,
            #pdfLoading {
                display: none !important;
            }

            /* 메인 컨텐츠 전체 너비로 확장 + 상단 여백 제거 */
            .main-content {
                margin: 0 !important;
                margin-left: 0 !important;
                margin-top: 0 !important;
                padding: 15px !important;
                width: 100% !important;
                max-width: none !important;
                position: static !important;
            }

            /* fixed/absolute 요소들을 static으로 변경 */
            .top-navigation,
            .sidebar,
            header,
            nav {
                position: static !important;
            }

            /* 배경색 출력 활성화 */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* 카드가 페이지 경계에서 잘리지 않도록 */
            .card,
            .metric-card,
            .summary-card,
            .chart-container,
            table {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }

            /* 그리드 단일 컬럼으로 변경 */
            [style*="grid-template-columns: 1fr 1fr"],
            [style*="grid-template-columns:1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* 차트 컨테이너 높이 조정 */
            .chart-container {
                height: auto !important;
                min-height: 250px !important;
                max-height: 350px !important;
            }

            /* v10.2: 트렌드 차트 가로 짤림 방지 */
            #trendChart {
                width: 100% !important;
                max-width: 100% !important;
                height: 280px !important;
            }

            .card:has(#trendChart) .chart-container {
                height: 300px !important;
                overflow: hidden !important;
            }

            /* 페이지 헤더 */
            .page-header {
                padding: 10px 0 !important;
            }

            /* body 여백 제거 */
            body {
                margin: 0 !important;
                padding: 0 !important;
            }
        }

        /* Utility classes for responsive */
        .mobile-only {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: block;
            }

            .desktop-only {
                display: none;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                padding: 12px 18px;
            }

            .menu-item {
                padding: 14px 16px;
            }

            .filter-btn {
                padding: 10px 14px;
            }

            .data-table td {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" id="mobileToggle" aria-label="메뉴 열기">☰</button>

    <!-- Top Header -->
    <header class="top-header">
        <div class="header-left">
            <h1 class="logo-text"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:20px;height:20px;vertical-align:middle;margin-right:6px;filter:brightness(0) invert(1);">마케팅광장 광고분석</h1>
            <span class="logo-subtitle">광고분석</span>
        </div>
        <div class="header-right">
            <a href="http://pf.kakao.com/_QIxlTK" target="_blank" class="header-btn"><img src="/static/img/icons/guide.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> <span class="btn-text">제휴문의</span></a>
            <a href="https://mbizsquare.com" target="_blank" class="header-btn"><img src="/static/img/icons/dashboard.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> <span class="btn-text">바로가기</span></a>
            <div class="user-info">
                <span class="user-nickname"><img src="/static/img/icons/calculator.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> {{ g.user.userNicknm }}</span>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>메뉴</h2>
        </div>
        <nav class="sidebar-menu">
            <a href="/" class="menu-item">
                <span class="icon"><img src="/static/img/icons/dashboard.svg" alt=""></span>
                <span class="label">대시보드</span>
            </a>
            <a href="/guide" class="menu-item">
                <span class="icon"><img src="/static/img/icons/guide.svg" alt=""></span>
                <span class="label">이용안내</span>
            </a>
            <a href="/ad-dashboard" class="menu-item active">
                <span class="icon"><img src="/static/img/icons/chart.svg" alt=""></span>
                <span class="label">광고분석</span>
            </a>
            <a href="/ad-dashboard/coupang" class="menu-item">
                <span class="icon"><img src="/static/img/icons/cart.svg" alt=""></span>
                <span class="label">쿠팡광고분석</span>
            </a>
            <a href="/ad-dashboard/profit-simulator" class="menu-item">
                <span class="icon"><img src="/static/img/icons/calculator.svg" alt=""></span>
                <span class="label">마진계산기</span>
            </a>
            <a href="/ad-dashboard/ad-efficiency" class="menu-item">
                <span class="icon"><img src="/static/img/icons/target.svg" alt=""></span>
                <span class="label">손익분기 ROAS</span>
            </a>
            <a href="/ad-dashboard/keyword-combiner" class="menu-item">
                <span class="icon"><img src="/static/img/icons/combine.svg" alt=""></span>
                <span class="label">키워드 조합기</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
            <!-- Page Header -->
            <div class="top-bar">
                <div>
                    <div class="page-title">일반 + 메타 광고 분석</div>
                    <div class="page-subtitle">실시간 광고 성과 분석 및 인사이트</div>
                </div>
            </div>

            <!-- 그리드 배너 2x4 (200x60 x 8개) -->
            <div id="generalGridBanners"></div>

            <!-- Page: Overview -->
            <div id="page-overview" class="page-content">
                <!-- Date Filter Section -->
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="font-weight: 600; color: var(--text-primary); margin-right: 8px;"><img src="/static/img/icons/calendar.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> 기간 선택:</span>
                            <button class="filter-btn active" data-filter="all" onclick="applyDateFilter('all')">전체</button>
                            <button class="filter-btn" data-filter="today" onclick="applyDateFilter('today')">오늘</button>
                            <button class="filter-btn" data-filter="week" onclick="applyDateFilter('week')">최근 7일</button>
                            <button class="filter-btn" data-filter="month" onclick="applyDateFilter('month')">최근 30일</button>
                            <button class="filter-btn" data-filter="custom" onclick="openCustomDateModal()">커스텀 기간</button>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="date" id="dateStart" class="form-input" style="width: 140px; padding: 6px 10px;">
                            <span style="color: var(--text-secondary);">~</span>
                            <input type="date" id="dateEnd" class="form-input" style="width: 140px; padding: 6px 10px;">
                            <button class="btn btn-primary" onclick="applyCustomDateRange()" style="padding: 6px 16px;">적용</button>
                        </div>
                    </div>
                    <div id="currentDateRange" style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">
                        현재 기간: 전체 데이터
                    </div>
                </div>

                <!-- Action Buttons Bar -->
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="font-weight: 600; color: var(--text-primary); margin-right: 8px;"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> 데이터 관리:</span>

                            <!-- 템플릿 다운로드 드롭다운 -->
                            <div style="position: relative; display: inline-block;">
                                <button class="btn btn-secondary" id="templateDropdownBtn" onclick="toggleTemplateDropdown(event)" style="padding: 8px 16px;">
                                    <img src="/static/img/icons/download.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> 템플릿 다운로드 ▼
                                </button>
                                <div id="templateDropdown" class="hidden" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; min-width: 180px; margin-top: 4px;">
                                    <a href="/api/ad-analysis/template/unified" style="display: block; padding: 10px 16px; color: var(--text-primary); text-decoration: none;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
                                        <img src="/static/img/icons/clipboard.svg" alt="" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"> 통합 템플릿 (권장)
                                    </a>
                                </div>
                            </div>

                            <!-- 파일 업로드 버튼 -->
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="padding: 8px 16px;">
                                <img src="/static/img/icons/upload.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> 파일 업로드
                            </button>

                            <!-- 수기 입력 버튼 -->
                            <button class="btn btn-success" onclick="openManualInputModal()" style="padding: 8px 16px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border: none;">
                                <img src="/static/img/icons/edit.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> 수동 입력
                            </button>

                            <!-- 대시보드 초기화 버튼 -->
                            <button class="btn btn-secondary" onclick="clearAllData()" style="padding: 8px 16px;">
                                <img src="/static/img/icons/trash.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> 초기화
                            </button>
                        </div>

                        <div style="display: flex; gap: 8px; align-items: center;">
                            <!-- 저장 버튼 (계정 연동 전까지 숨김)
                            <button class="btn btn-secondary" onclick="openSaveAnalysisModal()" style="padding: 8px 16px;">
                                <img src="/static/img/icons/save.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> 저장
                            </button>
                            -->

                            <!-- 불러오기 버튼 (계정 연동 전까지 숨김)
                            <button class="btn btn-secondary" onclick="openLoadAnalysisModal()" style="padding: 8px 16px;">
                                <img src="/static/img/icons/folder.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> 불러오기
                            </button>
                            -->

                            <!-- PDF 내보내기 버튼 -->
                            <button class="btn btn-secondary" onclick="exportToPDF()" style="padding: 8px 16px;">
                                <img src="/static/img/icons/file.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> PDF 내보내기
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Top Summary Section - 8 Key Metrics -->
                <div class="summary-section">
                    <h3 style="margin-bottom: 15px; font-size: 18px; color: var(--text-primary);"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;"> 핵심 지표 요약</h3>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">총 비용</div>
                            <div class="summary-value" id="summarySpend">-</div>
                            <div class="summary-unit">원</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">전환수</div>
                            <div class="summary-value" id="summaryConversions">-</div>
                            <div class="summary-unit">건</div>
                        </div>

                        <div class="summary-card highlight-green">
                            <div class="summary-label">총 매출</div>
                            <div class="summary-value" id="summaryRevenue">-</div>
                            <div class="summary-unit">원</div>
                        </div>

                        <div class="summary-card highlight-blue">
                            <div class="summary-label">ROAS</div>
                            <div class="summary-value" id="summaryRoas">-</div>
                            <div class="summary-unit">%</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">노출수</div>
                            <div class="summary-value" id="summaryImpressions">-</div>
                            <div class="summary-unit">회</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">클릭수</div>
                            <div class="summary-value" id="summaryClicks">-</div>
                            <div class="summary-unit">회</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">클릭률 (CTR)</div>
                            <div class="summary-value" id="summaryCtr">-</div>
                            <div class="summary-unit">%</div>
                        </div>

                        <div class="summary-card">
                            <div class="summary-label">전환율 (CVR)</div>
                            <div class="summary-value" id="summaryCvr">-</div>
                            <div class="summary-unit">%</div>
                        </div>
                    </div>

                    <!-- 계산 공식 설명 -->
                    <div style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-size: 11px; color: #5f6368; line-height: 1.6;">
                        <strong><img src="/static/img/icons/calculator.svg" alt="" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"> 계산 공식:</strong><br>
                        • ROAS = (매출 ÷ 비용) × 100<br>
                        • CTR = (클릭수 ÷ 노출수) × 100<br>
                        • CVR = (전환수 ÷ 클릭수) × 100
                    </div>
                </div>

                <!-- Metrics Grid (기존 4개 카드 - 하위 섹션) -->
                <div class="metrics-grid" id="metricsGrid">
                    <div class="metric-card blue">
                        <div class="metric-label">평균 ROAS</div>
                        <div class="metric-value">-</div>
                        <div class="metric-change positive">
                            <span>↑</span>
                            <span>-</span>
                        </div>
                    </div>

                    <div class="metric-card green">
                        <div class="metric-label">클릭률 (CTR)</div>
                        <div class="metric-value">-</div>
                        <div class="metric-change positive">
                            <span>↑</span>
                            <span>-</span>
                        </div>
                    </div>

                    <div class="metric-card orange">
                        <div class="metric-label">전환당 비용 (CPA)</div>
                        <div class="metric-value">-</div>
                        <div class="metric-change negative">
                            <span>↓</span>
                            <span>-</span>
                        </div>
                    </div>

                    <div class="metric-card red">
                        <div class="metric-label">전환율 (CVR)</div>
                        <div class="metric-value">-</div>
                        <div class="metric-change positive">
                            <span>↑</span>
                            <span>-</span>
                        </div>
                    </div>
                </div>

                <!-- Chart 1: 일별 성과 트렌드 (full width) -->
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-header">
                        <div class="card-title"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 일별 성과 트렌드</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- 성과 분포 카드 (매출형 + 리드형 분리) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <!-- 매출형 캠페인 성과 (ROAS 기준) -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 매출형 캠페인 성과</div>
                        </div>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="salesDistributionChart"></canvas>
                        </div>
                        <div style="padding: 12px; background: #f5f7fa; border-radius: 8px; font-size: 12px; margin: 0 16px 16px;">
                            <strong>ROAS 기준</strong><br>
                            <span style="color: #0f9d58;">● 우수: 400% 이상</span><br>
                            <span style="color: #f4b400;">● 보통: 300~400%</span><br>
                            <span style="color: #ea4335;">● 개선필요: 300% 미만</span>
                        </div>
                    </div>

                    <!-- 리드형 캠페인 성과 (CPA 숫자 표시) -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><img src="/static/img/icons/users.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 리드형 캠페인 성과</div>
                        </div>
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">평균 리드당 비용 (CPA)</div>
                            <div id="avgCpaDisplay" style="font-size: 42px; font-weight: 700; color: #1a73e8;">
                                -
                            </div>
                            <div style="margin-top: 20px; display: flex; justify-content: space-around;">
                                <div>
                                    <div style="font-size: 28px; font-weight: 600;" id="leadTotalCount">0</div>
                                    <div style="font-size: 12px; color: #666;">총 리드수</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: 600;" id="leadTotalSpend">0</div>
                                    <div style="font-size: 12px; color: #666;">총 광고비</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: 600;" id="leadCampaignCount">0</div>
                                    <div style="font-size: 12px; color: #666;">캠페인수</div>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: #f5f7fa; border-radius: 8px; font-size: 12px; margin: 0 16px 16px;">
                            <strong>CPA = 광고비 ÷ 전환수</strong><br>
                            리드 1건 획득에 들어간 비용
                        </div>
                    </div>
                </div>

                <!-- 2x2 Charts Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">

                    <!-- Chart 3: 예산 배분 (Pie Chart) -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><img src="/static/img/icons/dollar-sign.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 캠페인별 예산 배분</div>
                        </div>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="budgetPieChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 4: 전환 퍼널 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><img src="/static/img/icons/filter.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 전환 퍼널</div>
                            <span id="impressionsEstimatedBadge" class="badge badge-warning" style="display: none;"><img src="/static/img/icons/alert-triangle.svg" alt="" style="width:12px;height:12px;vertical-align:middle;"> 노출수 추정됨</span>
                        </div>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="conversionFunnelChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 5: 요일별 성과 히트맵 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><img src="/static/img/icons/calendar.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 요일별 성과</div>
                        </div>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="weekdayHeatmapChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Campaign Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">캠페인 성과</div>
                    </div>
                    <table id="campaignTable">
                        <thead>
                            <tr>
                                <th>순위</th>
                                <th>캠페인명</th>
                                <th>광고유형</th>
                                <th>주요지표</th>
                                <th>CTR</th>
                                <th>전환단가</th>
                                <th>지출액</th>
                                <th>메모</th>
                            </tr>
                        </thead>
                        <tbody id="campaignTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 48px; color: var(--text-secondary);">
                                    데이터를 업로드하면 캠페인 분석이 표시됩니다
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section: Data Upload -->
            <!-- Hidden file input for upload -->
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">

            <!-- Section: Creative Analysis -->
            <h2 style="margin: 40px 0 16px; font-size: 20px; color: var(--text-primary); font-weight: 600; padding: 12px 20px; background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 4px solid #ffc107; border-radius: 8px;"><img src="/static/img/icons/star.svg" alt="" style="width:20px;height:20px;vertical-align:middle;margin-right:8px;"> 광고 핵심 분석</h2>

            <!-- Page: Creative Analysis -->
            <div id="page-creatives" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><img src="/static/img/icons/layout.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 소재 성과 분석</div>
                        <div class="card-subtitle">광고 소재별 ROAS 및 전환율 순위</div>
                    </div>

                    <div id="creativesContainer">
                        <!-- Grid for TOP 10 Tables -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <!-- ROAS TOP 10 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title" style="font-size: 16px;"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> ROAS TOP 10 소재</div>
                                </div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>순위</th>
                                            <th>소재명</th>
                                            <th>타입</th>
                                            <th>ROAS</th>
                                            <th>매출</th>
                                            <th>지출</th>
                                        </tr>
                                    </thead>
                                    <tbody id="roasTopCreativesTable">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                                                소재 데이터가 포함된 파일을 업로드하세요
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- CVR TOP 10 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title" style="font-size: 16px;"><img src="/static/img/icons/target.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 전환율 TOP 10 소재</div>
                                </div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>순위</th>
                                            <th>소재명</th>
                                            <th>타입</th>
                                            <th>CVR</th>
                                            <th>전환수</th>
                                            <th>클릭수</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cvrTopCreativesTable">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                                                소재 데이터가 포함된 파일을 업로드하세요
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Full Creative Performance Table -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">전체 소재 성과</div>
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>소재명</th>
                                        <th>타입</th>
                                        <th>플랫폼</th>
                                        <th>ROAS</th>
                                        <th>CVR</th>
                                        <th>CTR</th>
                                        <th>CPA</th>
                                        <th>전환수</th>
                                        <th>지출액</th>
                                        <th>매출액</th>
                                        <th>상태</th>
                                    </tr>
                                </thead>
                                <tbody id="allCreativesTable">
                                    <tr>
                                        <td colspan="11" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                                            소재 데이터가 포함된 파일을 업로드하세요
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="creativesEmptyState" class="hidden">
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;"><img src="/static/img/icons/layout.svg" alt="" style="width:48px;height:48px;"></div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                소재 분석을 위한 데이터가 필요합니다
                            </div>
                            <div style="color: var(--text-secondary); margin-bottom: 24px;">
                                '표준 템플릿' 또는 '고급 템플릿'을 사용하여 소재 정보를 업로드하세요
                            </div>
                            <button class="btn btn-primary" onclick="document.querySelector('[data-page=\\'upload\\']').click()">
                                <img src="/static/img/icons/upload.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> 데이터 업로드하기
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer style="background: #f8f9fa; border-top: 1px solid #e0e0e0; padding: 12px 20px; margin-top: 40px; font-size: 11px; color: #888; text-align: center; line-height: 1.6;">
                <div style="max-width: 1200px; margin: 0 auto;">
                    <p style="margin: 0 0 4px 0;"><span style="font-weight: 600; color: #555;">에이치코</span> ㅣ 대표: 정동환 ㅣ 사업자등록번호: 280-26-00396 ㅣ 통신판매업: 2023-경기하남-0304</p>
                    <p style="margin: 0 0 4px 0;">경기도 하남시 조정대로 45, F318 ㅣ 대표번호: 1566-3046 ㅣ E-mail: jdhwan227@naver.com</p>
                    <p style="margin: 0; color: #aaa;">© 2025 에이치코. All rights reserved.</p>
                </div>
            </footer>

    </main>

    <!-- Loading Overlay (Enhanced) -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner-wrapper">
                <div class="spinner"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3 id="loadingTitle" class="loading-title">데이터 처리 중...</h3>
            <p id="loadingMessage" class="loading-message">파일을 분석하고 있습니다.</p>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <p id="loadingStep" class="loading-step">1/3 단계 진행 중</p>
        </div>
    </div>

    <script>
        // Global Data Storage
        let currentMetricsData = null;
        let currentDailyData = null;
        let originalDailyData = null;  // 원본 데이터 보존 (기간 필터링 시 사용)
        let currentCampaignData = null;
        let currentDateFilter = 'all';

        // LocalStorage Key
        const STORAGE_KEY = 'ad_dashboard_accumulated_data';

        // Loading State Manager
        const LoadingState = {
            show(title, message, step = null) {
                const overlay = document.getElementById('loadingOverlay');
                const titleEl = document.getElementById('loadingTitle');
                const messageEl = document.getElementById('loadingMessage');
                const stepEl = document.getElementById('loadingStep');
                const progressBar = document.getElementById('progressBar');

                overlay.classList.remove('hidden');
                titleEl.textContent = title;
                messageEl.textContent = message;

                if (step) {
                    stepEl.textContent = step;
                    stepEl.style.display = 'block';
                } else {
                    stepEl.style.display = 'none';
                }

                progressBar.style.width = '0%';
                setTimeout(() => progressBar.style.width = '30%', 100);
            },

            update(message, progress) {
                const messageEl = document.getElementById('loadingMessage');
                const progressBar = document.getElementById('progressBar');

                messageEl.textContent = message;
                progressBar.style.width = `${progress}%`;
            },

            hide() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('hidden');
            }
        };

        // Save data to localStorage
        function saveToLocalStorage(newDailyData) {
            try {
                // Get existing data
                const existingData = loadFromLocalStorage();

                // Merge new data with existing
                const mergedData = mergeDataArrays(existingData, newDailyData);

                // Save merged data
                localStorage.setItem(STORAGE_KEY, JSON.stringify(mergedData));
                console.log('[STORAGE] Saved data:', mergedData.length, 'days');

                return mergedData;
            } catch (error) {
                console.error('[STORAGE] Save error:', error);
                return newDailyData;
            }
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    console.log('[STORAGE] Loaded data:', data.length, 'days');
                    return data;
                }
            } catch (error) {
                console.error('[STORAGE] Load error:', error);
            }
            return [];
        }

        // Merge daily data arrays (avoid duplicates by date + campaign)
        function mergeDataArrays(existingData, newData) {
            const merged = [...existingData];

            newData.forEach(newItem => {
                const existingIndex = merged.findIndex(item =>
                    item.date === newItem.date && item.campaign_name === newItem.campaign_name
                );

                if (existingIndex >= 0) {
                    // Update existing entry
                    merged[existingIndex] = newItem;
                    console.log('[MERGE] Updated:', newItem.date, newItem.campaign_name);
                } else {
                    // Add new entry
                    merged.push(newItem);
                    console.log('[MERGE] Added:', newItem.date, newItem.campaign_name);
                }
            });

            // Sort by date
            merged.sort((a, b) => new Date(a.date) - new Date(b.date));

            return merged;
        }

        // Clear all accumulated data
        function clearAllData() {
            if (confirm('모든 누적 데이터를 삭제하시겠습니까?')) {
                localStorage.removeItem(STORAGE_KEY);
                currentMetricsData = null;
                currentDailyData = null;
                currentCampaignData = null;
                console.log('[STORAGE] All data cleared');
                alert('[완료] 데이터가 삭제되었습니다');

                // Reload page to reset UI
                location.reload();
            }
        }

        // Recalculate metrics from daily data
        function recalculateMetrics(dailyData) {
            console.log('[RECALC] recalculateMetrics called with data:', dailyData);
            if (!dailyData || dailyData.length === 0) {
                console.log('[RECALC] No data, returning null');
                return null;
            }

            // Aggregate totals
            const totals = dailyData.reduce((acc, row, index) => {
                try {
                    acc.spend += parseFloat(row.spend) || 0;
                    acc.revenue += parseFloat(row.revenue) || 0;
                    acc.clicks += parseInt(row.clicks) || 0;
                    acc.conversions += parseInt(row.conversions) || 0;
                    acc.impressions += parseInt(row.impressions) || 0;
                } catch (e) {
                    console.error(`[RECALC] Error processing row ${index}:`, row, e);
                }
                return acc;
            }, { spend: 0, revenue: 0, clicks: 0, conversions: 0, impressions: 0 });

            console.log('[RECALC] Totals:', totals);

            // Calculate campaign metrics first
            const campaigns = calculateCampaignMetrics(dailyData);
            console.log('[RECALC] Campaigns:', campaigns);

            // Calculate aggregate metrics
            const metrics = {
                total_spend: totals.spend,
                total_revenue: totals.revenue,
                total_clicks: totals.clicks,
                total_conversions: totals.conversions,
                total_impressions: totals.impressions,
                avg_roas: totals.spend > 0 ? totals.revenue / totals.spend : 0,
                avg_ctr: totals.impressions > 0 ? (totals.clicks / totals.impressions) * 100 : 0,
                avg_cpc: totals.clicks > 0 ? totals.spend / totals.clicks : 0,
                avg_cpa: totals.conversions > 0 ? totals.spend / totals.conversions : 0,
                cvr: totals.clicks > 0 ? (totals.conversions / totals.clicks) * 100 : 0,
                avg_order_value: totals.conversions > 0 ? totals.revenue / totals.conversions : 0,
                daily_trend: dailyData.map(d => ({
                    ...d,
                    roas: d.spend > 0 ? d.revenue / d.spend : 0,
                    ctr: d.impressions > 0 ? (d.clicks / d.impressions) * 100 : 0,
                    cvr: d.clicks > 0 ? (d.conversions / d.clicks) * 100 : 0,
                    cpa: d.conversions > 0 ? d.spend / d.conversions : 0
                })),
                campaigns: campaigns
            };

            console.log('[RECALC] Final metrics:', metrics);
            return metrics;
        }

        // Calculate campaign-level metrics
        function calculateCampaignMetrics(dailyData) {
            console.log('[CAMPAIGN] calculateCampaignMetrics called with:', dailyData.length, 'rows');
            const campaignMap = {};

            // Group by campaign
            dailyData.forEach((row, index) => {
                console.log(`[CAMPAIGN] Processing row ${index}:`, row);
                const name = row.campaign_name || 'Unknown Campaign';
                if (!name) {
                    console.warn('[CAMPAIGN] Row missing campaign_name:', row);
                    return; // Skip this row
                }

                if (!campaignMap[name]) {
                    campaignMap[name] = {
                        campaign_name: name,
                        ad_type: row.ad_type || 'sales',
                        spend: 0,
                        revenue: 0,
                        clicks: 0,
                        conversions: 0,
                        impressions: 0
                    };
                }

                try {
                    campaignMap[name].spend += parseFloat(row.spend) || 0;
                    campaignMap[name].revenue += parseFloat(row.revenue) || 0;
                    campaignMap[name].clicks += parseInt(row.clicks) || 0;
                    campaignMap[name].conversions += parseInt(row.conversions) || 0;
                    campaignMap[name].impressions += parseInt(row.impressions) || 0;
                } catch (e) {
                    console.error('[CAMPAIGN] Error processing row:', row, e);
                }
            });

            // Convert to array and calculate derived metrics
            const campaigns = Object.values(campaignMap).map(c => {
                const roas = c.spend > 0 ? c.revenue / c.spend : 0;
                const cpa = c.conversions > 0 ? c.spend / c.conversions : 0;
                const enrichedCampaign = {
                    ...c,
                    roas: roas,
                    ctr: c.impressions > 0 ? (c.clicks / c.impressions) * 100 : 0,
                    cpa: cpa,
                    cvr: c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0
                };
                enrichedCampaign.status = getStatusFromMetrics(enrichedCampaign);
                return enrichedCampaign;
            });

            // Sort by ROAS and add rank
            campaigns.sort((a, b) => b.roas - a.roas);
            campaigns.forEach((c, index) => {
                c.rank = index + 1;
            });

            return campaigns;
        }

        // Get status classification from ROAS
        function getStatusFromRoas(roas) {
            if (roas >= 4.0) return 'excellent';
            if (roas >= 3.0) return 'good';
            return 'poor';
        }

        // Get status classification based on ad_type (Lead: CPA, Sales: ROAS)
        function getStatusFromMetrics(campaign) {
            const adType = campaign.ad_type || 'sales';

            if (adType === 'lead') {
                const cpa = campaign.cpa || 0;
                if (cpa > 0 && cpa <= 30000) return 'excellent';
                if (cpa <= 50000) return 'good';
                return 'poor';
            } else {
                const roas = campaign.roas || 0;
                if (roas >= 4.0) return 'excellent';
                if (roas >= 3.0) return 'good';
                return 'poor';
            }
        }

        // Update data summary badge (v10.3: 배지 삭제됨 - 초기화 버튼으로 대체)
        function updateDataSummaryBadge() {
            // 기존 배지가 있으면 제거
            const existingBadge = document.getElementById('dataSummaryBadge');
            if (existingBadge) {
                existingBadge.remove();
            }
        }

        // Dropdown Toggle Functions
        function toggleTemplateDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('templateDropdown');
            const exportDropdown = document.getElementById('exportDropdown');
            // Close other dropdown
            if (exportDropdown) exportDropdown.classList.add('hidden');
            dropdown.classList.toggle('hidden');
        }

        function toggleExportDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('exportDropdown');
            const templateDropdown = document.getElementById('templateDropdown');
            // Close other dropdown
            if (templateDropdown) templateDropdown.classList.add('hidden');
            dropdown.classList.toggle('hidden');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#templateDropdownBtn') && !e.target.closest('#templateDropdown')) {
                const templateDropdown = document.getElementById('templateDropdown');
                if (templateDropdown) templateDropdown.classList.add('hidden');
            }
            if (!e.target.closest('#exportDropdownBtn') && !e.target.closest('#exportDropdown')) {
                const exportDropdown = document.getElementById('exportDropdown');
                if (exportDropdown) exportDropdown.classList.add('hidden');
            }
        });

        // Export Functions
        function exportToExcel() {
            // XLSX 라이브러리 로드 확인
            if (typeof XLSX === 'undefined') {
                alert('Excel 라이브러리 로드 실패. 페이지를 새로고침 후 다시 시도해주세요.');
                return;
            }

            // localStorage에서 데이터 가져오기
            const storedData = loadFromLocalStorage();

            if (!storedData || storedData.length === 0) {
                alert('내보낼 데이터가 없습니다. 먼저 데이터를 업로드하세요.');
                return;
            }

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Sheet 1: Daily Data
                const dailySheet = XLSX.utils.json_to_sheet(storedData.map(row => ({
                    '날짜': row.date,
                    '캠페인명': row.campaign_name,
                    '광고유형': row.ad_type === 'lead' ? '잠재고객' : '매출형',
                    '지출액': row.spend,
                    '노출수': row.impressions || 0,
                    '클릭수': row.clicks,
                    '전환수': row.conversions,
                    '매출액': row.revenue
                })));
                XLSX.utils.book_append_sheet(wb, dailySheet, '일별데이터');

                // Sheet 2: Campaign Summary
                if (currentCampaignData && currentCampaignData.length > 0) {
                    const campaignSheet = XLSX.utils.json_to_sheet(currentCampaignData.map(c => ({
                        '캠페인명': c.campaign_name,
                        '광고유형': c.ad_type === 'lead' ? '잠재고객' : '매출형',
                        'ROAS': c.roas,
                        'CPL': c.cpl || '-',
                        'CTR': c.ctr,
                        'CPA': c.cpa,
                        '지출액': c.spend,
                        '매출액': c.revenue,
                        '전환수': c.conversions
                    })));
                    XLSX.utils.book_append_sheet(wb, campaignSheet, '캠페인별요약');
                }

                // Download
                const fileName = `광고분석_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                alert('[완료] Excel 파일이 다운로드되었습니다.');
            } catch (error) {
                console.error('[exportToExcel] Error:', error);
                alert('[오류] Excel 생성 실패: ' + error.message);
            }
        }

        function exportToPDF() {
            // 데이터 확인
            const storedData = loadFromLocalStorage();
            if (!storedData || storedData.length === 0) {
                alert('내보낼 데이터가 없습니다. 먼저 데이터를 업로드하세요.');
                return;
            }

            // 인쇄 안내
            alert('인쇄 대화상자에서 "PDF로 저장"을 선택하세요.\n\n권장 설정:\n- 용지: A4\n- 여백: 기본값 또는 최소\n- 배경 그래픽: 체크 ✓\n- 머리글/바닥글: 해제 (옵션에서)');

            // 브라우저 인쇄 호출
            window.print();
        }

        // Download Template Function
        function downloadTemplate(type) {
            // Redirect to template download API
            window.location.href = `/api/ad-analysis/template/${type}`;
        }

        // Export to CSV Function
        function exportToCSV() {
            const storedData = loadFromLocalStorage();

            if (!storedData || storedData.length === 0) {
                alert('내보낼 데이터가 없습니다. 먼저 데이터를 업로드하세요.');
                return;
            }

            // Create CSV content
            const headers = ['날짜', '캠페인명', '광고유형', '지출액', '노출수', '클릭수', '전환수', '매출액'];
            const rows = storedData.map(row => [
                row.date,
                row.campaign_name,
                row.ad_type === 'lead' ? '잠재고객' : '매출형',
                row.spend,
                row.impressions || 0,
                row.clicks,
                row.conversions,
                row.revenue
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma
                    const str = String(cell);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(','))
            ].join('\n');

            // Add BOM for Excel compatibility with Korean characters
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `광고분석_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('CSV 파일이 다운로드되었습니다.');
        }

        // Load Analysis Modal Functions
        function openLoadAnalysisModal() {
            loadSavedAnalysesList();
            document.getElementById('loadAnalysisModal').classList.remove('hidden');
        }

        function closeLoadAnalysisModal() {
            document.getElementById('loadAnalysisModal').classList.add('hidden');
        }

        // Page Initialization - Load existing data
        function initializePage() {
            console.log('[INIT] Initializing page...');

            // Check for existing data in localStorage
            const storedData = loadFromLocalStorage();
            console.log('[INIT] Found stored data:', storedData.length, 'rows');

            if (storedData.length > 0) {
                // Recalculate metrics from stored data
                const metrics = recalculateMetrics(storedData);
                console.log('[INIT] Recalculated metrics:', metrics);

                // Display stored data
                displayMetrics(metrics);
                displayChart(metrics.daily_trend);
                displayCampaigns(metrics.campaigns);

                // Update badge
                updateDataSummaryBadge();

                console.log('[INIT] Page initialized with stored data');
            } else {
                console.log('[INIT] No stored data found');
            }
        }

        // Manual Input Modal Functions
        let manualDataBuffer = [];

        function openManualInputModal() {
            manualDataBuffer = [];
            document.getElementById('manualInputModal').classList.remove('hidden');
            updateManualDataPreview();
        }

        function closeManualInputModal() {
            document.getElementById('manualInputModal').classList.add('hidden');
            manualDataBuffer = [];
        }

        function addManualData() {
            const date = document.getElementById('manualDate').value;
            const campaign = document.getElementById('manualCampaign').value;
            const adType = document.getElementById('manualAdType').value;
            const spend = parseFloat(document.getElementById('manualSpend').value) || 0;
            const clicks = parseInt(document.getElementById('manualClicks').value) || 0;
            const conversions = parseInt(document.getElementById('manualConversions').value) || 0;
            const revenue = parseFloat(document.getElementById('manualRevenue').value) || 0;
            const impressions = parseInt(document.getElementById('manualImpressions').value) || 0;

            if (!date || !campaign) {
                alert('날짜와 캠페인명은 필수입니다.');
                return;
            }

            // 잠재고객 유형이면 매출액은 0으로 설정
            const finalRevenue = adType === 'lead' ? 0 : revenue;

            manualDataBuffer.push({
                date,
                campaign_name: campaign,
                ad_type: adType,
                spend,
                clicks,
                conversions,
                revenue: finalRevenue,
                impressions
            });

            // Clear inputs except date and campaign
            document.getElementById('manualSpend').value = '';
            document.getElementById('manualClicks').value = '';
            document.getElementById('manualConversions').value = '';
            document.getElementById('manualRevenue').value = '';
            document.getElementById('manualImpressions').value = '';

            updateManualDataPreview();
            alert(`데이터 추가됨 (총 ${manualDataBuffer.length}건)`);
        }

        function updateManualDataPreview() {
            document.getElementById('manualDataCount').textContent = manualDataBuffer.length;
        }

        // submitManualData is defined later with API integration

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('[INIT] DOM Content Loaded');
            initializePage();
        });

        // Page Navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.dataset.page;

                // Update active menu
                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                this.classList.add('active');

                // Show page
                document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
                document.getElementById(`page-${page}`).classList.remove('hidden');
            });
        });

        // File Upload
        const fileInput = document.getElementById('fileInput');

        console.log('[DEBUG] File input initialized:', fileInput ? 'found' : 'not found');

        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                console.log('[DEBUG] File input changed, files:', e.target.files.length);
                if (e.target.files.length > 0) {
                    console.log('[DEBUG] Uploading file:', e.target.files[0].name);
                    uploadFile(e.target.files[0]);
                }
            });
        }

        // Upload File Function
        async function uploadFile(file) {
            console.log('[DEBUG] uploadFile called with:', file.name, file.size, 'bytes');

            // Step 1: Show loading
            LoadingState.show('파일 업로드 중', '파일을 검증하고 있습니다...', '1/4 단계');
            console.log('[DEBUG] Loading overlay shown');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('snapshot_name', `분석 ${new Date().toLocaleDateString()}`);

            try {
                console.log('[DEBUG] Starting fetch request...');

                // Step 2: Upload to server
                LoadingState.update('서버에 업로드 중...', 25);

                const response = await fetch('/api/ad-analysis/upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('[DEBUG] Response received, status:', response.status);

                // Step 3: Process data
                LoadingState.update('데이터 처리 중...', 50);

                const result = await response.json();
                console.log('[DEBUG] Result:', result);

                if (result.success) {
                    console.log('[DEBUG] Upload successful, processing data...');

                    // Save new daily data to localStorage and merge with existing
                    // campaign_name 포함된 daily_data 우선 사용 (없으면 daily_trend로 폴백)
                    const newDailyData = result.metrics.daily_data || result.metrics.daily_trend || [];
                    console.log('[DEBUG] Using daily_data with campaign names:', newDailyData.length, 'rows');
                    const mergedDailyData = saveToLocalStorage(newDailyData);
                    console.log('[DEBUG] Merged data count:', mergedDailyData.length);

                    // Recalculate metrics from accumulated data
                    const accumulatedMetrics = recalculateMetrics(mergedDailyData);
                    console.log('[DEBUG] Accumulated metrics:', accumulatedMetrics);

                    // Update data summary badge
                    updateDataSummaryBadge();

                    // Step 4: Render charts
                    LoadingState.update('차트 생성 중...', 75);

                    // Switch to overview page FIRST (with null check)
                    const overviewBtn = document.querySelector('[data-page="overview"]');
                    if (overviewBtn) {
                        overviewBtn.click();
                        // Wait for tab transition, then display data
                        setTimeout(() => {
                            console.log('[DEBUG] Displaying metrics after tab switch (upload)...');
                            displayMetrics(accumulatedMetrics);
                            displayChart(accumulatedMetrics.daily_trend);
                            displayCampaigns(accumulatedMetrics.campaigns);

                            // 핵심분석 섹션 업데이트
                            if (accumulatedMetrics.creatives && accumulatedMetrics.creatives.length > 0) {
                                console.log('[DEBUG] Displaying creatives:', accumulatedMetrics.creatives.length);
                                displayCreatives(accumulatedMetrics.creatives);
                            } else {
                                console.log('[DEBUG] No creative data, showing empty state');
                                showNoCreativeDataState();
                            }

                            // Complete
                            LoadingState.update('완료!', 100);

                            setTimeout(() => {
                                LoadingState.hide();
                                alert('[완료] 업로드 및 분석 완료! 누적 데이터: ' + mergedDailyData.length + '행');
                            }, 300);
                        }, 100);
                    } else {
                        // No overview button, display immediately
                        displayMetrics(accumulatedMetrics);
                        displayChart(accumulatedMetrics.daily_trend);
                        displayCampaigns(accumulatedMetrics.campaigns);

                        // 핵심분석 섹션 업데이트
                        if (accumulatedMetrics.creatives && accumulatedMetrics.creatives.length > 0) {
                            displayCreatives(accumulatedMetrics.creatives);
                        } else {
                            showNoCreativeDataState();
                        }

                        // Complete
                        LoadingState.update('완료!', 100);

                        setTimeout(() => {
                            LoadingState.hide();
                            alert('[완료] 업로드 및 분석 완료! 누적 데이터: ' + mergedDailyData.length + '행');
                        }, 300);
                    }
                } else {
                    LoadingState.hide();
                    alert('[오류] 업로드 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (error) {
                LoadingState.hide();
                console.error('[DEBUG] Upload error:', error);
                alert('[오류] 업로드 중 오류가 발생했습니다 상단의 제휴문의를 통해 문의해주세요 : ' + error.message);
            }
        }

        // Display Metrics
        function displayMetrics(metrics) {
            console.log('[displayMetrics] Called with:', metrics);

            // Store data globally for filtering
            currentMetricsData = metrics;

            // 원본 데이터 저장 (최초 1회만)
            if (!originalDailyData || originalDailyData.length === 0) {
                originalDailyData = metrics.daily_trend || [];
                console.log('[displayMetrics] Original data saved:', originalDailyData.length, 'records');
            }

            currentDailyData = metrics.daily_trend || [];
            currentCampaignData = metrics.campaigns || [];

            // Update 8 Summary Cards (Top Section) with error handling
            try {
                const el1 = document.getElementById('summarySpend');
                if (el1) {
                    el1.textContent = (metrics.total_spend / 10000).toFixed(0) + '만';
                    console.log('[displayMetrics] Updated summarySpend');
                } else {
                    console.warn('[displayMetrics] summarySpend element not found');
                }

                const el2 = document.getElementById('summaryConversions');
                if (el2) el2.textContent = (metrics.total_conversions || 0).toLocaleString();

                const el3 = document.getElementById('summaryRevenue');
                if (el3) {
                    el3.textContent = (metrics.total_revenue / 10000).toFixed(0) + '만';
                    console.log('[displayMetrics] Updated summaryRevenue');
                }

                const el4 = document.getElementById('summaryRoas');
                if (el4) {
                    el4.textContent = ((metrics.avg_roas || 0) * 100).toFixed(0);
                    console.log('[displayMetrics] Updated summaryRoas');
                }

                const el5 = document.getElementById('summaryImpressions');
                if (el5) el5.textContent = ((metrics.total_impressions || 0) / 1000).toFixed(0) + 'K';

                const el6 = document.getElementById('summaryClicks');
                if (el6) el6.textContent = (metrics.total_clicks || 0).toLocaleString();

                const el7 = document.getElementById('summaryCtr');
                if (el7) el7.textContent = (metrics.avg_ctr || 0).toFixed(0);

                const el8 = document.getElementById('summaryCvr');
                if (el8) el8.textContent = (metrics.cvr || 0).toFixed(0);

                console.log('[displayMetrics] Summary cards updated successfully');
            } catch (error) {
                console.error('[displayMetrics] Error updating summary cards:', error);
            }

            // Update metric cards (existing 4 cards)
            const cards = document.querySelectorAll('.metric-card');
            if (cards.length >= 4) {
                cards[0].querySelector('.metric-value').textContent = ((metrics.avg_roas || 0) * 100).toFixed(0) + '%' || '-';
                cards[1].querySelector('.metric-value').textContent = (metrics.avg_ctr || 0).toFixed(0) + '%' || '-';
                cards[2].querySelector('.metric-value').textContent = (metrics.avg_cpa || 0).toLocaleString() + '원' || '-';
                cards[3].querySelector('.metric-value').textContent = (metrics.cvr || 0).toFixed(0) + '%' || '-';
            }

            // Display all charts
            if (metrics.daily_trend) {
                displayChart(metrics.daily_trend);
            }

            // Display new advanced charts
            if (metrics.campaigns) {
                displayCampaigns(metrics.campaigns);
                displayROASDistribution(metrics.campaigns);
                displayBudgetPieChart(metrics.campaigns);
                displayConversionFunnel(metrics);
                displayCampaignComparison(metrics.campaigns);
                displayWeekdayHeatmap(metrics.daily_trend);
            }

            // Display creative analysis
            if (metrics.creatives && metrics.creatives.length > 0) {
                displayCreatives(metrics.creatives);
            }
        }

        // Display Chart
        let trendChart = null;
        function displayChart(dailyData) {
            const chartElement = document.getElementById('trendChart');
            if (!chartElement) {
                console.log('[displayChart] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (trendChart) {
                trendChart.destroy();
            }

            const dates = dailyData.map(d => d.date);
            const roasData = dailyData.map(d => (d.roas || 0) * 100); // Convert to percentage
            const spendData = dailyData.map(d => d.spend / 10000);
            const revenueData = dailyData.map(d => (d.revenue || 0) / 10000);
            const conversionsData = dailyData.map(d => d.conversions || 0);

            // Calculate data ranges for better axis scaling
            const roasMax = Math.max(...roasData.filter(v => v != null && !isNaN(v)));
            const roasMin = Math.min(...roasData.filter(v => v != null && !isNaN(v)));
            const spendMax = Math.max(...spendData.filter(v => v != null && !isNaN(v)));

            console.log('[displayChart] ROAS range:', roasMin, '-', roasMax);
            console.log('[displayChart] Spend max:', spendMax);

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'ROAS (%)',
                            data: roasData,
                            borderColor: 'rgb(46, 204, 113)',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: 'rgb(46, 204, 113)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '매출 (만원)',
                            data: revenueData,
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            tension: 0.4,
                            yAxisID: 'y2'
                        },
                        {
                            label: '전환수',
                            data: conversionsData,
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            tension: 0.4,
                            yAxisID: 'y3'
                        },
                        {
                            label: '지출 (만원)',
                            data: spendData,
                            type: 'bar',
                            backgroundColor: 'rgba(52, 152, 219, 0.3)',
                            borderColor: 'rgb(52, 152, 219)',
                            borderWidth: 1,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 13, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label === 'ROAS (%)') {
                                        label += context.parsed.y.toFixed(0) + '%';
                                    } else if (context.dataset.label === '전환수') {
                                        label += context.parsed.y.toFixed(0) + '건';
                                    } else if (context.dataset.label.includes('만원')) {
                                        label += context.parsed.y.toFixed(0) + '만원';
                                    } else {
                                        label += context.parsed.y.toFixed(0);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ROAS (%)',
                                color: 'rgb(46, 204, 113)',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            suggestedMax: roasMax > 0 ? Math.ceil(roasMax * 1.2) : 500,
                            ticks: {
                                stepSize: 50,
                                color: 'rgb(46, 204, 113)',
                                font: { weight: 'bold', size: 12 },
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(46, 204, 113, 0.1)',
                                drawBorder: true,
                                borderColor: 'rgb(46, 204, 113)',
                                borderWidth: 2
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '매출/지출 (만원)',
                                color: 'rgb(255, 159, 64)',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            ticks: {
                                color: 'rgb(255, 159, 64)',
                                font: { weight: 'bold', size: 12 }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        y3: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '전환수',
                                color: 'rgb(153, 102, 255)',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            ticks: {
                                color: 'rgb(153, 102, 255)',
                                font: { weight: 'bold', size: 12 }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });

            console.log('[displayChart] Chart rendered successfully with enhanced ROAS visibility');
        }

        // Chart 2a: 매출형 캠페인 ROAS 분포 (Doughnut Chart)
        let salesDistChart = null;
        function displaySalesDistribution(campaigns) {
            const salesCampaigns = campaigns.filter(c => (c.ad_type || 'sales') === 'sales');

            const chartElement = document.getElementById('salesDistributionChart');
            if (!chartElement) {
                console.log('[displaySalesDistribution] Chart element not found');
                return;
            }

            const ctx = chartElement.getContext('2d');
            if (salesDistChart) {
                salesDistChart.destroy();
            }

            if (salesCampaigns.length === 0) {
                // 매출형 캠페인이 없는 경우
                salesDistChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['매출형 캠페인 없음'],
                        datasets: [{ data: [1], backgroundColor: ['#e0e0e0'] }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
                return;
            }

            // ROAS 기준 분류
            const excellent = salesCampaigns.filter(c => c.roas >= 4.0).length;
            const good = salesCampaigns.filter(c => c.roas >= 3.0 && c.roas < 4.0).length;
            const poor = salesCampaigns.filter(c => c.roas < 3.0).length;
            const total = salesCampaigns.length;

            const excellentPct = ((excellent / total) * 100).toFixed(1);
            const goodPct = ((good / total) * 100).toFixed(1);
            const poorPct = ((poor / total) * 100).toFixed(1);

            salesDistChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `우수 ${excellent}개 (${excellentPct}%)`,
                        `보통 ${good}개 (${goodPct}%)`,
                        `개선필요 ${poor}개 (${poorPct}%)`
                    ],
                    datasets: [{
                        data: [excellent, good, poor],
                        backgroundColor: ['#0f9d58', '#f4b400', '#ea4335'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 11 }, padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label;
                                }
                            }
                        }
                    }
                }
            });

            console.log('[displaySalesDistribution] Sales campaigns:', total, 'Excellent:', excellent, 'Good:', good, 'Poor:', poor);
        }

        // Chart 2b: 리드형 캠페인 CPA 요약 (숫자 표시)
        function displayLeadSummary(campaigns) {
            const leadCampaigns = campaigns.filter(c => c.ad_type === 'lead');

            const avgCpaEl = document.getElementById('avgCpaDisplay');
            const leadCountEl = document.getElementById('leadTotalCount');
            const leadSpendEl = document.getElementById('leadTotalSpend');
            const leadCampaignCountEl = document.getElementById('leadCampaignCount');

            if (!avgCpaEl) {
                console.log('[displayLeadSummary] Elements not found');
                return;
            }

            if (leadCampaigns.length === 0) {
                avgCpaEl.textContent = '데이터 없음';
                avgCpaEl.style.fontSize = '24px';
                avgCpaEl.style.color = '#999';
                leadCountEl.textContent = '-';
                leadSpendEl.textContent = '-';
                leadCampaignCountEl.textContent = '0';
                return;
            }

            const totalSpend = leadCampaigns.reduce((sum, c) => sum + (c.spend || 0), 0);
            const totalConversions = leadCampaigns.reduce((sum, c) => sum + (c.conversions || 0), 0);
            const avgCpa = totalConversions > 0 ? Math.round(totalSpend / totalConversions) : 0;

            // 평균 CPA 표시
            if (avgCpa > 0) {
                avgCpaEl.textContent = avgCpa.toLocaleString() + '원';
                avgCpaEl.style.fontSize = '42px';
                avgCpaEl.style.color = '#1a73e8';
            } else {
                avgCpaEl.textContent = '전환 없음';
                avgCpaEl.style.fontSize = '24px';
                avgCpaEl.style.color = '#ea4335';
            }

            // 총 리드수
            leadCountEl.textContent = totalConversions.toLocaleString() + '건';

            // 총 광고비
            if (totalSpend >= 100000000) {
                leadSpendEl.textContent = (totalSpend / 100000000).toFixed(1) + '억';
            } else {
                leadSpendEl.textContent = Math.round(totalSpend / 10000).toLocaleString() + '만';
            }

            // 캠페인 수
            leadCampaignCountEl.textContent = leadCampaigns.length + '개';

            console.log('[displayLeadSummary] Lead campaigns:', leadCampaigns.length, 'Total conversions:', totalConversions, 'Avg CPA:', avgCpa);
        }

        // 기존 함수 호환성 유지 (두 함수 동시 호출)
        function displayROASDistribution(campaigns) {
            displaySalesDistribution(campaigns);
            displayLeadSummary(campaigns);
        }

        // Chart 3: Budget Pie Chart
        let budgetPieChart = null;
        function displayBudgetPieChart(campaigns) {
            // Data validation
            if (!campaigns || campaigns.length === 0) {
                console.log('[displayBudgetPieChart] No campaign data to display');
                return;
            }

            const chartElement = document.getElementById('budgetPieChart');
            if (!chartElement) {
                console.log('[displayBudgetPieChart] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (budgetPieChart) {
                budgetPieChart.destroy();
            }

            // Top 5 campaigns by spend
            const topCampaigns = [...campaigns]
                .sort((a, b) => b.spend - a.spend)
                .slice(0, 5);

            const otherSpend = campaigns
                .slice(5)
                .reduce((sum, c) => sum + c.spend, 0);

            const labels = topCampaigns.map(c => c.campaign_name);
            const data = topCampaigns.map(c => c.spend / 10000);

            if (otherSpend > 0) {
                labels.push('기타');
                data.push(otherSpend / 10000);
            }

            const colors = ['#1a73e8', '#0f9d58', '#f4b400', '#ea4335', '#9334e6', '#95a5a6'];

            budgetPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(0)}만원 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Chart 4: Conversion Funnel
        let conversionFunnelChart = null;
        function displayConversionFunnel(metrics) {
            // Data validation
            if (!metrics) {
                console.log('[displayConversionFunnel] No metrics data to display');
                return;
            }

            const chartElement = document.getElementById('conversionFunnelChart');
            if (!chartElement) {
                console.log('[displayConversionFunnelChart] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (conversionFunnelChart) {
                conversionFunnelChart.destroy();
            }

            const impressions = metrics.total_impressions || 0;
            const clicks = metrics.total_clicks || 0;
            const conversions = metrics.total_conversions || 0;

            // Calculate conversion rates
            const ctr = impressions > 0 ? ((clicks / impressions) * 100).toFixed(2) : 0;
            const cvr = clicks > 0 ? ((conversions / clicks) * 100).toFixed(2) : 0;

            // Show/hide impression estimation badge
            const badge = document.getElementById('impressionsEstimatedBadge');
            if (metrics.impressions_estimated) {
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }

            conversionFunnelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        `노출수`,
                        `클릭수 (CTR ${ctr}%)`,
                        `전환수 (CVR ${cvr}%)`
                    ],
                    datasets: [{
                        label: '전환 퍼널',
                        data: [impressions, clicks, conversions],
                        backgroundColor: ['#1a73e8', '#0f9d58', '#f4b400'],
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const label = context.label;
                                    return `${label}: ${value.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            console.log('[displayConversionFunnel] Funnel rendered with CTR:', ctr, '% CVR:', cvr, '%');
        }

        // Chart 5: Campaign Comparison (Bar Chart)
        let campaignComparisonChart = null;
        function displayCampaignComparison(campaigns) {
            // Data validation
            if (!campaigns || campaigns.length === 0) {
                console.log('[displayCampaignComparison] No campaign data to display');
                return;
            }

            const chartElement = document.getElementById('campaignComparisonChart');
            if (!chartElement) {
                console.log('[displayCampaignComparison] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (campaignComparisonChart) {
                campaignComparisonChart.destroy();
            }

            // Top 8 campaigns by ROAS
            const topCampaigns = [...campaigns]
                .sort((a, b) => b.roas - a.roas)
                .slice(0, 8);

            const labels = topCampaigns.map(c => c.campaign_name.length > 15 ? c.campaign_name.substring(0, 15) + '...' : c.campaign_name);
            const roasData = topCampaigns.map(c => c.roas);

            campaignComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ROAS',
                        data: roasData,
                        backgroundColor: roasData.map(r => r >= 4.0 ? '#0f9d58' : r >= 3.0 ? '#f4b400' : '#ea4335'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'ROAS' }
                        }
                    }
                }
            });
        }

        // Update comparison chart based on selected metric
        function updateComparisonChart() {
            const metric = document.getElementById('comparisonMetricSelect').value;

            if (!currentCampaignData || currentCampaignData.length === 0) {
                return;
            }

            const topCampaigns = [...currentCampaignData]
                .sort((a, b) => b[metric] - a[metric])
                .slice(0, 8);

            const labels = topCampaigns.map(c => c.campaign_name.length > 15 ? c.campaign_name.substring(0, 15) + '...' : c.campaign_name);

            let data, label, color;

            switch(metric) {
                case 'roas':
                    data = topCampaigns.map(c => c.roas);
                    label = 'ROAS';
                    color = data.map(r => r >= 4.0 ? '#0f9d58' : r >= 3.0 ? '#f4b400' : '#ea4335');
                    break;
                case 'spend':
                    data = topCampaigns.map(c => c.spend / 10000);
                    label = '지출액 (만원)';
                    color = '#1a73e8';
                    break;
                case 'revenue':
                    data = topCampaigns.map(c => c.revenue / 10000);
                    label = '매출액 (만원)';
                    color = '#0f9d58';
                    break;
                case 'conversions':
                    data = topCampaigns.map(c => c.conversions);
                    label = '전환수';
                    color = '#f4b400';
                    break;
            }

            if (campaignComparisonChart) {
                campaignComparisonChart.data.labels = labels;
                campaignComparisonChart.data.datasets[0].data = data;
                campaignComparisonChart.data.datasets[0].label = label;
                campaignComparisonChart.data.datasets[0].backgroundColor = color;
                campaignComparisonChart.update();
            }
        }

        // Chart 6: Weekday Heatmap (Bar Chart)
        let weekdayHeatmapChart = null;
        function displayWeekdayHeatmap(dailyData) {
            // Data validation
            if (!dailyData || dailyData.length === 0) {
                console.log('[displayWeekdayHeatmap] No data to display');
                return;
            }

            const chartElement = document.getElementById('weekdayHeatmapChart');
            if (!chartElement) {
                console.log('[displayWeekdayHeatmap] Chart element not found, skipping');
                return;
            }

            const ctx = chartElement.getContext('2d');

            if (weekdayHeatmapChart) {
                weekdayHeatmapChart.destroy();
            }

            // Group by day of week with expanded metrics
            const weekdayData = {
                '일': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                '월': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                '화': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                '수': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                '목': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                '금': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 },
                '토': { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0, count: 0 }
            };

            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];

            dailyData.forEach(d => {
                // 타임존 문제 해결: 로컬 타임존으로 명시적 파싱
                const parts = d.date.split('-');
                const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                const dayName = dayNames[date.getDay()];
                weekdayData[dayName].spend += d.spend || 0;
                weekdayData[dayName].revenue += d.revenue || 0;
                weekdayData[dayName].conversions += d.conversions || 0;
                weekdayData[dayName].clicks += d.clicks || 0;
                weekdayData[dayName].impressions += d.impressions || 0;
                weekdayData[dayName].count += 1;
            });

            // Calculate averages per weekday
            const labels = dayNames;
            const avgSpend = labels.map(day => weekdayData[day].count > 0 ? weekdayData[day].spend / weekdayData[day].count / 10000 : 0);
            const avgRevenue = labels.map(day => weekdayData[day].count > 0 ? weekdayData[day].revenue / weekdayData[day].count / 10000 : 0);
            const avgConversions = labels.map(day => weekdayData[day].count > 0 ? weekdayData[day].conversions / weekdayData[day].count : 0);
            const avgROAS = labels.map(day => {
                const totalSpend = weekdayData[day].spend;
                const totalRevenue = weekdayData[day].revenue;
                return totalSpend > 0 ? ((totalRevenue / totalSpend) * 100) : 0;  // Convert to percentage
            });
            const avgCTR = labels.map(day => {
                const totalImpressions = weekdayData[day].impressions;
                const totalClicks = weekdayData[day].clicks;
                return totalImpressions > 0 ? ((totalClicks / totalImpressions) * 100) : 0;
            });
            const avgCVR = labels.map(day => {
                const totalClicks = weekdayData[day].clicks;
                const totalConversions = weekdayData[day].conversions;
                return totalClicks > 0 ? ((totalConversions / totalClicks) * 100) : 0;
            });

            weekdayHeatmapChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ROAS',
                            data: avgROAS,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: 'rgb(46, 204, 113)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '평균 매출 (만원)',
                            data: avgRevenue,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgb(52, 152, 219)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        },
                        {
                            label: '평균 지출 (만원)',
                            data: avgSpend,
                            backgroundColor: 'rgba(155, 89, 182, 0.7)',
                            borderColor: 'rgb(155, 89, 182)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        },
                        {
                            label: '평균 전환수',
                            data: avgConversions,
                            backgroundColor: 'rgba(241, 196, 15, 0.7)',
                            borderColor: 'rgb(241, 196, 15)',
                            borderWidth: 1,
                            yAxisID: 'y2'
                        },
                        {
                            label: 'CVR (%)',
                            data: avgCVR,
                            backgroundColor: 'rgba(230, 126, 34, 0.7)',
                            borderColor: 'rgb(230, 126, 34)',
                            borderWidth: 1,
                            yAxisID: 'y3'
                        },
                        {
                            label: 'CTR (%)',
                            data: avgCTR,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgb(231, 76, 60)',
                            borderWidth: 1,
                            yAxisID: 'y3'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 11 },
                                padding: 10,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    if (label.includes('ROAS')) {
                                        label += value.toFixed(0) + '%';  // Now ROAS is already in percentage
                                    } else if (label.includes('%')) {
                                        label += value.toFixed(1) + '%';
                                    } else if (label.includes('만원')) {
                                        label += value.toFixed(0) + '만원';
                                    } else {
                                        label += value.toFixed(1);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ROAS (%)',
                                font: { size: 11, weight: 'bold' }
                            },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: '금액 (만원)',
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                font: { size: 10 }
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '전환수',
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                font: { size: 10 }
                            }
                        },
                        y3: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '비율 (%)',
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });

            console.log('[displayWeekdayHeatmap] Chart rendered with expanded metrics (ROAS, revenue, spend, conversions, CVR, CTR)');
        }

        // Display Campaigns
        function displayCampaigns(campaigns) {
            const tbody = document.getElementById('campaignTableBody');

            if (campaigns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 48px; color: var(--text-secondary);">데이터가 없습니다</td></tr>';
                return;
            }

            tbody.innerHTML = campaigns.map((c, index) => {
                // 광고유형 표시
                const adType = c.ad_type || 'sales';
                const adTypeLabel = adType === 'lead' ? '잠재고객' : '매출형';
                const adTypeClass = adType === 'lead' ? 'background: #e3f2fd; color: #1565c0;' : 'background: #e8f5e9; color: #2e7d32;';

                // 주요지표 표시 (매출형: ROAS, 잠재고객: CPL)
                let primaryMetricDisplay;
                if (adType === 'lead') {
                    const cpl = c.cpl || c.cpa || 0;
                    primaryMetricDisplay = `CPL ${cpl.toLocaleString()}원`;
                } else {
                    const roas = ((c.roas || 0) * 100).toFixed(0);
                    primaryMetricDisplay = `ROAS ${roas}%`;
                }

                // 전환단가 (CPA 또는 CPL)
                const costPerConversion = c.cpl || c.cpa || 0;
                const costLabel = adType === 'lead' ? 'CPL' : 'CPA';

                const hasMemo = hasCampaignMemo(c.campaign_name);
                const memoButton = `
                    <button
                        onclick="event.stopPropagation(); openCampaignMemoModal('${c.campaign_name.replace(/'/g, "\\'")}')"
                        class="btn btn-secondary"
                        style="padding: 4px 10px; font-size: 12px; ${hasMemo ? 'background: var(--accent-green); color: white;' : ''}"
                        title="${hasMemo ? '메모 있음 (클릭하여 수정)' : '메모 추가'}">
                        ${hasMemo ? '<img src="/static/img/icons/edit.svg" alt="" style="width:12px;height:12px;vertical-align:middle;' + (hasMemo ? 'filter:brightness(0) invert(1);' : '') + '">✓' : '<img src="/static/img/icons/edit.svg" alt="" style="width:12px;height:12px;vertical-align:middle;">'}
                    </button>
                `;

                return `
                    <tr onclick="showCampaignDetail(${index})" style="cursor: pointer;" title="클릭하여 상세보기">
                        <td>${c.rank || '-'}</td>
                        <td style="font-weight: 500;">${c.campaign_name}</td>
                        <td><span style="padding: 2px 8px; border-radius: 4px; font-size: 12px; ${adTypeClass}">${adTypeLabel}</span></td>
                        <td><strong>${primaryMetricDisplay}</strong></td>
                        <td>${(c.ctr || 0).toFixed(1)}%</td>
                        <td>${costPerConversion.toLocaleString()}원</td>
                        <td>${((c.spend || 0) / 10000).toFixed(0)}만원</td>
                        <td>${memoButton}</td>
                    </tr>
                `;
            }).join('');
        }

        // Display Creatives
        function displayCreatives(creatives) {
            console.log('[Creative Analysis] Displaying creatives:', creatives);

            if (!creatives || creatives.length === 0) {
                console.log('[Creative Analysis] No creative data available');
                return;
            }

            // Sort by ROAS for ROAS TOP 10
            const roasTop = [...creatives].sort((a, b) => (b.roas || 0) - (a.roas || 0)).slice(0, 10);

            // Sort by CVR for CVR TOP 10
            const cvrTop = [...creatives].sort((a, b) => (b.cvr || 0) - (a.cvr || 0)).slice(0, 10);

            // Update ROAS TOP 10 Table
            const roasTableBody = document.getElementById('roasTopCreativesTable');
            roasTableBody.innerHTML = roasTop.map((c, index) => `
                <tr>
                    <td style="font-weight: 600;">${index + 1}</td>
                    <td style="font-weight: 500;">${c.ad_creative_name}</td>
                    <td>${c.creative_type || '-'}</td>
                    <td><strong style="color: var(--accent-green);">${((c.roas || 0) * 100).toFixed(0)}%</strong></td>
                    <td>${((c.revenue || 0) / 10000).toFixed(0)}만</td>
                    <td>${((c.spend || 0) / 10000).toFixed(0)}만</td>
                </tr>
            `).join('');

            // Update CVR TOP 10 Table
            const cvrTableBody = document.getElementById('cvrTopCreativesTable');
            cvrTableBody.innerHTML = cvrTop.map((c, index) => `
                <tr>
                    <td style="font-weight: 600;">${index + 1}</td>
                    <td style="font-weight: 500;">${c.ad_creative_name}</td>
                    <td>${c.creative_type || '-'}</td>
                    <td><strong style="color: var(--primary-blue);">${(c.cvr || 0).toFixed(1)}%</strong></td>
                    <td>${(c.conversions || 0).toLocaleString()}</td>
                    <td>${(c.clicks || 0).toLocaleString()}</td>
                </tr>
            `).join('');

            // Update All Creatives Table
            const allCreativesBody = document.getElementById('allCreativesTable');
            allCreativesBody.innerHTML = creatives.map(c => {
                let statusClass = 'status-excellent';
                let statusText = '우수';

                if (c.roas < 3.0) {
                    statusClass = 'status-poor';
                    statusText = '개선필요';
                } else if (c.roas < 4.0) {
                    statusClass = 'status-good';
                    statusText = '보통';
                }

                return `
                    <tr>
                        <td style="font-weight: 500;">${c.ad_creative_name}</td>
                        <td>${c.creative_type || '-'}</td>
                        <td>${c.platform || '-'}</td>
                        <td><strong>${((c.roas || 0) * 100).toFixed(0)}%</strong></td>
                        <td>${(c.cvr || 0).toFixed(1)}%</td>
                        <td>${(c.ctr || 0).toFixed(1)}%</td>
                        <td>${(c.cpa || 0).toLocaleString()}원</td>
                        <td>${((c.spend || 0) / 10000).toFixed(0)}만원</td>
                        <td>${((c.revenue || 0) / 10000).toFixed(0)}만원</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');

            console.log('[Creative Analysis] Tables updated successfully');
        }

        // Show no creative data state
        function showNoCreativeDataState() {
            console.log('[Creative Analysis] No creative data - showing campaign fallback');

            // Use campaign data as fallback
            if (!currentCampaignData || currentCampaignData.length === 0) {
                const emptyMessage = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                            ℹ️ 분석할 캠페인 데이터가 없습니다.
                        </td>
                    </tr>
                `;
                const roasTableBody = document.getElementById('roasTopCreativesTable');
                const cvrTableBody = document.getElementById('cvrTopCreativesTable');
                const allCreativesBody = document.getElementById('allCreativesTable');

                if (roasTableBody) roasTableBody.innerHTML = emptyMessage;
                if (cvrTableBody) cvrTableBody.innerHTML = emptyMessage;
                if (allCreativesBody) allCreativesBody.innerHTML = emptyMessage;
                return;
            }

            // Sort by ROAS (descending) for TOP 10
            const roasTopCampaigns = [...currentCampaignData]
                .sort((a, b) => (b.roas || 0) - (a.roas || 0))
                .slice(0, 10);

            // Sort by CVR (descending) for TOP 10
            const cvrTopCampaigns = [...currentCampaignData]
                .map(c => {
                    const cvr = c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0;
                    return { ...c, cvr };
                })
                .sort((a, b) => b.cvr - a.cvr)
                .slice(0, 10);

            // Display ROAS TOP 10 (헤더: 순위, 소재명, 타입, ROAS, 매출, 지출 - 6개)
            const roasTableBody = document.getElementById('roasTopCreativesTable');
            if (roasTableBody) {
                roasTableBody.innerHTML = roasTopCampaigns.map((campaign, idx) => {
                    const roas = (campaign.roas || 0) * 100;
                    const spend = campaign.spend || 0;
                    const revenue = campaign.revenue || 0;
                    const adType = campaign.ad_type || 'sales';
                    const typeStyle = adType === 'lead'
                        ? 'background: #e3f2fd; color: #1565c0;'
                        : 'background: #e8f5e9; color: #2e7d32;';
                    const typeLabel = adType === 'lead' ? '리드' : '매출';

                    return `
                        <tr onclick="showCampaignDetail(${currentCampaignData.indexOf(campaign)})" style="cursor: pointer;">
                            <td>${idx + 1}</td>
                            <td>${campaign.campaign_name || 'Unknown'}</td>
                            <td><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; ${typeStyle}">${typeLabel}</span></td>
                            <td><strong style="color: #2ecc71;">${roas.toFixed(0)}%</strong></td>
                            <td>${(revenue / 10000).toFixed(0)}만</td>
                            <td>${(spend / 10000).toFixed(0)}만</td>
                        </tr>
                    `;
                }).join('');
            }

            // Display CVR TOP 10 (헤더: 순위, 소재명, 타입, CVR, 전환수, 클릭수 - 6개)
            const cvrTableBody = document.getElementById('cvrTopCreativesTable');
            if (cvrTableBody) {
                cvrTableBody.innerHTML = cvrTopCampaigns.map((campaign, idx) => {
                    const cvr = campaign.cvr || 0;
                    const clicks = campaign.clicks || 0;
                    const conversions = campaign.conversions || 0;
                    const adType = campaign.ad_type || 'sales';
                    const typeStyle = adType === 'lead'
                        ? 'background: #e3f2fd; color: #1565c0;'
                        : 'background: #e8f5e9; color: #2e7d32;';
                    const typeLabel = adType === 'lead' ? '리드' : '매출';

                    return `
                        <tr onclick="showCampaignDetail(${currentCampaignData.indexOf(campaign)})" style="cursor: pointer;">
                            <td>${idx + 1}</td>
                            <td>${campaign.campaign_name || 'Unknown'}</td>
                            <td><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; ${typeStyle}">${typeLabel}</span></td>
                            <td><strong style="color: #9b59b6;">${cvr.toFixed(1)}%</strong></td>
                            <td>${conversions}건</td>
                            <td>${clicks}회</td>
                        </tr>
                    `;
                }).join('');
            }

            // Display All Campaigns (헤더: 소재명, 타입, 플랫폼, ROAS, CVR, CTR, CPA, 전환수, 지출액, 매출액, 상태 - 11개)
            const allCreativesBody = document.getElementById('allCreativesTable');
            if (allCreativesBody) {
                allCreativesBody.innerHTML = currentCampaignData.map((campaign, idx) => {
                    const roas = (campaign.roas || 0) * 100;
                    const cpa = campaign.cpa || 0;
                    const cvr = campaign.clicks > 0 ? (campaign.conversions / campaign.clicks) * 100 : 0;
                    const ctr = campaign.ctr || 0;
                    const spend = campaign.spend || 0;
                    const revenue = campaign.revenue || 0;
                    const conversions = campaign.conversions || 0;
                    const adType = campaign.ad_type || 'sales';
                    const typeStyle = adType === 'lead'
                        ? 'background: #e3f2fd; color: #1565c0;'
                        : 'background: #e8f5e9; color: #2e7d32;';
                    const typeLabel = adType === 'lead' ? '리드' : '매출';

                    // 상태 배지 (ad_type별 다른 기준)
                    let statusBadge, statusClass;
                    if (adType === 'lead') {
                        if (cpa > 0 && cpa <= 30000) { statusBadge = '우수'; statusClass = 'status-excellent'; }
                        else if (cpa <= 50000) { statusBadge = '보통'; statusClass = 'status-good'; }
                        else { statusBadge = '개선필요'; statusClass = 'status-poor'; }
                    } else {
                        const roasVal = campaign.roas || 0;
                        if (roasVal >= 4.0) { statusBadge = '우수'; statusClass = 'status-excellent'; }
                        else if (roasVal >= 3.0) { statusBadge = '보통'; statusClass = 'status-good'; }
                        else { statusBadge = '개선필요'; statusClass = 'status-poor'; }
                    }

                    return `
                        <tr onclick="showCampaignDetail(${idx})" style="cursor: pointer;">
                            <td style="font-weight: 500;">${campaign.campaign_name || 'Unknown'}</td>
                            <td><span style="padding: 2px 6px; border-radius: 4px; font-size: 11px; ${typeStyle}">${typeLabel}</span></td>
                            <td>-</td>
                            <td><strong>${roas.toFixed(0)}%</strong></td>
                            <td>${cvr.toFixed(1)}%</td>
                            <td>${ctr.toFixed(1)}%</td>
                            <td>${cpa.toLocaleString()}원</td>
                            <td>${conversions.toLocaleString()}건</td>
                            <td>${(spend / 10000).toFixed(0)}만원</td>
                            <td>${(revenue / 10000).toFixed(0)}만원</td>
                            <td><span class="status-badge ${statusClass}">${statusBadge}</span></td>
                        </tr>
                    `;
                }).join('');
            }

            console.log('[Creative Analysis] Campaign fallback displayed:', {
                roasTop: roasTopCampaigns.length,
                cvrTop: cvrTopCampaigns.length,
                all: currentCampaignData.length
            });
        }

        // Campaign Detail Modal
        function showCampaignDetail(index) {
            const campaign = currentCampaignData[index];
            if (!campaign) return;

            const adType = campaign.ad_type || 'sales';
            const cpa = campaign.cpa || 0;
            const cvr = campaign.clicks > 0 ? ((campaign.conversions / campaign.clicks) * 100).toFixed(1) : 0;

            // Determine background color based on ad_type and performance
            let bgColor;
            if (adType === 'lead') {
                bgColor = cpa <= 30000 ? '#e8f5e9' : cpa > 50000 ? '#ffebee' : '#fff3e0';
            } else {
                bgColor = campaign.roas >= 4.0 ? '#e8f5e9' : campaign.roas < 3.0 ? '#ffebee' : '#fff3e0';
            }

            const modalContent = `
                <div class="modal-content" style="max-width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: var(--text-primary);"><img src="/static/img/icons/target.svg" alt="" style="width:20px;height:20px;vertical-align:middle;"> ${campaign.campaign_name}</h2>
                        <button class="btn btn-secondary" onclick="closeCampaignDetailModal()">✕ 닫기</button>
                    </div>

                    <div class="summary-grid" style="margin-bottom: 24px;">
                        ${adType === 'lead' ? `
                            <!-- Lead campaign metrics -->
                            <div class="summary-card highlight-blue">
                                <div class="summary-label">CPA (전환당비용)</div>
                                <div class="summary-value">${(cpa / 1000).toFixed(0)}</div>
                                <div class="summary-unit">천원</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">지출액</div>
                                <div class="summary-value">${((campaign.spend || 0) / 10000).toFixed(0)}</div>
                                <div class="summary-unit">만원</div>
                            </div>
                            <div class="summary-card highlight-green">
                                <div class="summary-label">전환수</div>
                                <div class="summary-value">${(campaign.conversions || 0).toLocaleString()}</div>
                                <div class="summary-unit">건</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">전환율</div>
                                <div class="summary-value">${cvr}</div>
                                <div class="summary-unit">%</div>
                            </div>
                        ` : `
                            <!-- Sales campaign metrics -->
                            <div class="summary-card highlight-blue">
                                <div class="summary-label">ROAS</div>
                                <div class="summary-value">${((campaign.roas || 0) * 100).toFixed(0)}</div>
                                <div class="summary-unit">%</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">지출액</div>
                                <div class="summary-value">${((campaign.spend || 0) / 10000).toFixed(0)}</div>
                                <div class="summary-unit">만원</div>
                            </div>
                            <div class="summary-card highlight-green">
                                <div class="summary-label">매출액</div>
                                <div class="summary-value">${((campaign.revenue || 0) / 10000).toFixed(0)}</div>
                                <div class="summary-unit">만원</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">전환수</div>
                                <div class="summary-value">${(campaign.conversions || 0).toLocaleString()}</div>
                                <div class="summary-unit">건</div>
                            </div>
                        `}
                    </div>

                    <div class="card" style="background: ${bgColor}; padding: 20px;">
                        <h3 style="margin-bottom: 12px; font-size: 16px;"><img src="/static/img/icons/lightbulb.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> AI 권장사항</h3>
                        <p style="margin: 0; line-height: 1.6;">
                            ${getCampaignRecommendation(campaign)}
                        </p>
                    </div>
                </div>
            `;

            const modalDiv = document.getElementById('campaignDetailModal');
            modalDiv.innerHTML = modalContent;
            modalDiv.classList.remove('hidden');
        }

        function getCampaignRecommendation(campaign) {
            const adType = campaign.ad_type || 'sales';
            const roas = campaign.roas || 0;
            const roasPercent = (roas * 100).toFixed(0);
            const ctr = campaign.ctr || 0;
            const cvr = ((campaign.conversions || 0) / (campaign.clicks || 1)) * 100;
            const cpa = campaign.cpa || 0;

            // Different logic for lead vs sales campaigns
            if (adType === 'lead') {
                // Lead campaign - judge by CPA and CVR
                if (cpa > 0 && cpa <= 30000) {
                    return `[우수] <strong>우수한 성과!</strong> 전환당 비용 ${cpa.toLocaleString()}원으로 목표 달성 중입니다. 전환율 ${cvr.toFixed(1)}%를 유지하며 예산 확대를 고려하세요.`;
                } else if (cpa > 30000 && cpa <= 50000) {
                    if (cvr < 2.0) {
                        return `[주의] 전환율 ${cvr.toFixed(1)}%로 낮습니다. 랜딩페이지 개선 또는 타겟팅 조정을 권장합니다.`;
                    } else {
                        return `[양호] 양호한 성과입니다. 전환당 ${cpa.toLocaleString()}원을 유지하고 있습니다.`;
                    }
                } else if (cpa > 50000) {
                    return `[개선필요] 전환당 비용 ${cpa.toLocaleString()}원으로 목표 대비 높습니다. 타겟팅 재검토 또는 광고 소재 변경을 고려하세요.`;
                } else {
                    return `[주의] 데이터가 부족합니다. 충분한 전환 데이터 수집 후 재평가가 필요합니다.`;
                }
            } else {
                // Sales campaign - judge by ROAS
                if (roas >= 4.0) {
                    return `[우수] <strong>우수한 성과!</strong> ROAS ${roasPercent}%로 목표 초과달성 중입니다. 예산을 늘려 더 많은 수익을 창출하세요.`;
                } else if (roas >= 3.0) {
                    if (ctr < 2.0) {
                        return `[주의] 클릭률 ${ctr.toFixed(1)}%로 낮습니다. 광고 소재 개선 또는 타겟팅 조정을 권장합니다.`;
                    } else {
                        return `[양호] 양호한 성과입니다. ROAS ${roasPercent}%를 유지하며 예산 확대를 고려하세요.`;
                    }
                } else {
                    return `[개선필요] ROAS ${roasPercent}%로 목표 미달입니다. 캠페인 전면 재검토 또는 일시 중지를 고려하세요.`;
                }
            }
        }

        function closeCampaignDetailModal() {
            document.getElementById('campaignDetailModal').classList.add('hidden');
        }
        // Manual Input Modal - closeManualInputModal is already defined above

        // REMOVED: Duplicate function addManualDataRow() - use addManualData() instead which includes ad_type

        function updateManualDataPreview() {
            const count = document.getElementById('manualDataCount');
            const preview = document.getElementById('manualDataPreview');

            count.textContent = manualDataBuffer.length;

            if (manualDataBuffer.length > 0) {
                const last = manualDataBuffer[manualDataBuffer.length - 1];
                preview.innerHTML = `
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        <strong>마지막 입력:</strong><br>
                        ${last.date} | ${last.campaign_name} | 지출: ${last.spend.toLocaleString()}원 | 클릭: ${last.clicks}
                    </div>
                `;
            } else {
                preview.innerHTML = '';
            }
        }

        async function submitManualData() {
            if (manualDataBuffer.length === 0) {
                alert('입력된 데이터가 없습니다');
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');

            try {
                const response = await fetch('/api/ad-analysis/manual-input', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        snapshot_name: `수기입력 ${new Date().toLocaleDateString()}`,
                        data: manualDataBuffer
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('[DEBUG] Manual input successful, processing data...');
                    console.log('[DEBUG] Result metrics:', result.metrics);
                    console.log('[DEBUG] Result daily_data:', result.metrics.daily_data);
                    console.log('[DEBUG] Result daily_trend:', result.metrics.daily_trend);

                    // Save new daily data to localStorage and merge with existing
                    // campaign_name 포함된 daily_data 우선 사용 (없으면 daily_trend로 폴백)
                    const newDailyData = result.metrics.daily_data || result.metrics.daily_trend || [];
                    console.log('[DEBUG] Using daily_data with campaign names:', newDailyData.length, 'rows');
                    console.log('[DEBUG] newDailyData:', newDailyData);

                    const mergedDailyData = saveToLocalStorage(newDailyData);
                    console.log('[DEBUG] Merged data count:', mergedDailyData.length);
                    console.log('[DEBUG] mergedDailyData:', mergedDailyData);

                    // Recalculate metrics from accumulated data
                    const accumulatedMetrics = recalculateMetrics(mergedDailyData);
                    console.log('[DEBUG] Accumulated metrics:', accumulatedMetrics);

                    // Only proceed if we have valid metrics
                    if (!accumulatedMetrics) {
                        console.error('[DEBUG] ERROR: accumulatedMetrics is null/undefined!');
                        alert('데이터 계산 오류 발생');
                        loadingOverlay.classList.add('hidden');
                        return;
                    }

                    // Update data summary badge
                    updateDataSummaryBadge();

                    alert(`[완료] 업로드 완료! (${manualDataBuffer.length}건) 누적 데이터: ${mergedDailyData.length}행`);
                    closeManualInputModal();

                    // Switch to overview FIRST
                    const overviewBtn2 = document.querySelector('[data-page="overview"]');
                    if (overviewBtn2) {
                        overviewBtn2.click();
                        // Wait for tab transition, then display data
                        setTimeout(() => {
                            console.log('[DEBUG] Displaying metrics after tab switch...');
                            displayMetrics(accumulatedMetrics);
                            displayChart(accumulatedMetrics.daily_trend);
                            displayCampaigns(accumulatedMetrics.campaigns);
                        }, 100);
                    } else {
                        // No overview button, display immediately
                        displayMetrics(accumulatedMetrics);
                        displayChart(accumulatedMetrics.daily_trend);
                        displayCampaigns(accumulatedMetrics.campaigns);

                        // 핵심분석 섹션 업데이트
                        if (accumulatedMetrics.creatives && accumulatedMetrics.creatives.length > 0) {
                            displayCreatives(accumulatedMetrics.creatives);
                        } else {
                            showNoCreativeDataState();
                        }
                    }
                } else {
                    alert('업로드 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('Manual input error:', error);
                alert('업로드 중 오류 발생: ' + error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Date Filtering Functions
        function applyDateFilter(filterType) {
            currentDateFilter = filterType;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-filter="${filterType}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // 항상 localStorage에서 원본 데이터 로드 (가장 안정적)
            const originalData = loadFromLocalStorage();
            if (!originalData || originalData.length === 0) {
                alert('저장된 데이터가 없습니다. 먼저 데이터를 업로드하세요.');
                return;
            }

            let filteredData = [];

            // 로컬 날짜를 UTC 변환 없이 직접 생성 (타임존 문제 해결)
            const today = new Date();
            const todayStr = today.getFullYear() + '-' +
                             String(today.getMonth() + 1).padStart(2, '0') + '-' +
                             String(today.getDate()).padStart(2, '0');

            console.log('[applyDateFilter] Today (local):', todayStr);

            switch(filterType) {
                case 'all':
                    filteredData = originalData;
                    document.getElementById('currentDateRange').textContent = '현재 기간: 전체 데이터';
                    console.log('[applyDateFilter] All data:', originalData.length, 'records');
                    break;

                case 'today':
                    filteredData = originalData.filter(d => d.date === todayStr);
                    document.getElementById('currentDateRange').textContent = `현재 기간: ${todayStr}`;
                    console.log('[applyDateFilter] Today filter:', todayStr, '-> found', filteredData.length, 'records');
                    break;

                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 6);  // 7일 = 오늘 포함 6일 전
                    const weekAgoStr = weekAgo.getFullYear() + '-' +
                                       String(weekAgo.getMonth() + 1).padStart(2, '0') + '-' +
                                       String(weekAgo.getDate()).padStart(2, '0');
                    // 상한선 추가: 오늘까지만 포함
                    filteredData = originalData.filter(d => d.date >= weekAgoStr && d.date <= todayStr);
                    document.getElementById('currentDateRange').textContent = `현재 기간: ${weekAgoStr} ~ ${todayStr}`;
                    console.log('[applyDateFilter] Week filter:', weekAgoStr, '~', todayStr, '-> found', filteredData.length, 'records');
                    break;

                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setDate(today.getDate() - 29);  // 30일 = 오늘 포함 29일 전
                    const monthAgoStr = monthAgo.getFullYear() + '-' +
                                        String(monthAgo.getMonth() + 1).padStart(2, '0') + '-' +
                                        String(monthAgo.getDate()).padStart(2, '0');
                    // 상한선 추가: 오늘까지만 포함
                    filteredData = originalData.filter(d => d.date >= monthAgoStr && d.date <= todayStr);
                    document.getElementById('currentDateRange').textContent = `현재 기간: ${monthAgoStr} ~ ${todayStr}`;
                    console.log('[applyDateFilter] Month filter:', monthAgoStr, '~', todayStr, '-> found', filteredData.length, 'records');
                    break;
            }

            // 전역 변수 업데이트
            currentDailyData = filteredData;
            originalDailyData = originalData;

            // 모든 시각화 갱신
            if (filteredData.length > 0) {
                recalculateMetricsForPeriod(filteredData);
            } else {
                alert('선택한 기간에 데이터가 없습니다.');
            }
        }

        function applyCustomDateRange() {
            const startDate = document.getElementById('dateStart').value;
            const endDate = document.getElementById('dateEnd').value;

            if (!startDate || !endDate) {
                alert('시작일과 종료일을 모두 선택해주세요');
                return;
            }

            if (startDate > endDate) {
                alert('시작일은 종료일보다 이전이어야 합니다');
                return;
            }

            currentDateFilter = 'custom';
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const customBtn = document.querySelector('[data-filter="custom"]');
            if (customBtn) customBtn.classList.add('active');

            // 핵심 수정: 항상 localStorage에서 원본 데이터 로드
            const originalData = loadFromLocalStorage();
            if (!originalData || originalData.length === 0) {
                alert('저장된 데이터가 없습니다. 먼저 데이터를 업로드하세요.');
                return;
            }

            const filteredData = originalData.filter(d => d.date >= startDate && d.date <= endDate);
            document.getElementById('currentDateRange').textContent = `현재 기간: ${startDate} ~ ${endDate}`;

            // 전역 변수 업데이트
            currentDailyData = filteredData;
            originalDailyData = originalData;

            if (filteredData.length > 0) {
                recalculateMetricsForPeriod(filteredData);
            } else {
                alert('선택한 기간에 데이터가 없습니다.');
            }
        }

        function recalculateMetricsForPeriod(filteredData) {
            if (!filteredData || filteredData.length === 0) {
                alert('선택한 기간에 데이터가 없습니다');

                // UI 초기화 - 0 값으로 표시
                const emptyMetrics = {
                    total_spend: 0,
                    total_revenue: 0,
                    total_clicks: 0,
                    total_conversions: 0,
                    total_impressions: 0,
                    avg_roas: 0,
                    avg_ctr: 0,
                    avg_cpa: 0,
                    cvr: 0,
                    daily_trend: [],
                    campaigns: []
                };
                displayMetrics(emptyMetrics);
                displayCampaigns([]);

                // 차트 초기화
                if (typeof trendChart !== 'undefined' && trendChart) {
                    trendChart.destroy();
                    trendChart = null;
                }
                if (typeof roasDistChart !== 'undefined' && roasDistChart) {
                    roasDistChart.destroy();
                    roasDistChart = null;
                }
                if (typeof budgetPieChart !== 'undefined' && budgetPieChart) {
                    budgetPieChart.destroy();
                    budgetPieChart = null;
                }
                return;
            }

            // Calculate totals from filtered daily data
            const total_spend = filteredData.reduce((sum, d) => sum + (d.spend || 0), 0);
            const total_revenue = filteredData.reduce((sum, d) => sum + (d.revenue || 0), 0);
            const total_clicks = filteredData.reduce((sum, d) => sum + (d.clicks || 0), 0);
            const total_conversions = filteredData.reduce((sum, d) => sum + (d.conversions || 0), 0);
            const total_impressions = filteredData.reduce((sum, d) => sum + (d.impressions || 0), 0);

            // Recalculate campaign metrics from filtered data
            const filteredCampaigns = calculateCampaignMetricsFromDaily(filteredData);

            const metrics = {
                total_spend,
                total_revenue,
                total_clicks,
                total_conversions,
                total_impressions,
                avg_roas: total_spend > 0 ? (total_revenue / total_spend) : 0,
                avg_ctr: total_impressions > 0 ? ((total_clicks / total_impressions) * 100) : 0,
                avg_cpa: total_conversions > 0 ? (total_spend / total_conversions) : 0,
                cvr: total_clicks > 0 ? ((total_conversions / total_clicks) * 100) : 0,
                daily_trend: filteredData,
                campaigns: filteredCampaigns
            };

            // Update all visualizations
            displayMetrics(metrics);
            displayChart(filteredData);
            displayROASDistribution(filteredCampaigns);
            displayBudgetPieChart(filteredCampaigns);
            displayConversionFunnel(metrics);
            displayCampaignComparison(filteredCampaigns);
            displayWeekdayHeatmap(filteredData);
            displayCampaigns(filteredCampaigns);
        }

        // Helper function to calculate campaign metrics from daily data
        function calculateCampaignMetricsFromDaily(dailyData) {
            const campaignMap = {};

            // Group by campaign
            dailyData.forEach(d => {
                const name = d.campaign_name;
                if (!campaignMap[name]) {
                    campaignMap[name] = {
                        campaign_name: name,
                        ad_type: d.ad_type || 'sales',
                        spend: 0,
                        revenue: 0,
                        clicks: 0,
                        conversions: 0,
                        impressions: 0
                    };
                }
                campaignMap[name].spend += (d.spend || 0);
                campaignMap[name].revenue += (d.revenue || 0);
                campaignMap[name].clicks += (d.clicks || 0);
                campaignMap[name].conversions += (d.conversions || 0);
                campaignMap[name].impressions += (d.impressions || 0);
            });

            // Calculate derived metrics
            return Object.values(campaignMap).map(c => {
                c.roas = c.spend > 0 ? (c.revenue / c.spend) : 0;
                c.ctr = c.impressions > 0 ? ((c.clicks / c.impressions) * 100) : 0;
                c.cpa = c.conversions > 0 ? (c.spend / c.conversions) : 0;
                c.cvr = c.clicks > 0 ? ((c.conversions / c.clicks) * 100) : 0;
                c.status = getStatusFromMetrics(c);
                return c;
            }).sort((a, b) => b.roas - a.roas); // Sort by ROAS descending
        }

        function openCustomDateModal() {
            // Just focus on date inputs
            document.getElementById('dateStart').focus();
        }

        // ========================================
        // Phase 2.1: Saved Analyses Feature
        // ========================================

        let currentAnalysisId = null; // Track current analysis being edited in memo modal

        // Open Save Analysis Modal
        function openSaveAnalysisModal() {
            const accumulatedData = localStorage.getItem(STORAGE_KEY);

            if (!accumulatedData || JSON.parse(accumulatedData).length === 0) {
                alert('저장할 데이터가 없습니다. 먼저 데이터를 업로드하세요.');
                return;
            }

            document.getElementById('saveAnalysisModal').classList.remove('hidden');
            document.getElementById('saveAnalysisName').value = '';
            document.getElementById('saveAnalysisNotes').value = '';
        }

        // Close Save Analysis Modal
        function closeSaveAnalysisModal() {
            document.getElementById('saveAnalysisModal').classList.add('hidden');
        }

        // Confirm Save Analysis
        function confirmSaveAnalysis() {
            const name = document.getElementById('saveAnalysisName').value.trim();
            const notes = document.getElementById('saveAnalysisNotes').value.trim();

            if (!name) {
                alert('분석 이름을 입력하세요.');
                return;
            }

            const accumulatedData = localStorage.getItem(STORAGE_KEY);
            if (!accumulatedData) {
                alert('저장할 데이터가 없습니다.');
                return;
            }

            const data = JSON.parse(accumulatedData);
            const timestamp = new Date().getTime();
            const analysisKey = `saved_analysis_${timestamp}`;

            const savedAnalysis = {
                name: name,
                notes: notes,
                timestamp: timestamp,
                saveDate: new Date().toISOString(),
                data: data,
                rowCount: data.length
            };

            localStorage.setItem(analysisKey, JSON.stringify(savedAnalysis));

            alert('[완료] 분석이 저장되었습니다!');
            closeSaveAnalysisModal();
            loadSavedAnalysesList();
        }

        // Load Saved Analyses List
        function loadSavedAnalysesList() {
            const listContainer = document.getElementById('savedAnalysesList');
            const savedAnalyses = [];

            // Get all saved analyses from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('saved_analysis_')) {
                    const data = JSON.parse(localStorage.getItem(key));
                    data.key = key;
                    savedAnalyses.push(data);
                }
            }

            // Sort by timestamp descending (newest first)
            savedAnalyses.sort((a, b) => b.timestamp - a.timestamp);

            if (savedAnalyses.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                        저장된 분석이 없습니다. 현재 분석을 저장하려면 상단의 '저장' 버튼을 클릭하세요.
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = savedAnalyses.map(analysis => `
                <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;"
                     onmouseover="this.style.background='var(--bg-hover)'"
                     onmouseout="this.style.background='white'">
                    <div style="flex: 1;">
                        <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 6px;">${analysis.name}</h4>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
                            저장일시: ${new Date(analysis.saveDate).toLocaleString('ko-KR')}
                        </p>
                        <p style="font-size: 13px; color: var(--text-secondary);">
                            데이터 수: ${analysis.rowCount.toLocaleString()}건
                        </p>
                        ${analysis.notes ? `<p style="font-size: 13px; color: var(--text-tertiary); margin-top: 6px; font-style: italic;">메모: ${analysis.notes}</p>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="loadSavedAnalysis('${analysis.key}')" style="padding: 6px 12px; font-size: 13px;">
                            <img src="/static/img/icons/folder.svg" alt="" style="width:14px;height:14px;vertical-align:middle;filter:brightness(0) invert(1);"> 불러오기
                        </button>
                        <button class="btn btn-secondary" onclick="deleteSavedAnalysis('${analysis.key}')" style="padding: 6px 12px; font-size: 13px; background: var(--accent-red); color: white;">
                            <img src="/static/img/icons/trash.svg" alt="" style="width:14px;height:14px;vertical-align:middle;filter:brightness(0) invert(1);"> 삭제
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load Saved Analysis
        function loadSavedAnalysis(key) {
            if (!confirm('현재 데이터를 저장된 분석으로 교체하시겠습니까?')) {
                return;
            }

            const savedAnalysis = JSON.parse(localStorage.getItem(key));
            if (!savedAnalysis) {
                alert('분석을 찾을 수 없습니다.');
                return;
            }

            // Replace current accumulated data
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedAnalysis.data));

            // Recalculate and refresh displays
            const metrics = calculateMetrics(savedAnalysis.data);
            displayAllData(metrics, savedAnalysis.data);

            alert(`[완료] "${savedAnalysis.name}" 분석을 불러왔습니다.`);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Delete Saved Analysis
        function deleteSavedAnalysis(key) {
            const savedAnalysis = JSON.parse(localStorage.getItem(key));

            if (!confirm(`"${savedAnalysis.name}" 분석을 삭제하시겠습니까?`)) {
                return;
            }

            localStorage.removeItem(key);
            alert('[완료] 분석이 삭제되었습니다.');
            loadSavedAnalysesList();
        }

        // ========================================
        // Phase 2.2: Period Comparison Feature
        // ========================================

        function comparePeriods() {
            const periodAStart = document.getElementById('periodAStart').value;
            const periodAEnd = document.getElementById('periodAEnd').value;
            const periodBStart = document.getElementById('periodBStart').value;
            const periodBEnd = document.getElementById('periodBEnd').value;

            if (!periodAStart || !periodAEnd || !periodBStart || !periodBEnd) {
                alert('모든 날짜를 입력하세요.');
                return;
            }

            const accumulatedData = localStorage.getItem(STORAGE_KEY);
            if (!accumulatedData) {
                alert('비교할 데이터가 없습니다.');
                return;
            }

            const allData = JSON.parse(accumulatedData);

            // Filter data for each period
            const periodAData = allData.filter(row => {
                const date = row.date;
                return date >= periodAStart && date <= periodAEnd;
            });

            const periodBData = allData.filter(row => {
                const date = row.date;
                return date >= periodBStart && date <= periodBEnd;
            });

            if (periodAData.length === 0 || periodBData.length === 0) {
                alert('선택한 기간에 데이터가 없습니다.');
                return;
            }

            // Calculate metrics for each period
            const metricsA = calculateMetrics(periodAData);
            const metricsB = calculateMetrics(periodBData);

            // Display comparison
            displayPeriodComparison(metricsA, metricsB);
        }

        function displayPeriodComparison(metricsA, metricsB) {
            const tbody = document.getElementById('comparisonTableBody');
            const resultDiv = document.getElementById('comparisonResult');

            const metrics = [
                { key: 'avg_roas', label: 'ROAS', format: (v) => v.toFixed(2), better: 'higher' },
                { key: 'avg_ctr', label: 'CTR (%)', format: (v) => v.toFixed(2), better: 'higher' },
                { key: 'avg_cpa', label: 'CPA (원)', format: (v) => v.toLocaleString(), better: 'lower' },
                { key: 'cvr', label: '전환율 (%)', format: (v) => v.toFixed(2), better: 'higher' },
                { key: 'total_spend', label: '총 지출 (원)', format: (v) => v.toLocaleString(), better: 'lower' },
                { key: 'total_revenue', label: '총 매출 (원)', format: (v) => v.toLocaleString(), better: 'higher' }
            ];

            tbody.innerHTML = metrics.map(metric => {
                const valueA = metricsA[metric.key] || 0;
                const valueB = metricsB[metric.key] || 0;
                const change = valueB !== 0 ? ((valueA - valueB) / valueB * 100) : 0;

                let trendIcon = '';
                let trendColor = '';

                if (Math.abs(change) < 0.1) {
                    trendIcon = '→';
                    trendColor = 'var(--text-secondary)';
                } else if (change > 0) {
                    if (metric.better === 'higher') {
                        trendIcon = '▲';
                        trendColor = 'var(--accent-green)';
                    } else {
                        trendIcon = '▼';
                        trendColor = 'var(--accent-red)';
                    }
                } else {
                    if (metric.better === 'higher') {
                        trendIcon = '▼';
                        trendColor = 'var(--accent-red)';
                    } else {
                        trendIcon = '▲';
                        trendColor = 'var(--accent-green)';
                    }
                }

                return `
                    <tr>
                        <td style="font-weight: 500;">${metric.label}</td>
                        <td>${metric.format(valueA)}</td>
                        <td>${metric.format(valueB)}</td>
                        <td style="color: ${trendColor}; font-weight: 600;">${change.toFixed(1)}%</td>
                        <td style="font-size: 18px;">${trendIcon}</td>
                    </tr>
                `;
            }).join('');

            resultDiv.classList.remove('hidden');

            // Scroll to results
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ========================================
        // Phase 3.1: Goal Management
        // ========================================

        function saveGoal() {
            const month = document.getElementById('goalMonth').value;
            const budget = parseFloat(document.getElementById('goalBudget').value);
            const targetRoas = parseFloat(document.getElementById('goalRoas').value);

            if (!month || !budget || !targetRoas) {
                alert('모든 필드를 입력하세요.');
                return;
            }

            const goalKey = `monthly_goal_${month}`;
            const goalData = {
                month: month,
                budget: budget,
                targetRoas: targetRoas,
                savedAt: new Date().toISOString()
            };

            localStorage.setItem(goalKey, JSON.stringify(goalData));
            alert('[완료] 목표가 저장되었습니다!');

            // Display budget pacing
            displayBudgetPacing(month);
        }

        function displayBudgetPacing(month) {
            const goalKey = `monthly_goal_${month}`;
            const goalData = localStorage.getItem(goalKey);

            if (!goalData) {
                alert('해당 월의 목표가 설정되지 않았습니다.');
                return;
            }

            const goal = JSON.parse(goalData);
            const accumulatedData = localStorage.getItem(STORAGE_KEY);

            if (!accumulatedData) {
                alert('분석할 데이터가 없습니다.');
                return;
            }

            const allData = JSON.parse(accumulatedData);

            // Filter data for the target month
            const monthData = allData.filter(row => row.date.startsWith(month));

            if (monthData.length === 0) {
                alert('해당 월의 데이터가 없습니다.');
                return;
            }

            const metrics = calculateMetrics(monthData);
            const spent = metrics.total_spend;
            const budget = goal.budget;

            // Calculate progress
            const spentRate = (spent / budget * 100).toFixed(1);

            // Calculate days progress
            const [year, monthNum] = month.split('-').map(Number);
            const today = new Date();
            const daysInMonth = new Date(year, monthNum, 0).getDate();

            let daysProgress;
            if (today.getFullYear() === year && today.getMonth() + 1 === monthNum) {
                daysProgress = (today.getDate() / daysInMonth * 100).toFixed(1);
            } else {
                daysProgress = 100; // Past month
            }

            // Determine status
            let status, statusColor, suggestion;

            if (spentRate > daysProgress * 1.1) {
                status = 'FAST (빠름)';
                statusColor = 'var(--accent-red)';
                suggestion = '예산 소진 속도가 빠릅니다. 일일 예산을 조정하는 것을 권장합니다.';
            } else if (spentRate < daysProgress * 0.9) {
                status = 'SLOW (느림)';
                statusColor = 'var(--accent-orange)';
                suggestion = '예산 소진이 느립니다. 광고 노출을 늘리는 것을 고려하세요.';
            } else {
                status = 'ON_TRACK (정상)';
                statusColor = 'var(--accent-green)';
                suggestion = '예산이 정상적으로 소진되고 있습니다.';
            }

            // Display
            const contentDiv = document.getElementById('budgetPacingContent');
            contentDiv.innerHTML = `
                <div style="background: var(--bg-hover); padding: 20px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">월 예산</p>
                            <p style="font-size: 20px; font-weight: 600;">${budget.toLocaleString()}원</p>
                        </div>
                        <div>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">사용액</p>
                            <p style="font-size: 20px; font-weight: 600;">${spent.toLocaleString()}원 (${spentRate}%)</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">예산 소진율</p>
                        <div style="background: #e0e0e0; height: 24px; border-radius: 12px; overflow: hidden;">
                            <div style="width: ${Math.min(spentRate, 100)}%; height: 100%; background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue)); transition: width 0.5s;"></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">일정 진행률</p>
                        <div style="background: #e0e0e0; height: 24px; border-radius: 12px; overflow: hidden;">
                            <div style="width: ${daysProgress}%; height: 100%; background: linear-gradient(90deg, #95a5a6, #7f8c8d); transition: width 0.5s;"></div>
                        </div>
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor};">
                        <p style="font-size: 14px; font-weight: 600; color: ${statusColor}; margin-bottom: 8px;">
                            상태: ${status}
                        </p>
                        <p style="font-size: 13px; color: var(--text-secondary);">
                            ${suggestion}
                        </p>
                    </div>

                    <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: white; padding: 12px; border-radius: 6px;">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">목표 ROAS</p>
                            <p style="font-size: 18px; font-weight: 600;">${goal.targetRoas.toFixed(1)}</p>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px;">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">현재 ROAS</p>
                            <p style="font-size: 18px; font-weight: 600; color: ${metrics.avg_roas >= goal.targetRoas ? 'var(--accent-green)' : 'var(--accent-orange)'}">
                                ${metrics.avg_roas.toFixed(2)}
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('budgetPacingResult').classList.remove('hidden');

            // Scroll to results
            document.getElementById('budgetPacingResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Auto-load budget pacing when goal month changes
        document.addEventListener('DOMContentLoaded', function() {
            const goalMonthInput = document.getElementById('goalMonth');
            if (goalMonthInput) {
                goalMonthInput.addEventListener('change', function() {
                    const month = this.value;
                    const goalKey = `monthly_goal_${month}`;
                    const goalData = localStorage.getItem(goalKey);

                    if (goalData) {
                        const goal = JSON.parse(goalData);
                        document.getElementById('goalBudget').value = goal.budget;
                        document.getElementById('goalRoas').value = goal.targetRoas;
                        displayBudgetPacing(month);
                    }
                });
            }

            // 날짜 입력 이벤트 리스너 추가 (기간 선택 자동 적용)
            const dateStartInput = document.getElementById('dateStart');
            const dateEndInput = document.getElementById('dateEnd');

            if (dateStartInput) {
                dateStartInput.addEventListener('change', function() {
                    const endDate = document.getElementById('dateEnd').value;
                    if (this.value && endDate) {
                        applyCustomDateRange();
                    }
                });
            }

            if (dateEndInput) {
                dateEndInput.addEventListener('change', function() {
                    const startDate = document.getElementById('dateStart').value;
                    if (startDate && this.value) {
                        applyCustomDateRange();
                    }
                });
            }

            // Load saved analyses list on page load
            loadSavedAnalysesList();

            // Set current month as default
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            if (goalMonthInput) {
                goalMonthInput.value = currentMonth;
            }
        });

        // ========================================
        // Phase 3.2: Campaign Memo Feature
        // ========================================

        let currentCampaignName = null;

        // Open Campaign Memo Modal
        function openCampaignMemoModal(campaignName) {
            currentCampaignName = campaignName;
            document.getElementById('memoModalTitle').innerHTML = `<img src="/static/img/icons/edit.svg" alt="" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;"> ${campaignName} 메모`;

            // Load existing memo
            const memoKey = `campaign_memo_${campaignName}`;
            const existingMemo = localStorage.getItem(memoKey) || '';
            document.getElementById('campaignMemoText').value = existingMemo;

            document.getElementById('campaignMemoModal').classList.remove('hidden');
        }

        // Close Campaign Memo Modal
        function closeCampaignMemoModal() {
            document.getElementById('campaignMemoModal').classList.add('hidden');
            currentCampaignName = null;
        }

        // Save Campaign Memo
        function saveCampaignMemo() {
            if (!currentCampaignName) return;

            const memoText = document.getElementById('campaignMemoText').value.trim();
            const memoKey = `campaign_memo_${currentCampaignName}`;

            if (memoText) {
                localStorage.setItem(memoKey, memoText);
                alert('[완료] 메모가 저장되었습니다!');
            } else {
                localStorage.removeItem(memoKey);
                alert('[완료] 메모가 삭제되었습니다.');
            }

            closeCampaignMemoModal();

            // Refresh campaign table to update memo icons
            if (currentCampaignData) {
                displayCampaigns(currentCampaignData);
            }
        }

        // Check if campaign has memo
        function hasCampaignMemo(campaignName) {
            const memoKey = `campaign_memo_${campaignName}`;
            return localStorage.getItem(memoKey) !== null;
        }
    </script>

    <!-- Manual Input Modal -->
    <div id="manualInputModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="margin-bottom: 20px;">일별 데이터 수동 입력</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>날짜 *</label>
                    <input type="date" id="manualDate" class="form-input" required>
                </div>
                <div>
                    <label>캠페인명 *</label>
                    <input type="text" id="manualCampaign" class="form-input" placeholder="예: 블프_신규" required>
                </div>
                <div>
                    <label>광고유형 *</label>
                    <select id="manualAdType" class="form-input">
                        <option value="sales">매출형 (구매전환)</option>
                        <option value="lead">잠재고객 (리드수집)</option>
                    </select>
                </div>
                <div>
                    <label>지출액 (원) *</label>
                    <input type="number" id="manualSpend" class="form-input" placeholder="150000" required>
                </div>
                <div>
                    <label>노출수</label>
                    <input type="number" id="manualImpressions" class="form-input" placeholder="45000">
                </div>
                <div>
                    <label>클릭수 *</label>
                    <input type="number" id="manualClicks" class="form-input" placeholder="1200" required>
                </div>
                <div>
                    <label>전환수 *</label>
                    <input type="number" id="manualConversions" class="form-input" placeholder="48" required>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>매출액 (원) *</label>
                    <input type="number" id="manualRevenue" class="form-input" placeholder="540000" required>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="addManualData()"><img src="/static/img/icons/plus.svg" alt="" style="width:14px;height:14px;vertical-align:middle;filter:brightness(0) invert(1);"> 추가</button>
                <button class="btn btn-success" onclick="submitManualData()"><img src="/static/img/icons/check.svg" alt="" style="width:14px;height:14px;vertical-align:middle;filter:brightness(0) invert(1);"> 완료 (<span id="manualDataCount">0</span>건)</button>
                <button class="btn btn-secondary" onclick="closeManualInputModal()">취소</button>
            </div>

            <div id="manualDataPreview"></div>
        </div>
    </div>

    <!-- Campaign Detail Modal -->
    <div id="campaignDetailModal" class="modal hidden"></div>

    <!-- Save Analysis Modal (계정 연동 전까지 숨김)
    <div id="saveAnalysisModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 20px;"><img src="/static/img/icons/save.svg" alt="" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;"> 분석 저장하기</h3>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">분석 이름 *</label>
                <input type="text" id="saveAnalysisName" class="form-input" placeholder="예: 2024년 11월 2주차">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">메모 (선택)</label>
                <textarea id="saveAnalysisNotes" class="form-input" rows="4" placeholder="이 분석에 대한 메모를 입력하세요"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="confirmSaveAnalysis()"><img src="/static/img/icons/save.svg" alt="" style="width:14px;height:14px;vertical-align:middle;filter:brightness(0) invert(1);"> 저장</button>
                <button class="btn btn-secondary" onclick="closeSaveAnalysisModal()">취소</button>
            </div>
        </div>
    </div>
    -->

    <!-- Load Analysis Modal (계정 연동 전까지 숨김)
    <div id="loadAnalysisModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="margin-bottom: 20px;"><img src="/static/img/icons/folder.svg" alt="" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;"> 저장된 분석 불러오기</h3>

            <div id="savedAnalysesList" style="max-height: 400px; overflow-y: auto;">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeLoadAnalysisModal()">닫기</button>
            </div>
        </div>
    </div>
    -->

    <!-- Campaign Memo Modal -->
    <div id="campaignMemoModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 20px;" id="memoModalTitle"><img src="/static/img/icons/edit.svg" alt="" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;"> 캠페인 메모</h3>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">메모</label>
                <textarea id="campaignMemoText" class="form-input" rows="6" placeholder="이 캠페인에 대한 메모를 입력하세요"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="saveCampaignMemo()"><img src="/static/img/icons/save.svg" alt="" style="width:14px;height:14px;vertical-align:middle;filter:brightness(0) invert(1);"> 저장</button>
                <button class="btn btn-secondary" onclick="closeCampaignMemoModal()">취소</button>
            </div>
        </div>
    </div>

    <script>
        // Mobile sidebar toggle
        const mobileToggle = document.getElementById('mobileToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
            mobileToggle.textContent = sidebar.classList.contains('open') ? '✕' : '☰';
        }

        if (mobileToggle) {
            mobileToggle.addEventListener('click', toggleSidebar);
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }

        // Close sidebar on menu item click (mobile)
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('active');
                    mobileToggle.textContent = '☰';
                }
            });
        });

        // Active menu item
        const currentPath = window.location.pathname;
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.getAttribute('href') === currentPath) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    </script>

    <!-- 배너 로더 -->
    <script src="/static/js/banner-loader.js"></script>
</body>
</html>
