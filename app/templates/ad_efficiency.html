<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>손익분기ROAS계산기 | 엔드로아스 계산기 - 마케팅광장</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="손익분기ROAS자동계산,엔드로아스,엔드로아스계산,마진율계산,쿠팡마진계산기,스마트스토어마진계산기">
    <meta name="keywords" content="손익분기ROAS,엔드로아스,ROAS계산기,광고수익률계산,마진율,광고효율,쿠팡광고,쿠팡마케팅">
    <meta name="author" content="마케팅광장">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://dashboard.mbizsquare.com/ad-dashboard/ad-efficiency">

    <!-- Site Verification -->
    <meta name="naver-site-verification" content="cc6eb66db82f1cef83861f978e49ca76d7a72caa">
    <meta name="google-site-verification" content="i3kI5uL7O6tmcojS0WVBql-E5TUPPR1TkZt8Lwe5zyw">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="손익분기 ROAS 계산기 | 광고 수익률 분석 및 BEP 진단">
    <meta property="og:description" content="손익분기 ROAS 자동계산. 마진율 기반 최소 광고수익률 산출.">
    <meta property="og:url" content="https://dashboard.mbizsquare.com/ad-dashboard/ad-efficiency">
    <meta property="og:site_name" content="마케팅광장">
    <meta property="og:locale" content="ko_KR">
    <meta property="og:image" content="https://dashboard.mbizsquare.com/static/img/og-image.svg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="손익분기 ROAS 계산기 | 광고 수익률 분석 및 BEP 진단">
    <meta name="twitter:description" content="손익분기 ROAS 자동계산. 마진율 기반 최소 광고수익률 산출.">
    <meta name="twitter:image" content="https://dashboard.mbizsquare.com/static/img/og-image.svg">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "손익분기 ROAS 계산기",
        "url": "https://dashboard.mbizsquare.com/ad-dashboard/ad-efficiency",
        "description": "손익분기 ROAS 자동계산. 마진율 기반 최소 광고수익률 산출.",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Web",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "KRW"
        }
    }
    </script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg">
    <link rel="apple-touch-icon" href="/static/img/favicon.svg">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>

    <!-- XLSX for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/header.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/ad-banner.css">

    <style>
        :root {
            --primary-blue: #1a73e8;
            --success-green: #0f9d58;
            --warning-orange: #f9ab00;
            --danger-red: #ea4335;
            --bg-primary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        /* Page Header */
        .page-header {
            background: var(--bg-card);
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .page-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Action Buttons */
        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #1557b0;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background: #0d8043;
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
        }

        .btn-danger:hover {
            background: #c5221f;
        }

        .btn-secondary {
            background: #f1f3f4;
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: #e8eaed;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Input Table */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            position: sticky;
            top: 0;
        }

        td {
            vertical-align: middle;
        }

        /* Input Fields */
        .input-cell input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            text-align: right;
            transition: border-color 0.2s;
        }

        .input-cell input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .input-cell input[type="text"] {
            text-align: left;
        }

        .input-cell.name-cell input {
            min-width: 120px;
        }

        .input-cell.number-cell input {
            min-width: 100px;
        }

        /* Result Cells */
        .result-cell {
            font-weight: 600;
        }

        .result-positive {
            color: var(--success-green);
        }

        .result-negative {
            color: var(--danger-red);
        }

        .result-warning {
            color: var(--warning-orange);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-profit {
            background: #d4edda;
            color: #155724;
        }

        .status-breakeven {
            background: #fff3cd;
            color: #856404;
        }

        .status-loss {
            background: #f8d7da;
            color: #721c24;
        }

        /* Delete Button */
        .btn-delete {
            background: none;
            border: none;
            color: var(--danger-red);
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .btn-delete:hover {
            background: #fce8e6;
        }

        /* Selected Row */
        tr.selected {
            background: #e8f0fe !important;
        }

        tr.selected td {
            background: inherit;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        /* Summary Cards - Looker Studio Style */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
            border-left: 4px solid #667eea;
        }

        .summary-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .summary-card.green {
            border-left-color: var(--success-green);
        }

        .summary-card.blue {
            border-left-color: var(--primary-blue);
        }

        .summary-card.orange {
            border-left-color: var(--warning-orange);
        }

        .summary-card.red {
            border-left-color: var(--danger-red);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .summary-sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Row Number */
        .row-number {
            width: 40px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state p {
            margin-bottom: 16px;
        }

        /* AI Advice Box */
        .ai-advice {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            border-left: 4px solid var(--primary-blue);
            padding: 20px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .ai-advice h4 {
            color: var(--primary-blue);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-advice ul {
            margin: 0;
            padding-left: 20px;
        }

        .ai-advice li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .advice-item {
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid;
        }

        .advice-profit {
            border-left-color: var(--success-green);
        }

        .advice-warning {
            border-left-color: var(--warning-orange);
        }

        .advice-danger {
            border-left-color: var(--danger-red);
        }

        /* Info Tooltip */
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #9e9e9e;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            text-align: center;
            line-height: 16px;
            cursor: help;
            margin-left: 4px;
        }

        /* Formula Box */
        .formula-box {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .formula-box h4 {
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .formula-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .formula-label {
            font-weight: 600;
            min-width: 120px;
        }

        .formula-value {
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-bar {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .page-header h1 {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .summary-value {
                font-size: 24px;
            }
        }

        /* ========================================
           Mobile Card Layout (768px 이하)
           ======================================== */
        @media (max-width: 768px) {
            /* 테이블 숨기고 카드형으로 전환 */
            .table-container {
                overflow-x: visible;
            }

            table {
                min-width: unset;
                width: 100%;
            }

            /* 테이블 헤더 숨김 */
            #inputTable thead,
            #resultTable thead {
                display: none;
            }

            /* 테이블 바디를 카드 그리드로 */
            #inputTable tbody,
            #resultTable tbody {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            /* 각 행을 카드로 */
            #inputTable tbody tr,
            #resultTable tbody tr {
                display: block;
                background: #f8f9fa;
                border-radius: 12px;
                padding: 16px;
                padding-top: 24px;
                border: 1px solid var(--border-color);
                position: relative;
                margin-top: 12px;
            }

            /* 모든 셀을 블록으로 */
            #inputTable tbody td,
            #resultTable tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #e9ecef;
                text-align: right;
                white-space: normal;
            }

            #inputTable tbody td:last-child,
            #resultTable tbody td:last-child {
                border-bottom: none;
            }

            /* 라벨 추가 (::before) */
            #inputTable tbody td::before,
            #resultTable tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-secondary);
                font-size: 12px;
                text-align: left;
                flex-shrink: 0;
                margin-right: 12px;
            }

            /* 행 번호 스타일 */
            #inputTable tbody td.row-number,
            #resultTable tbody td.row-number {
                position: absolute;
                top: -8px;
                left: 12px;
                background: var(--primary-blue);
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: 600;
                padding: 0;
                border: none;
            }

            #inputTable tbody td.row-number::before,
            #resultTable tbody td.row-number::before {
                display: none;
            }

            /* 입력 필드 스타일 */
            .input-cell {
                flex: 1;
            }

            .input-cell input {
                width: 100%;
                min-width: unset !important;
                text-align: right;
            }

            .input-cell.name-cell input {
                text-align: left;
            }

            /* 삭제 버튼 숨김 (모바일) */
            #inputTable tbody td:last-child {
                display: none;
            }

            /* 결과값 카드 스타일 */
            #resultTable tbody td {
                font-size: 14px;
            }

            #resultTable tbody td:nth-child(2) {
                font-weight: 600;
                font-size: 15px;
                color: var(--text-primary);
                padding-bottom: 12px;
                margin-bottom: 4px;
            }

            /* 상태 배지 */
            #resultTable tbody td:last-child {
                justify-content: flex-end;
                padding-top: 12px;
            }

            /* 차트 그리드 */
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" id="mobileToggle" aria-label="메뉴 열기">☰</button>

    <!-- Top Header -->
    <header class="top-header">
        <div class="header-left">
            <h1 class="logo-text"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:20px;height:20px;vertical-align:middle;margin-right:6px;filter:brightness(0) invert(1);">마케팅광장 광고분석</h1>
            <span class="logo-subtitle">손익분기 ROAS</span>
        </div>
        <div class="header-right">
            <a href="http://pf.kakao.com/_QIxlTK" target="_blank" class="header-btn"><img src="/static/img/icons/guide.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> <span class="btn-text">제휴문의</span></a>
            <a href="https://mbizsquare.com" target="_blank" class="header-btn"><img src="/static/img/icons/dashboard.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> <span class="btn-text">바로가기</span></a>
            <div class="user-info">
                <span class="user-nickname"><img src="/static/img/icons/calculator.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"> {{ g.user.userNicknm }}</span>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>메뉴</h2>
        </div>
        <nav class="sidebar-menu">
            <a href="/" class="menu-item">
                <span class="icon"><img src="/static/img/icons/dashboard.svg" alt=""></span>
                <span class="label">대시보드</span>
            </a>
            <a href="/guide" class="menu-item">
                <span class="icon"><img src="/static/img/icons/guide.svg" alt=""></span>
                <span class="label">이용안내</span>
            </a>
            <a href="/ad-dashboard" class="menu-item">
                <span class="icon"><img src="/static/img/icons/chart.svg" alt=""></span>
                <span class="label">광고분석</span>
            </a>
            <a href="/ad-dashboard/coupang" class="menu-item">
                <span class="icon"><img src="/static/img/icons/cart.svg" alt=""></span>
                <span class="label">쿠팡광고분석</span>
            </a>
            <a href="/ad-dashboard/profit-simulator" class="menu-item">
                <span class="icon"><img src="/static/img/icons/calculator.svg" alt=""></span>
                <span class="label">마진계산기</span>
            </a>
            <a href="/ad-dashboard/ad-efficiency" class="menu-item active">
                <span class="icon"><img src="/static/img/icons/target.svg" alt=""></span>
                <span class="label">손익분기 ROAS</span>
            </a>
            <a href="/ad-dashboard/keyword-combiner" class="menu-item">
                <span class="icon"><img src="/static/img/icons/combine.svg" alt=""></span>
                <span class="label">키워드 조합기</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1><img src="/static/img/icons/target.svg" alt="" style="width:28px;height:28px;vertical-align:middle;margin-right:8px;"> 손익분기 ROAS</h1>
            <p>캠페인, 상품별 ROAS를 분석하고 손익분기점을 진단합니다. 수익을 내려면 최소 얼마의 ROAS가 필요한지 확인하세요.</p>
        </div>

        <!-- 배너 영역 -->
        <div id="efficiencyBanners"></div>

        <!-- Summary Cards -->
        <div class="summary-grid" id="summaryCards">
            <div class="summary-card green">
                <div class="summary-label">평균 ROAS</div>
                <div class="summary-value" id="avgRoas">0%</div>
                <div class="summary-sub" id="avgRoasSub">캠페인 0개</div>
            </div>
            <div class="summary-card blue">
                <div class="summary-label">총 광고비</div>
                <div class="summary-value" id="totalAdCost">0원</div>
                <div class="summary-sub" id="totalAdSales">광고매출 0원</div>
            </div>
            <div class="summary-card orange">
                <div class="summary-label">수익 캠페인</div>
                <div class="summary-value" id="profitCount">0개</div>
                <div class="summary-sub" id="profitRate">전체의 0%</div>
            </div>
            <div class="summary-card red">
                <div class="summary-label">손실 캠페인</div>
                <div class="summary-value" id="lossCount">0개</div>
                <div class="summary-sub" id="lossSub">개선 필요</div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <button class="btn btn-primary" onclick="addRow()"><img src="/static/img/icons/plus.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> 캠페인 추가</button>
            <button class="btn btn-success" onclick="exportExcel()"><img src="/static/img/icons/download.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> 엑셀 다운로드</button>
            <button class="btn btn-danger" onclick="clearAll()"><img src="/static/img/icons/trash.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> 전체 삭제</button>
        </div>

        <!-- Input Table -->
        <div class="card">
            <h3 class="card-title"><img src="/static/img/icons/edit.svg" alt="" style="width:20px;height:20px;vertical-align:middle;"> 캠페인 입력</h3>
            <div class="table-container">
                <table id="inputTable">
                    <thead>
                        <tr>
                            <th class="row-number">#</th>
                            <th>캠페인명</th>
                            <th>상품명</th>
                            <th>판매가</th>
                            <th>원가</th>
                            <th>광고비(선택)</th>
                            <th>광고매출(선택)</th>
                            <th>삭제</th>
                        </tr>
                    </thead>
                    <tbody id="inputBody">
                        <!-- Dynamic rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Result Table -->
        <div class="card">
            <h3 class="card-title"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:20px;height:20px;vertical-align:middle;"> 진단 결과</h3>
            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th class="row-number">#</th>
                            <th>캠페인명</th>
                            <th>실제 ROAS</th>
                            <th>손익분기 ROAS</th>
                            <th>ROAS 차이</th>
                            <th>마진율</th>
                            <th>예상 수익/손실</th>
                            <th>판정</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                        <!-- Dynamic results -->
                    </tbody>
                </table>
            </div>
            <div class="empty-state" id="emptyState">
                <p>캠페인을 추가하면 자동으로 효율이 진단됩니다.</p>
                <button class="btn btn-primary" onclick="addRow()"><img src="/static/img/icons/plus.svg" alt="" style="width:16px;height:16px;vertical-align:middle;filter:brightness(0) invert(1);"> 첫 캠페인 추가하기</button>
            </div>
        </div>

        <!-- Charts & AI Advice -->
        <div class="charts-grid">
            <div class="card">
                <h3 class="card-title"><img src="/static/img/icons/bar-chart.svg" alt="" style="width:20px;height:20px;vertical-align:middle;"> 캠페인별 ROAS 비교</h3>
                <div class="chart-container">
                    <canvas id="roasChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title"><img src="/static/img/icons/lightbulb.svg" alt="" style="width:20px;height:20px;vertical-align:middle;"> AI 최적화 조언</h3>
                <div id="aiAdvice" class="ai-advice">
                    <h4><img src="/static/img/icons/robot.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 분석 대기중</h4>
                    <p>캠페인 데이터를 입력하면 맞춤형 최적화 조언을 제공합니다.</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer style="background: #f8f9fa; border-top: 1px solid #e0e0e0; padding: 12px 20px; margin-top: 40px; font-size: 11px; color: #888; text-align: center; line-height: 1.6;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <p style="margin: 0 0 4px 0;"><span style="font-weight: 600; color: #555;">에이치코</span> ㅣ 대표: 정동환 ㅣ 사업자등록번호: 280-26-00396 ㅣ 통신판매업: 2023-경기하남-0304</p>
                <p style="margin: 0 0 4px 0;">경기도 하남시 조정대로 45, F318 ㅣ 대표번호: 1566-3046 ㅣ E-mail: jdhwan227@naver.com</p>
                <p style="margin: 0; color: #aaa;">© 2025 에이치코. All rights reserved.</p>
            </div>
        </footer>
    </main>

    <script>
        // ========================================
        // Constants & State
        // ========================================
        const STORAGE_KEY = 'ad_efficiency_data';

        let campaigns = [];
        let rowCounter = 0;
        let roasChart = null;

        // ========================================
        // Initialization
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            if (campaigns.length === 0) {
                addRow(); // 최소 1행 추가
            }
            initCharts();
            updateAll();
            initSidebar();
        });

        function initSidebar() {
            const mobileToggle = document.getElementById('mobileToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            function toggleSidebar() {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('active');
                mobileToggle.textContent = sidebar.classList.contains('open') ? '✕' : '☰';
            }

            mobileToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            // Active menu
            const currentPath = window.location.pathname;
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('href') === currentPath);
            });
        }

        // ========================================
        // Number Formatting
        // ========================================
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return Math.round(num).toLocaleString();
        }

        function parseNumber(str) {
            if (!str) return 0;
            return parseInt(String(str).replace(/,/g, '')) || 0;
        }

        function formatInput(input) {
            const cursorPos = input.selectionStart;
            const oldLength = input.value.length;
            const value = input.value.replace(/[^\d]/g, '');
            input.value = value ? parseInt(value).toLocaleString() : '';
            const newLength = input.value.length;
            const newPos = cursorPos + (newLength - oldLength);
            input.setSelectionRange(newPos, newPos);
        }

        // ========================================
        // Row Management
        // ========================================
        function addRow() {
            rowCounter++;
            const id = rowCounter;
            campaigns.push({
                id: id,
                campaignName: '',
                productName: '',
                adCost: 0,
                adSales: 0,
                salePrice: 0,
                productCost: 0
            });
            renderInputTable();
            updateAll();
            saveToStorage();
        }

        function deleteRow(id) {
            campaigns = campaigns.filter(c => c.id !== id);
            if (campaigns.length === 0) {
                addRow();
            } else {
                renderInputTable();
                updateAll();
                saveToStorage();
            }
        }

        function clearAll() {
            if (confirm('모든 데이터를 삭제하시겠습니까?')) {
                campaigns = [];
                rowCounter = 0;
                localStorage.removeItem(STORAGE_KEY);
                addRow();
            }
        }

        // ========================================
        // Render Tables
        // ========================================
        function renderInputTable() {
            const tbody = document.getElementById('inputBody');
            const emptyState = document.getElementById('emptyState');

            if (campaigns.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tbody.innerHTML = campaigns.map((c, idx) => `
                <tr data-id="${c.id}">
                    <td class="row-number">${idx + 1}</td>
                    <td class="input-cell name-cell" data-label="캠페인명">
                        <input type="text" value="${c.campaignName}" placeholder="캠페인명"
                               onchange="updateField(${c.id}, 'campaignName', this.value)">
                    </td>
                    <td class="input-cell name-cell" data-label="상품명">
                        <input type="text" value="${c.productName}" placeholder="상품명"
                               onchange="updateField(${c.id}, 'productName', this.value)">
                    </td>
                    <td class="input-cell number-cell" data-label="판매가">
                        <input type="text" value="${formatNumber(c.salePrice)}" placeholder="판매가"
                               oninput="formatInput(this)"
                               onchange="updateField(${c.id}, 'salePrice', parseNumber(this.value))">
                    </td>
                    <td class="input-cell number-cell" data-label="원가">
                        <input type="text" value="${formatNumber(c.productCost)}" placeholder="원가"
                               oninput="formatInput(this)"
                               onchange="updateField(${c.id}, 'productCost', parseNumber(this.value))">
                    </td>
                    <td class="input-cell number-cell" data-label="광고비">
                        <input type="text" value="${formatNumber(c.adCost)}" placeholder="선택"
                               oninput="formatInput(this)"
                               onchange="updateField(${c.id}, 'adCost', parseNumber(this.value))">
                    </td>
                    <td class="input-cell number-cell" data-label="광고매출">
                        <input type="text" value="${formatNumber(c.adSales)}" placeholder="선택"
                               oninput="formatInput(this)"
                               onchange="updateField(${c.id}, 'adSales', parseNumber(this.value))">
                    </td>
                    <td>
                        <button class="btn-delete" onclick="deleteRow(${c.id})"><img src="/static/img/icons/trash.svg" alt="" style="width:16px;height:16px;vertical-align:middle;"></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderResultTable() {
            const tbody = document.getElementById('resultBody');
            const results = campaigns.map(c => calculateEfficiency(c));

            tbody.innerHTML = results.map((r, idx) => {
                let statusClass = 'status-profit';
                let statusText = '수익';

                if (r.status === 'loss') {
                    statusClass = 'status-loss';
                    statusText = '손실';
                } else if (r.status === 'breakeven') {
                    statusClass = 'status-breakeven';
                    statusText = '손익분기';
                }

                const roasDiffClass = r.roasDiff >= 0 ? 'result-positive' : 'result-negative';
                const profitClass = r.estimatedProfit >= 0 ? 'result-positive' : 'result-negative';

                return `
                    <tr>
                        <td class="row-number">${idx + 1}</td>
                        <td data-label="캠페인명">${campaigns[idx].campaignName || '-'}</td>
                        <td class="result-cell ${r.actualRoas >= r.breakevenRoas ? 'result-positive' : 'result-negative'}" data-label="실제 ROAS">
                            ${r.actualRoas.toFixed(1)}%
                        </td>
                        <td class="result-cell result-warning" data-label="손익분기 ROAS">
                            ${r.breakevenRoas.toFixed(1)}%
                        </td>
                        <td class="result-cell ${roasDiffClass}" data-label="ROAS 차이">
                            ${r.roasDiff >= 0 ? '+' : ''}${r.roasDiff.toFixed(1)}%p
                        </td>
                        <td data-label="마진율">${r.marginRate.toFixed(1)}%</td>
                        <td class="result-cell ${profitClass}" data-label="예상 수익/손실">
                            ${r.estimatedProfit >= 0 ? '+' : ''}${formatNumber(r.estimatedProfit)}원
                        </td>
                        <td data-label="판정"><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ========================================
        // Calculation
        // ========================================
        function calculateEfficiency(c) {
            const adCost = c.adCost || 0;
            const adSales = c.adSales || 0;
            const salePrice = c.salePrice || 0;
            const productCost = c.productCost || 0;

            // 실제 ROAS (%)
            const actualRoas = adCost > 0 ? (adSales / adCost) * 100 : 0;

            // 마진율 = (판매가 - 원가) / 판매가
            const margin = salePrice - productCost;
            const marginRate = salePrice > 0 ? (margin / salePrice) * 100 : 0;

            // 손익분기 ROAS = 판매가 / (판매가 - 원가) * 100
            // = 1 / 마진율 * 100
            const breakevenRoas = margin > 0 ? (salePrice / margin) * 100 : 9999;

            // ROAS 차이 (실제 - 손익분기)
            const roasDiff = actualRoas - breakevenRoas;

            // 예상 수익/손실 계산
            // 광고로 발생한 판매 수량 = 광고매출 / 판매가
            // 예상 수익 = (광고매출 / 판매가) * 마진 - 광고비
            const estimatedUnits = salePrice > 0 ? adSales / salePrice : 0;
            const estimatedProfit = (estimatedUnits * margin) - adCost;

            // 판정
            let status = 'profit';
            if (roasDiff < -5) {
                status = 'loss';
            } else if (roasDiff >= -5 && roasDiff <= 5) {
                status = 'breakeven';
            }

            return {
                actualRoas,
                breakevenRoas,
                roasDiff,
                marginRate,
                estimatedProfit,
                status
            };
        }

        // ========================================
        // Update Functions
        // ========================================
        function updateField(id, field, value) {
            const campaign = campaigns.find(c => c.id === id);
            if (campaign) {
                campaign[field] = value;
                updateAll();
                saveToStorage();
            }
        }

        function updateAll() {
            renderResultTable();
            updateSummary();
            updateChart();
            updateAIAdvice();
        }

        function updateSummary() {
            const results = campaigns.map(c => calculateEfficiency(c));

            // 유효한 캠페인만 (광고비 > 0)
            const validResults = results.filter((r, i) => campaigns[i].adCost > 0);

            const totalAdCost = campaigns.reduce((sum, c) => sum + (c.adCost || 0), 0);
            const totalAdSales = campaigns.reduce((sum, c) => sum + (c.adSales || 0), 0);
            const avgRoas = totalAdCost > 0 ? (totalAdSales / totalAdCost) * 100 : 0;

            const profitCampaigns = validResults.filter(r => r.status === 'profit');
            const lossCampaigns = validResults.filter(r => r.status === 'loss');

            document.getElementById('avgRoas').textContent = avgRoas.toFixed(1) + '%';
            document.getElementById('avgRoasSub').textContent = `캠페인 ${validResults.length}개`;

            document.getElementById('totalAdCost').textContent = formatNumber(totalAdCost) + '원';
            document.getElementById('totalAdSales').textContent = `광고매출 ${formatNumber(totalAdSales)}원`;

            document.getElementById('profitCount').textContent = profitCampaigns.length + '개';
            document.getElementById('profitRate').textContent = validResults.length > 0
                ? `전체의 ${Math.round(profitCampaigns.length / validResults.length * 100)}%`
                : '전체의 0%';

            document.getElementById('lossCount').textContent = lossCampaigns.length + '개';
            document.getElementById('lossSub').textContent = lossCampaigns.length > 0 ? '개선 필요' : '없음';
        }

        // ========================================
        // Chart
        // ========================================
        function initCharts() {
            const ctx = document.getElementById('roasChart').getContext('2d');

            roasChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '실제 ROAS',
                            data: [],
                            backgroundColor: 'rgba(15, 157, 88, 0.7)',
                            borderColor: 'rgba(15, 157, 88, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: '손익분기 ROAS',
                            data: [],
                            backgroundColor: 'rgba(249, 171, 0, 0.7)',
                            borderColor: 'rgba(249, 171, 0, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ROAS (%)'
                            },
                            ticks: {
                                callback: value => value + '%'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '캠페인'
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!roasChart) return;
            const results = campaigns.map(c => calculateEfficiency(c));
            const labels = campaigns.map((c, i) => c.campaignName || `캠페인 ${i + 1}`);

            roasChart.data.labels = labels;
            roasChart.data.datasets[0].data = results.map(r => r.actualRoas);
            roasChart.data.datasets[1].data = results.map(r => Math.min(r.breakevenRoas, 1000)); // Cap at 1000% for display

            // Color based on status
            roasChart.data.datasets[0].backgroundColor = results.map(r => {
                if (r.status === 'profit') return 'rgba(15, 157, 88, 0.7)';
                if (r.status === 'breakeven') return 'rgba(249, 171, 0, 0.7)';
                return 'rgba(234, 67, 53, 0.7)';
            });

            roasChart.update();
        }

        // ========================================
        // AI Advice
        // ========================================
        function updateAIAdvice() {
            const adviceDiv = document.getElementById('aiAdvice');
            const results = campaigns.map((c, i) => ({
                ...calculateEfficiency(c),
                name: c.campaignName || `캠페인 ${i + 1}`,
                adCost: c.adCost,
                salePrice: c.salePrice,
                productCost: c.productCost
            }));

            // 유효한 캠페인만
            const validResults = results.filter(r => r.adCost > 0);

            if (validResults.length === 0) {
                adviceDiv.innerHTML = `
                    <h4><img src="/static/img/icons/robot.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> 분석 대기중</h4>
                    <p>캠페인 데이터를 입력하면 맞춤형 최적화 조언을 제공합니다.</p>
                `;
                return;
            }

            const advices = [];

            // 전체 현황 분석
            const profitCampaigns = validResults.filter(r => r.status === 'profit');
            const lossCampaigns = validResults.filter(r => r.status === 'loss');
            const breakevenCampaigns = validResults.filter(r => r.status === 'breakeven');

            // 수익 캠페인 조언
            if (profitCampaigns.length > 0) {
                const bestCampaign = profitCampaigns.sort((a, b) => b.roasDiff - a.roasDiff)[0];
                advices.push({
                    type: 'profit',
                    text: `<strong>${bestCampaign.name}</strong>이 가장 효율적입니다. ROAS ${bestCampaign.actualRoas.toFixed(1)}%로 손익분기 대비 +${bestCampaign.roasDiff.toFixed(1)}%p 높습니다. 예산을 더 투입해보세요.`
                });
            }

            // 손실 캠페인 조언
            lossCampaigns.forEach(campaign => {
                const requiredImprovement = Math.abs(campaign.roasDiff);

                if (campaign.marginRate < 20) {
                    advices.push({
                        type: 'danger',
                        text: `<strong>${campaign.name}</strong>: 마진율(${campaign.marginRate.toFixed(1)}%)이 낮아 광고 효율이 나오기 어렵습니다. 원가 절감 또는 판매가 인상을 검토하세요.`
                    });
                } else {
                    advices.push({
                        type: 'danger',
                        text: `<strong>${campaign.name}</strong>: ROAS를 ${requiredImprovement.toFixed(0)}%p 이상 개선해야 수익이 발생합니다. 키워드 최적화나 소재 변경을 검토하세요.`
                    });
                }
            });

            // 손익분기 캠페인 조언
            breakevenCampaigns.forEach(campaign => {
                advices.push({
                    type: 'warning',
                    text: `<strong>${campaign.name}</strong>: 손익분기점 근처입니다. 소폭의 ROAS 개선으로 수익 전환이 가능합니다.`
                });
            });

            // 마진율 관련 조언
            const lowMarginCampaigns = validResults.filter(r => r.marginRate < 30 && r.marginRate > 0);
            if (lowMarginCampaigns.length > 0 && advices.length < 5) {
                advices.push({
                    type: 'warning',
                    text: `마진율 30% 미만 캠페인이 ${lowMarginCampaigns.length}개 있습니다. 낮은 마진율은 광고 효율을 떨어뜨립니다.`
                });
            }

            // HTML 생성
            adviceDiv.innerHTML = `
                <h4><img src="/static/img/icons/robot.svg" alt="" style="width:18px;height:18px;vertical-align:middle;"> AI 최적화 조언</h4>
                ${advices.map(a => `
                    <div class="advice-item advice-${a.type}">
                        ${a.text}
                    </div>
                `).join('')}
                ${advices.length === 0 ? '<p>모든 캠페인이 양호한 상태입니다!</p>' : ''}
            `;
        }

        // ========================================
        // Storage
        // ========================================
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                campaigns: campaigns,
                rowCounter: rowCounter
            }));
        }

        function loadFromStorage() {
            try {
                const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
                if (data && data.campaigns) {
                    campaigns = data.campaigns;
                    rowCounter = data.rowCounter || campaigns.length;
                    renderInputTable();
                }
            } catch (e) {
                console.error('Failed to load from storage:', e);
            }
        }

        // ========================================
        // Excel Export
        // ========================================
        function exportExcel() {
            const results = campaigns.map(c => calculateEfficiency(c));

            const exportData = campaigns.map((c, idx) => {
                const r = results[idx];
                let statusText = '수익';
                if (r.status === 'loss') statusText = '손실';
                else if (r.status === 'breakeven') statusText = '손익분기';

                return {
                    '번호': idx + 1,
                    '캠페인명': c.campaignName,
                    '상품명': c.productName,
                    '광고비': c.adCost,
                    '광고매출': c.adSales,
                    '판매가': c.salePrice,
                    '원가': c.productCost,
                    '실제ROAS(%)': r.actualRoas.toFixed(2),
                    '손익분기ROAS(%)': r.breakevenRoas.toFixed(2),
                    'ROAS차이(%p)': r.roasDiff.toFixed(2),
                    '마진율(%)': r.marginRate.toFixed(2),
                    '예상수익': Math.round(r.estimatedProfit),
                    '판정': statusText
                };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '광고효율진단');

            const today = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `광고효율진단_${today}.xlsx`);
        }
    </script>

    <!-- 배너 로더 스크립트 -->
    <script src="/static/js/banner-loader.js"></script>
</body>
</html>
